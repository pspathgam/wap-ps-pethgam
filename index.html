<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winter Assignment Portal Zone Wagoora (v9 - Approval & Trophies)</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, collection, query, onSnapshot, 
            addDoc, serverTimestamp, getDocs, where, orderBy, deleteDoc, updateDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref as dbRef, update as dbUpdate, onValue as dbOnValue, set as dbSet } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Set log level to debug for thorough debugging
        setLogLevel('debug');

        // Global Firebase variables provided by the environment
        const firebaseConfig = {
            apiKey: "AIzaSyCBLLmzxVYuivT15HBPPSxMoS2OzojRgJM",
            authDomain: "wap-ps-pethgam.firebaseapp.com",
            databaseURL: "https://wap-ps-pethgam-default-rtdb.firebaseio.com",
            projectId: "wap-ps-pethgam",
            storageBucket: "wap-ps-pethgam.firebasestorage.app",
            messagingSenderId: "430925411362",
            appId: "1:430925411362:web:22857dee585d02fc54467b"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // --- GLOBAL STATE & FIREBASE PATHS ---
        let userId = null;
        let username = null;
        let role = null;
        let isAuthReady = false;
        let rtdbWatchId = null;
        let allUsers = {}; // Cache for all users loaded from Firestore for login validation

        // Retrieve app ID and define collection paths based on environment rules
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // MANDATORY PUBLIC PATH STRUCTURE: /artifacts/{appId}/public/data/{collectionName}
        const USER_COLLECTION_PATH = `artifacts/${appId}/public/data/users`;
        const ASSIGNMENTS_COLLECTION_PATH = `artifacts/${appId}/public/data/assignments`;
        const LEADERBOARD_COLLECTION_PATH = `artifacts/${appId}/public/data/leaderboard`;

        const USER_COLLECTION = collection(db, USER_COLLECTION_PATH);

        // --- CONSTANTS ---
        const AVAILABLE_CLASSES = ["1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th"];
        const AVAILABLE_SUBJECTS = ["Math", "English", "EVS", "Urdu", "Kashmiri", "SST"];
        const AVAILABLE_SCHOOLS = ["PS Pethgam Wagoora", "MS Wagoora", "HS Wagoora", "Other School"];
        const TROPHY_THRESHOLDS = {
            GOLD: 6000,
            SILVER: 4000,
            BRONZE: 2000
        };
        
        // Initial Admin is hardcoded for first login. Status is implicitly 'Approved'
        const INITIAL_ADMIN = { 
            "Admin_Pethgam": { role: "Admin", pin: "0000", school: "PS Pethgam Wagoora", status: "Approved" } 
        };

        // --- UI ELEMENTS ---
        const errorEl = document.getElementById('error-message');
        const loginFormEl = document.getElementById('login-form');
        const loginContainerEl = document.getElementById('login-container');
        const userSignupFormEl = document.getElementById('user-signup-form');
        const userSignupContainerEl = document.getElementById('user-signup-container');
        const assignmentContainerEl = document.getElementById('assignment-portal-container');
        const welcomeMessageEl = document.getElementById('welcome-message');
        const teacherViewEl = document.getElementById('teacher-view'); 
        const studentViewEl = document.getElementById('student-view');
        const adminViewEl = document.getElementById('admin-view');
        const userListTableBodyEl = document.getElementById('user-list-table-body');
        const assignmentFormEl = document.getElementById('assignment-form');
        const assignmentListEl = document.getElementById('assignment-list');
        const leaderboardTableBodyEl = document.getElementById('leaderboard-table-body');
        const notificationMarqueeEl = document.getElementById('notification-marquee');
        
        // Geolocation elements
        const locationControlsEl = document.getElementById('location-controls');
        const signupClassFieldEl = document.getElementById('signup-class-field');


        // --- FIREBASE AUTHENTICATION & INITIALIZATION ---

        async function initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) userId = user.uid;
                else userId = null;
                isAuthReady = true;
                checkSession();
            });
            await signInAnonymously(auth);
        }

        // --- USER LOADING (For Login Validation & Admin Management) ---

        async function loadAllUsers() {
            const snapshot = await getDocs(USER_COLLECTION);
            allUsers = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                allUsers[data.username] = { ...data, id: doc.id };
            });
            console.log("User cache loaded/refreshed:", Object.keys(allUsers).length, "users.");
            return allUsers;
        }

        // --- USER SIGNUP (Unified for Teacher/Student) ---

        function showSignup() {
            loginContainerEl.classList.add('hidden');
            userSignupContainerEl.classList.remove('hidden');
            
            // Populate Class/School dropdowns
            document.getElementById('user-signup-role').value = ''; // Reset role
            document.getElementById('user-signup-class').innerHTML = AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('user-signup-school').innerHTML = AVAILABLE_SCHOOLS.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('signup-error-message').textContent = '';
            signupClassFieldEl.classList.add('hidden'); // Hide class initially
        }

        function showLogin() {
            loginContainerEl.classList.remove('hidden');
            userSignupContainerEl.classList.add('hidden');
            document.getElementById('signup-error-message').textContent = '';
        }

        async function handleUserSignup(event) {
            event.preventDefault();
            
            const signupRole = document.getElementById('user-signup-role').value;
            // Trim whitespace from user inputs (CRITICAL: prevents silent data mismatch)
            const signupUsername = document.getElementById('user-signup-username').value.trim();
            const signupPin = document.getElementById('user-signup-pin').value.trim();
            const signupClass = document.getElementById('user-signup-class').value;
            const signupSchool = document.getElementById('user-signup-school').value;
            const signupErrorEl = document.getElementById('signup-error-message');

            if (!signupRole || !signupUsername || !signupPin || !signupSchool || (signupRole === 'Student' && !signupClass)) {
                signupErrorEl.textContent = 'Please fill all required fields.';
                return;
            }
            if (signupRole === 'Student' && !AVAILABLE_CLASSES.includes(signupClass)) {
                signupErrorEl.textContent = 'Invalid class selection for Student role.';
                return;
            }
            // Check if username already exists in the latest cache
            if (allUsers[signupUsername] || INITIAL_ADMIN[signupUsername]) {
                signupErrorEl.textContent = 'Error: Username already exists!';
                return;
            }
            
            try {
                // All new signups are set to 'Pending'
                await addDoc(USER_COLLECTION, {
                    username: signupUsername,
                    role: signupRole,
                    pin: signupPin,
                    class: (signupRole === 'Student') ? signupClass : null,
                    school: signupSchool,
                    status: 'Pending', // NEW: Requires Admin Approval
                    createdAt: serverTimestamp()
                });
                
                signupErrorEl.textContent = `Signup successful! Your account is pending Admin approval. You may now attempt to log in.`;
                userSignupFormEl.reset();
                // Ensure cache is updated immediately after successful creation
                await loadAllUsers(); 
                // Don't auto-redirect, let them try login and see the pending message
                // setTimeout(showLogin, 3000);

            } catch (e) {
                console.error("Signup error:", e);
                signupErrorEl.textContent = `Signup error: ${e.message}`;
            }
        }
        
        // --- LOGIN/SESSION LOGIC (IMPROVED PIN/STATUS HANDLING) ---
        
        function handleLogout(suppressMessage = false) {
            stopSharing();
            sessionStorage.clear();
            
            loginContainerEl.classList.remove('hidden');
            assignmentContainerEl.classList.add('hidden');
            userSignupContainerEl.classList.add('hidden'); 
            
            // Clear role-specific views
            teacherViewEl.classList.add('hidden');
            studentViewEl.classList.add('hidden');
            adminViewEl.classList.add('hidden');

            if (!suppressMessage) {
                 errorEl.textContent = 'Logged out successfully.';
            } else {
                 errorEl.textContent = '';
            }
            
            signOut(auth).catch(err => console.error("Firebase logout error:", err));
        }


        async function handleLogin(event) {
            event.preventDefault();
            
            // 1. Get Inputs and TRIM whitespace (CRITICAL)
            const selectedRole = document.getElementById('role-select').value;
            const inputUsername = document.getElementById('username-input').value.trim();
            const inputPin = document.getElementById('pin-input').value.trim(); // Trimmed input pin
            
            errorEl.textContent = '';
            
            if (!inputUsername || !inputPin || !selectedRole) {
                errorEl.textContent = 'Please fill in all login fields.';
                return;
            }

            // 2. Refresh User Cache (CRITICAL)
            await loadAllUsers(); 
            
            let userData = null;
            let school = null;
            let userClass = null;
            
            // 3. Check hardcoded Admin first
            const initialUser = INITIAL_ADMIN[inputUsername];
            if (initialUser) {
                 userData = initialUser;
            } else {
                 // 4. Check users loaded from Firestore cache
                 userData = allUsers[inputUsername];
            }

            console.log("--- Attempting Login ---");
            console.log("Input: Username:", inputUsername, "Role:", selectedRole, "PIN:", inputPin);

            if (userData) {
                console.log("Stored Data:", userData);

                // A. Validate PIN
                if (userData.pin === inputPin) {
                    
                    // B. Validate ROLE
                    if (userData.role === selectedRole) {
                        
                        // C. Validate STATUS (NEW: Admin Approval Check)
                        if (userData.status === 'Approved') {
                             school = userData.school;
                             userClass = userData.class;
                        
                             // Set global state and session storage
                             username = inputUsername;
                             role = selectedRole; 
                        
                             await finalizeLogin(username, role, userClass, school);
                             return;
                        } else {
                             // Status is not Approved (must be 'Pending')
                             errorEl.textContent = 'Login Failed: Your account is awaiting Admin approval.';
                             console.error("Login Failed: Account status is", userData.status);
                             return;
                        }
                    } else {
                        // Role mismatch error
                        errorEl.textContent = `Login Failed: Invalid Role. Please ensure you selected the correct role for this username.`;
                        console.error("Login Failed: Role mismatch. Stored:", userData.role, "Selected:", selectedRole);
                    }
                } else {
                    // PIN mismatch error
                    errorEl.textContent = 'Login Failed: Invalid PIN.';
                    console.error("Login Failed: PIN mismatch. Stored PIN:", userData.pin, "Input PIN:", inputPin);
                }
            } else {
                // User not found error
                errorEl.textContent = 'Login Failed: Invalid Username or Role combination.';
                console.error("Login Failed: Username not found in cache or admin list.");
            }
        }
        
        async function finalizeLogin(user, userRole, userClass, userSchool) {
            sessionStorage.setItem('portal_logged_in', 'true');
            sessionStorage.setItem('portal_username', user);
            sessionStorage.setItem('portal_role', userRole);
            sessionStorage.setItem('portal_class', userClass || '');
            sessionStorage.setItem('portal_school', userSchool || '');
            
            username = user;
            role = userRole;
            
            transitionToAssignmentPortal(user, userRole);
        }

        async function checkSession() {
<script type="module">
/*
  Fixed Firebase + Auth + DOM timing script for Winter Assignment Portal (v11 - Auth Fix)
  - All DOM access happens after DOMContentLoaded
  - setLogLevel imported from firebase-app
  - Robust anonymous sign-in with try/catch
  - Loads user cache after auth is ready
*/

import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
    getFirestore, doc, setDoc, collection, query, onSnapshot, 
    addDoc, serverTimestamp, getDocs, where, orderBy, deleteDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getDatabase, ref as dbRef, update as dbUpdate, onValue as dbOnValue, set as dbSet } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Set verbose logging for debugging (can be lowered in production)
setLogLevel('debug');

// Firebase config (unchanged)
const firebaseConfig = {
    apiKey: "AIzaSyCBLLmzxVYuivT15HBPPSxMoS2OzojRgJM",
    authDomain: "wap-ps-pethgam.firebaseapp.com",
    databaseURL: "https://wap-ps-pethgam-default-rtdb.firebaseio.com",
    projectId: "wap-ps-pethgam",
    storageBucket: "wap-ps-pethgam.firebasestorage.app",
    messagingSenderId: "430925411362",
    appId: "1:430925411362:web:22857dee585d02fc54467b"
};

// Initialize Firebase services
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rtdb = getDatabase(app);

// --- GLOBAL STATE ---
let userId = null;
let username = null;
let role = null;
let isAuthReady = false;
let rtdbWatchId = null;
let allUsers = {}; // Cache for users

// App ID & collection path (keeps your original structure)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const USER_COLLECTION_PATH = `artifacts/${appId}/public/data/users`;
const ASSIGNMENTS_COLLECTION_PATH = `artifacts/${appId}/public/data/assignments`;
const LEADERBOARD_COLLECTION_PATH = `artifacts/${appId}/public/data/leaderboard`;

const USER_COLLECTION = collection(db, USER_COLLECTION_PATH);

// --- CONSTANTS ---
const AVAILABLE_CLASSES = ["1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th"];
const AVAILABLE_SUBJECTS = ["Math", "English", "EVS", "Urdu", "Kashmiri", "SST"];
const AVAILABLE_SCHOOLS = ["PS Pethgam Wagoora", "MS Wagoora", "HS Wagoora", "Other School"];
const TROPHY_THRESHOLDS = { GOLD: 6000, SILVER: 4000, BRONZE: 2000 };

// Initial admin (keys are lowercase for case-insensitive checks)
const INITIAL_ADMIN = { 
    "admin_pethgam": { role: "Admin", pin: "0000", school: "PS Pethgam Wagoora", status: "Approved", username: "Admin_Pethgam" } 
};

// We'll query DOM elements after DOMContentLoaded
let errorEl, loginFormEl, loginContainerEl, userSignupFormEl, userSignupContainerEl;
let assignmentContainerEl, welcomeMessageEl, teacherViewEl, studentViewEl, adminViewEl;
let userListTableBodyEl, assignmentFormEl, assignmentListEl, leaderboardTableBodyEl, notificationMarqueeEl;
let locationControlsEl, signupClassFieldEl;

// --- HELPERS & FIREBASE INTERACTIONS ---

async function initAuth() {
    // onAuthStateChanged will set userId and then we can call checkSession
    return new Promise((resolve) => {
        const unsub = onAuthStateChanged(auth, (user) => {
            if (user) userId = user.uid;
            else userId = null;
            isAuthReady = true;
            // resolve once we've seen an auth state change at least once
            resolve();
        });
    });
}

async function ensureAnonymousSignIn() {
    try {
        // Only sign in if there's no current user
        if (!auth.currentUser) {
            await signInAnonymously(auth);
            console.log("Signed in anonymously to Firebase Auth.");
        } else {
            console.log("Already authenticated (existing user).");
        }
    } catch (err) {
        console.error("Anonymous sign-in failed:", err);
        // Keep app usable offline/limited â€” but show error in UI if available
        if (errorEl) errorEl.textContent = "Error connecting to backend. Some features may not work.";
    }
}

async function loadAllUsers() {
    try {
        const snapshot = await getDocs(USER_COLLECTION);
        allUsers = {};
        snapshot.forEach(d => {
            const data = d.data();
            if (data && data.username) {
                // store with lowercase key for case-insensitive lookup
                allUsers[String(data.username).toLowerCase()] = { ...data, id: d.id };
            }
        });
        console.log("User cache loaded/refreshed:", Object.keys(allUsers).length, "users.");
        return allUsers;
    } catch (e) {
        console.error("Failed to load users from Firestore:", e);
        // fallback: keep existing cache (if any) and return it
        return allUsers || {};
    }
}

// --- UI Functions (operate after DOM ready) ---

function showSignup() {
    loginContainerEl.classList.add('hidden');
    userSignupContainerEl.classList.remove('hidden');

    // Reset and populate fields
    document.getElementById('user-signup-role').value = '';
    document.getElementById('user-signup-class').innerHTML =
        '<option value="">-- Select Class --</option>' +
        AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('user-signup-school').innerHTML =
        AVAILABLE_SCHOOLS.map(s => `<option value="${s}">${s}</option>`).join('');
    document.getElementById('signup-error-message').textContent = '';
    signupClassFieldEl.classList.add('hidden');
}

function showLogin() {
    loginContainerEl.classList.remove('hidden');
    userSignupContainerEl.classList.add('hidden');
    document.getElementById('signup-error-message').textContent = '';
}

async function handleUserSignup(event) {
    event.preventDefault();
    const signupRole = document.getElementById('user-signup-role').value;
    const rawUsername = document.getElementById('user-signup-username').value.trim();
    const signupUsername = rawUsername.toLowerCase();
    const signupPin = document.getElementById('user-signup-pin').value.trim();
    const signupClass = document.getElementById('user-signup-class').value;
    const signupSchool = document.getElementById('user-signup-school').value;
    const signupErrorEl = document.getElementById('signup-error-message');

    if (!signupRole || !rawUsername || !signupPin || !signupSchool || (signupRole === 'Student' && !signupClass)) {
        signupErrorEl.textContent = 'Please fill all required fields.';
        return;
    }

    // Re-check cache before writing
    await loadAllUsers();

    if (allUsers[signupUsername] || INITIAL_ADMIN[signupUsername]) {
        signupErrorEl.textContent = 'Error: Username already exists! Please choose another one.';
        return;
    }

    try {
        await addDoc(USER_COLLECTION, {
            username: rawUsername,
            role: signupRole,
            pin: signupPin,
            class: (signupRole === 'Student') ? signupClass : null,
            school: signupSchool,
            status: 'Pending',
            createdAt: serverTimestamp()
        });

        signupErrorEl.textContent = `Signup successful for ${rawUsername}! Your account is pending Admin approval.`;
        userSignupFormEl.reset();
        await loadAllUsers(); // refresh cache
    } catch (e) {
        console.error("Signup error:", e);
        signupErrorEl.textContent = `Signup error: ${e.message || String(e)}`;
    }
}

function handleLogout(suppressMessage = false) {
    // stopSharing(); // if you have a sharing function, ensure it's defined elsewhere
    sessionStorage.clear();

    loginContainerEl.classList.remove('hidden');
    assignmentContainerEl.classList.add('hidden');
    userSignupContainerEl.classList.add('hidden');

    teacherViewEl.classList.add('hidden');
    studentViewEl.classList.add('hidden');
    adminViewEl.classList.add('hidden');

    if (!suppressMessage) errorEl.textContent = 'Logged out successfully.';
    else errorEl.textContent = '';

    signOut(auth).catch(err => console.error("Firebase logout error:", err));
}

async function handleLogin(event) {
    event.preventDefault();

    const selectedRole = document.getElementById('role-select').value;
    const inputRawUsername = document.getElementById('username-input').value.trim();
    const inputUsername = inputRawUsername.toLowerCase();
    const inputPin = document.getElementById('pin-input').value.trim();

    errorEl.textContent = '';

    if (!inputUsername || !inputPin || !selectedRole) {
        errorEl.textContent = 'Please fill in all login fields.';
        return;
    }

    // Refresh user cache
    await loadAllUsers();

    let userData = null;
    let school = null;
    let userClass = null;

    // Check hardcoded admin first
    const initialUser = INITIAL_ADMIN[inputUsername];
    if (initialUser) {
        userData = initialUser;
    } else {
        userData = allUsers[inputUsername];
    }

    console.log("--- Attempting Login ---", { inputUsername, selectedRole });

    if (!userData) {
        errorEl.textContent = 'Login Failed: Invalid Username or Role combination.';
        console.error("Login Failed: Username not found for key:", inputUsername);
        return;
    }

    // Validate PIN
    if (String(userData.pin) !== inputPin) {
        errorEl.textContent = 'Login Failed: Invalid PIN.';
        console.error("Login Failed: PIN mismatch.");
        return;
    }

    // Validate role
    if (String(userData.role) !== selectedRole) {
        errorEl.textContent = 'Login Failed: Invalid Role. Please select the correct role.';
        console.error("Login Failed: Role mismatch. Stored:", userData.role, "Selected:", selectedRole);
        return;
    }

    // Validate status
    if (String(userData.status) !== 'Approved') {
        errorEl.textContent = 'Login Failed: Your account is awaiting Admin approval.';
        console.error("Login Failed: Account status is", userData.status);
        return;
    }

    // Success: finalize login using stored username (original case)
    const displayName = userData.username || inputRawUsername;
    userClass = userData.class;
    school = userData.school;
    await finalizeLogin(displayName, selectedRole, userClass, school);
}

async function finalizeLogin(user, userRole, userClass, userSchool) {
    sessionStorage.setItem('portal_logged_in', 'true');
    sessionStorage.setItem('portal_username', user);
    sessionStorage.setItem('portal_role', userRole);
    sessionStorage.setItem('portal_class', userClass || '');
    sessionStorage.setItem('portal_school', userSchool || '');

    username = user;
    role = userRole;

    transitionToAssignmentPortal(user, userRole);
}

async function checkSession() {
    if (!isAuthReady) return;
    await loadAllUsers();

    const loggedIn = sessionStorage.getItem('portal_logged_in') === 'true';
    if (loggedIn) {
        username = sessionStorage.getItem('portal_username');
        role = sessionStorage.getItem('portal_role');
        transitionToAssignmentPortal(username, role);
    } else {
        loginContainerEl.classList.remove('hidden');
        assignmentContainerEl.classList.add('hidden');
        userSignupContainerEl.classList.add('hidden');
    }
}

function transitionToAssignmentPortal(user, userRole) {
    loginContainerEl.classList.add('hidden');
    userSignupContainerEl.classList.add('hidden');
    assignmentContainerEl.classList.remove('hidden');

    welcomeMessageEl.textContent = `Welcome, ${user} (${userRole} from ${sessionStorage.getItem('portal_school')})!`;

    const isAdmin = (userRole === 'Admin');
    const isTeacher = (userRole === 'Teacher');
    const isStudent = (userRole === 'Student');

    teacherViewEl.classList.toggle('hidden', !(isTeacher || isAdmin));
    studentViewEl.classList.toggle('hidden', !isStudent);
    adminViewEl.classList.toggle('hidden', !isAdmin);

    const navUserMgmt = document.getElementById('nav-user-management');
    const navLocation = document.getElementById('nav-location');
    if (navUserMgmt) navUserMgmt.classList.toggle('hidden', !isAdmin);
    if (navLocation) navLocation.classList.toggle('hidden', !isAdmin);

    locationControlsEl.classList.toggle('hidden', !isAdmin);

    // Populate selects for teacher/admin
    if (isTeacher || isAdmin) {
        const classSelect = document.getElementById('assignment-class-select');
        const subjectSelect = document.getElementById('assignment-subject-select');
        if (classSelect) classSelect.innerHTML = AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
        if (subjectSelect) subjectSelect.innerHTML = AVAILABLE_SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('');

        if (isAdmin) {
            const newUserClass = document.getElementById('new-user-class');
            const newUserSchool = document.getElementById('new-user-school');
            if (newUserClass) newUserClass.innerHTML =
                '<option value="">-- Select Class --</option>' + AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
            if (newUserSchool) newUserSchool.innerHTML = AVAILABLE_SCHOOLS.map(s => `<option value="${s}">${s}</option>`).join('');
        }
    }

    if (isAdmin) {
        showView('user-management');
        setupUserListListener();
    } else {
        showView('assignments');
    }

    setupAssignmentListeners();
    setupDataListener();
    setupNotificationListener();
}

// --- PLACEHOLDER/NO-OPS for functions referenced but not included in this snippet ---
// If you already have implementations elsewhere in your file, keep them.
// Otherwise, these placeholders prevent runtime errors when calling them.
function showView(viewName) {
    // Implement or keep your existing implementation. Minimal safe switch:
    const views = document.querySelectorAll('[data-view]');
    views.forEach(v => v.classList.add('hidden'));
    const el = document.querySelector(`[data-view="${viewName}"]`);
    if (el) el.classList.remove('hidden');
}
function setupUserListListener(){ /* implement or keep your existing function */ }
function setupAssignmentListeners(){ /* implement or keep your existing function */ }
function setupDataListener(){ /* implement or keep your existing function */ }
function setupNotificationListener(){ /* implement or keep your existing function */ }

// --- BOOTSTRAP: run after DOM is ready ---
document.addEventListener('DOMContentLoaded', async () => {
    // Cache DOM nodes
    errorEl = document.getElementById('error-message');
    loginFormEl = document.getElementById('login-form');
    loginContainerEl = document.getElementById('login-container');
    userSignupFormEl = document.getElementById('user-signup-form');
    userSignupContainerEl = document.getElementById('user-signup-container');
    assignmentContainerEl = document.getElementById('assignment-portal-container');
    welcomeMessageEl = document.getElementById('welcome-message');
    teacherViewEl = document.getElementById('teacher-view');
    studentViewEl = document.getElementById('student-view');
    adminViewEl = document.getElementById('admin-view');
    userListTableBodyEl = document.getElementById('user-list-table-body');
    assignmentFormEl = document.getElementById('assignment-form');
    assignmentListEl = document.getElementById('assignment-list');
    leaderboardTableBodyEl = document.getElementById('leaderboard-table-body');
    notificationMarqueeEl = document.getElementById('notification-marquee');
    locationControlsEl = document.getElementById('location-controls');
    signupClassFieldEl = document.getElementById('signup-class-field');

    // Wire up form handlers safely (if elements exist)
    if (loginFormEl) loginFormEl.addEventListener('submit', handleLogin);
    const signupToggleBtn = document.getElementById('show-signup-btn');
    if (signupToggleBtn) signupToggleBtn.addEventListener('click', showSignup);
    const showLoginBtn = document.getElementById('show-login-btn');
    if (showLoginBtn) showLoginBtn.addEventListener('click', showLogin);
    if (userSignupFormEl) userSignupFormEl.addEventListener('submit', handleUserSignup);

    // Initialize auth and sign-in
    await initAuth();             // wait for onAuthStateChanged event at least once
    await ensureAnonymousSignIn(); // sign-in if necessary
    await checkSession();         // load user cache and set up UI according to session
});
        }
        
        // --- NOTIFICATION MANAGEMENT (RTDB) ---
        
        const NOTIFICATION_PATH = 'notifications/main_message';

        function setupNotificationListener() {
            const notificationRef = dbRef(rtdb, NOTIFICATION_PATH);

            dbOnValue(notificationRef, (snapshot) => {
                const message = snapshot.val() || 'Welcome to the Winter Assignment Portal Zone Wagoora. Stay tuned for important updates!';
                notificationMarqueeEl.textContent = message;
            }, (error) => {
                console.error("Error listening to notification:", error);
                notificationMarqueeEl.textContent = 'Error loading updates.';
            });
        }

        async function handleNotificationUpdate(event) {
            event.preventDefault();
            
            const newMessage = document.getElementById('notification-input').value.trim();
            const notificationErrorEl = document.getElementById('notification-error-message');

            if (!newMessage) {
                 notificationErrorEl.textContent = 'Notification message cannot be empty.';
                 return;
            }
            
            try {
                await dbSet(dbRef(rtdb, NOTIFICATION_PATH), newMessage);
                notificationErrorEl.textContent = 'Notification updated successfully!';
                setTimeout(() => notificationErrorEl.textContent = '', 3000);
            } catch (e) {
                 console.error("Error updating notification:", e);
                 notificationErrorEl.textContent = `Error: ${e.message}`;
            }
        }

        // --- USER MANAGEMENT (ADMIN ONLY - FIRESTORE) ---

        function setupUserListListener() {
            if (!isAuthReady) return;

            const usersQuery = query(USER_COLLECTION, orderBy('status'), orderBy('role'), orderBy('username'));
            
            onSnapshot(usersQuery, (snapshot) => {
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserList(users);
            }, (error) => {
                console.error("Error listening to users:", error);
            });
        }
        
        function renderUserList(users) {
             if (role !== 'Admin') return;
             
             userListTableBodyEl.innerHTML = users.map(user => {
                 const isPending = user.status === 'Pending';
                 const statusClass = isPending ? 'text-red-400 font-bold' : 'text-green-400';
                 
                 return `
                 <tr class="text-sm border-t border-gray-600">
                     <td class="p-3 font-semibold text-yellow-400">${user.username}</td>
                     <td class="p-3">${user.role}</td>
                     <td class="p-3 font-mono text-xs">${user.pin}</td> 
                     <td class="p-3">${user.class || '-'}</td>
                     <td class="p-3 ${statusClass}">${user.status || 'N/A'}</td>
                     <td class="p-3 text-right space-x-2">
                         ${isPending ? `
                             <button data-id="${user.id}" data-action="approve"
                                     onclick="handleUserAction(event)"
                                     class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                 Approve
                             </button>
                         ` : ''}
                         <button data-id="${user.id}" data-action="delete"
                                 data-username="${user.username}" 
                                 onclick="handleUserAction(event)"
                                 class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                             Delete
                         </button>
                     </td>
                 </tr>
             `}).join('');
        }

        window.handleUserAction = async function(event) {
             const userIdToUpdate = event.target.getAttribute('data-id');
             const action = event.target.getAttribute('data-action');
             const userName = event.target.getAttribute('data-username');
             const adminErrorEl = document.getElementById('admin-error-message');
             
             const userDocRef = doc(db, USER_COLLECTION_PATH, userIdToUpdate);

             try {
                 if (action === 'delete') {
                     // Using console error instead of confirm/alert to adhere to rules
                     console.error(`Deletion of user ${userName} requested.`);
                     await deleteDoc(userDocRef);
                     adminErrorEl.textContent = `User ${userName || 'User'} deleted successfully.`;
                 } else if (action === 'approve') {
                     await updateDoc(userDocRef, {
                         status: 'Approved'
                     });
                     adminErrorEl.textContent = `User approved successfully! They can now log in.`;
                 }
                 
                 // Refresh cache after modification
                 await loadAllUsers(); 
                 setTimeout(() => adminErrorEl.textContent = '', 3000);

             } catch (e) {
                 console.error(`Error performing action ${action} on user:`, e);
                 adminErrorEl.textContent = `Error during user action: ${e.message}`;
             }
        }
        
        async function handleUserAdd(event) {
            event.preventDefault();
            
            const newUserRole = document.getElementById('new-user-role').value;
            const newUsername = document.getElementById('new-user-username').value.trim();
            const newPin = document.getElementById('new-user-pin').value.trim(); 
            const newSchool = document.getElementById('new-user-school').value;
            const newClass = document.getElementById('new-user-class').value;
            const adminErrorEl = document.getElementById('admin-error-message');

            if (!newUserRole || !newUsername || !newPin || !newSchool || (newUserRole === 'Student' && !newClass)) {
                adminErrorEl.textContent = 'Please fill all required fields.';
                return;
            }

            if (allUsers[newUsername] || INITIAL_ADMIN[newUsername]) {
                adminErrorEl.textContent = 'Error: Username already exists!';
                return;
            }
            
            try {
                const userData = {
                    username: newUsername,
                    role: newUserRole, 
                    pin: newPin, 
                    school: newSchool,
                    class: (newUserRole === 'Student') ? newClass : null, 
                    status: 'Approved', // Admin added users are automatically approved
                    createdBy: username,
                    createdAt: serverTimestamp()
                };
                
                await addDoc(USER_COLLECTION, userData);
                
                adminErrorEl.textContent = `${newUserRole} ${newUsername} added and approved successfully!`;
                document.getElementById('user-add-form').reset();
                await loadAllUsers(); 

            } catch (e) {
                console.error("Admin user add error:", e);
                adminErrorEl.textContent = `Error adding user: ${e.message}`;
            }
        }
        
        // --- ASSIGNMENT MANAGEMENT ---

        async function handleAssignmentSubmit(event) {
            event.preventDefault();
            
            const selectedClass = document.getElementById('assignment-class-select').value;
            const selectedSubject = document.getElementById('assignment-subject-select').value;
            const question = document.getElementById('assignment-question').value.trim();
            
            const optionA = document.getElementById('assignment-option-a').value.trim();
            const optionB = document.getElementById('assignment-option-b').value.trim();
            const optionC = document.getElementById('assignment-option-c').value.trim();
            const optionD = document.getElementById('assignment-option-d').value.trim();
            
            const correctKey = document.getElementById('assignment-correct-key').value; 
            
            if (!selectedClass || !selectedSubject || !question || !optionA || !optionB || !optionC || !optionD || !correctKey) {
                errorEl.textContent = 'Please fill all fields (Class, Subject, Question, and all 4 Options).';
                return;
            }

            try {
                const assignmentData = {
                    class: selectedClass,
                    subject: selectedSubject,
                    question: question,
                    options: {
                        A: optionA,
                        B: optionB,
                        C: optionC,
                        D: optionD
                    },
                    correctKey: correctKey, 
                    createdBy: username,
                    school: sessionStorage.getItem('portal_school'),
                    timestamp: serverTimestamp(),
                    status: 'Active'
                };
                
                const assignmentsCollectionRef = collection(db, ASSIGNMENTS_COLLECTION_PATH);
                await addDoc(assignmentsCollectionRef, assignmentData);
                
                errorEl.textContent = 'Assignment published successfully!';
                assignmentFormEl.reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                errorEl.textContent = `Error adding assignment: ${e.message}`;
            }
        }

        function setupAssignmentListeners() {
            if (!isAuthReady) return;

            // 1. Listen for all assignments
            const assignmentsCollectionRef = collection(db, ASSIGNMENTS_COLLECTION_PATH);
            const assignmentsQuery = query(assignmentsCollectionRef, orderBy('timestamp', 'desc'));
            
            onSnapshot(assignmentsQuery, (snapshot) => {
                const assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssignments(assignments);
            }, (error) => {
                console.error("Error listening to assignments:", error);
            });
            
            // 2. Listen for leaderboard data
            const leaderboardCollectionRef = collection(db, LEADERBOARD_COLLECTION_PATH);
            const leaderboardQuery = query(leaderboardCollectionRef); // No orderBy to allow sorting in memory
            
            onSnapshot(leaderboardQuery, (snapshot) => {
                const scores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLeaderboard(scores);
            }, (error) => {
                console.error("Error listening to leaderboard:", error);
            });
        }
        
        function renderAssignments(assignments) {
            if (role !== 'Student') return;

            const studentClass = sessionStorage.getItem('portal_class');
            
            const filteredAssignments = assignments.filter(a => a.class === studentClass);

            if (filteredAssignments.length === 0) {
                assignmentListEl.innerHTML = '<p class="text-center text-gray-400">No assignments available for your class.</p>';
                return;
            }

            assignmentListEl.innerHTML = filteredAssignments.map(a => {
                const submissionStatus = sessionStorage.getItem(`submitted_${a.id}`) || 'pending';
                const isDisabled = submissionStatus === 'submitted' ? 'disabled' : '';
                const options = a.options || {}; 

                return `
                    <div id="assignment-${a.id}" class="card p-4 mb-3 border-l-4 border-yellow-500">
                        <p class="font-bold text-lg text-yellow-400">${a.class} / ${a.subject} (${a.school})</p>
                        <p class="text-gray-300 mb-4 font-medium">${a.question}</p>
                        
                        <!-- Multiple Choice Options -->
                        <fieldset id="options-group-${a.id}" class="space-y-2 mb-4">
                            ${['A', 'B', 'C', 'D'].map(key => `
                                <div class="flex items-center option-item ${isDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-700/50 cursor-pointer'} p-2 rounded transition">
                                    <input type="radio" 
                                           id="option-${a.id}-${key}" 
                                           name="answer-${a.id}" 
                                           value="${key}" 
                                           class="form-radio h-5 w-5 text-teal-500 bg-gray-600 border-gray-500 focus:ring-teal-500" 
                                           ${isDisabled}>
                                    <label for="option-${a.id}-${key}" class="ml-3 text-gray-300 flex-1">
                                        <span class="font-bold mr-2 text-teal-300">${key}.</span> ${options[key] || 'No Option Provided'}
                                    </label>
                                </div>
                            `).join('')}
                        </fieldset>

                        <button data-id="${a.id}" data-correct="${a.correctKey}" 
                                class="submit-assignment-btn w-full bg-teal-500 text-white py-2 rounded hover:bg-teal-600 transition ${isDisabled ? 'bg-gray-500 hover:bg-gray-500 cursor-not-allowed' : ''}" 
                                ${isDisabled}>
                            Submit Answer
                        </button>
                        <p id="feedback-${a.id}" class="mt-2 text-sm font-semibold text-center"></p>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.submit-assignment-btn').forEach(button => {
                button.addEventListener('click', handleStudentSubmission);
            });
        }
        
        async function handleStudentSubmission(event) {
            const assignmentId = event.target.getAttribute('data-id');
            const correctKey = event.target.getAttribute('data-correct'); 
            
            const selectedOptionEl = document.querySelector(`input[name="answer-${assignmentId}"]:checked`);
            const feedbackEl = document.getElementById(`feedback-${assignmentId}`);
            const optionsGroupEl = document.getElementById(`options-group-${assignmentId}`);

            if (!selectedOptionEl) {
                feedbackEl.textContent = 'Please select an answer option.';
                feedbackEl.className = 'mt-2 text-sm font-semibold text-yellow-400';
                return;
            }

            const studentKey = selectedOptionEl.value;
            const isCorrect = studentKey === correctKey;
            const score = isCorrect ? 10 : 0;
            
            const feedback = isCorrect 
                ? 'Wow! You are doing Wonderful.' 
                : 'No problem, Try next time.';
            const feedbackClass = isCorrect ? 'text-green-500' : 'text-red-500';

            feedbackEl.textContent = feedback;
            feedbackEl.className = `mt-2 text-sm font-semibold ${feedbackClass}`;
            
            // Disable all controls
            document.querySelectorAll(`input[name="answer-${assignmentId}"]`).forEach(input => input.disabled = true);
            event.target.disabled = true;
            event.target.classList.replace('bg-teal-500', 'bg-gray-500');
            optionsGroupEl.classList.add('opacity-50');
            
            sessionStorage.setItem(`submitted_${assignmentId}`, 'submitted');

            try {
                const leaderboardCollectionRef = collection(db, LEADERBOARD_COLLECTION_PATH);
                const existingSubmissionsQuery = query(
                    leaderboardCollectionRef, 
                    where('assignmentId', '==', assignmentId), 
                    where('studentId', '==', userId)
                );
                const existingSnapshot = await getDocs(existingSubmissionsQuery);
                
                if (existingSnapshot.empty) {
                     await addDoc(leaderboardCollectionRef, {
                        assignmentId: assignmentId,
                        studentId: userId, // Use UID for unique tracking
                        username: username,
                        class: sessionStorage.getItem('portal_class'),
                        school: sessionStorage.getItem('portal_school'),
                        score: score,
                        isCorrect: isCorrect,
                        timestamp: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Error saving leaderboard score: ", e);
            }
        }
        
        function getTrophy(score) {
            if (score >= TROPHY_THRESHOLDS.GOLD) return 'ðŸ¥‡ Gold';
            if (score >= TROPHY_THRESHOLDS.SILVER) return 'ðŸ¥ˆ Silver';
            if (score >= TROPHY_THRESHOLDS.BRONZE) return 'ðŸ¥‰ Bronze';
            return 'â€”';
        }

        function renderLeaderboard(scores) {
            // Aggregate scores by student (sum all scores)
            const aggregatedScores = {};

            scores.forEach(s => {
                const key = s.username + '_' + s.school; // Combine username and school for unique key
                if (!aggregatedScores[key]) {
                    aggregatedScores[key] = { 
                        username: s.username, 
                        school: s.school, 
                        totalScore: 0, 
                        assignments: 0 
                    };
                }
                // Ensure score is a number before adding (important for firestore data)
                aggregatedScores[key].totalScore += (typeof s.score === 'number' ? s.score : parseInt(s.score) || 0);
                aggregatedScores[key].assignments += 1;
            });
            
            // Convert to array and sort by totalScore (descending)
            const sortedLeaderboard = Object.values(aggregatedScores).sort((a, b) => b.totalScore - a.totalScore);

            
            leaderboardTableBodyEl.innerHTML = sortedLeaderboard.map((student, index) => {
                const isCurrentUser = student.username === username;
                const rowClass = isCurrentUser ? 'bg-yellow-900/50' : '';
                const trophy = getTrophy(student.totalScore);

                return `
                    <tr class="text-sm border-t border-gray-600 ${rowClass}">
                        <td class="p-3">${index + 1}</td>
                        <td class="p-3 font-semibold ${isCurrentUser ? 'text-yellow-300' : 'text-yellow-400'}">${student.username}</td>
                        <td class="p-3 text-gray-400">${student.school}</td>
                        <td class="p-3 text-right">${student.totalScore}</td>
                        <td class="p-3 text-center">${trophy}</td>
                        <td class="p-3 text-right">${student.assignments}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // --- GEOLOCATION LOGIC (ADMIN ONLY - Kept for continuity) ---
        
        const rtdbPath = 'pethgam_wagoora_location';

        function success(pos) {
            const crd = pos.coords;
            const timestamp = new Date().toLocaleString();

            const currentDeviceId = userId || 'anonymous-device'; 
            const locationData = {
                latitude: crd.latitude,
                longitude: crd.longitude,
                accuracy: crd.accuracy,
                timestamp: timestamp,
                deviceId: currentDeviceId,
                username: username || 'Anonymous' 
            };

            document.getElementById('location-display').innerHTML = `
                <div class="text-xs font-semibold text-gray-500 mb-1">CURRENT DEVICE LOCATION</div>
                <p><strong>Latitude:</strong> ${crd.latitude.toFixed(6)}</p>
                <p><strong>Longitude:</strong> ${crd.longitude.toFixed(6)}</p>
                <p><strong>Accuracy:</strong> ${crd.accuracy.toFixed(2)} meters</p>
                <p><strong>Last Updated:</strong> ${timestamp}</p>
            `;

            errorEl.textContent = '';
            
            const deviceRef = dbRef(rtdb, rtdbPath + '/Admin_Pethgam');
            dbUpdate(deviceRef, locationData)
                .then(() => {
                    document.getElementById('portal-status').textContent = 'Location Sharing ACTIVE.';
                    document.getElementById('portal-status').className = 'text-green-400 font-bold';
                })
                .catch((error) => {
                    console.error("Error saving location:", error);
                    errorEl.textContent = 'Error saving location data to Firebase.';
                });
        }

        function error(err) {
            errorEl.textContent = `Geolocation Error: ${err.message}.`;
            document.getElementById('portal-status').textContent = 'Location Sharing INACTIVE: Permission Denied.';
            document.getElementById('portal-status').className = 'text-red-500 font-bold';
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        };
        
        function startSharing() {
            if (role !== 'Admin') {
                errorEl.textContent = 'Only Admin can start location sharing.';
                return;
            }
            if (!userId) {
                errorEl.textContent = 'Please log in before starting location sharing.';
                return;
            }

            if ("geolocation" in navigator) {
                if (rtdbWatchId) {
                    navigator.geolocation.clearWatch(rtdbWatchId);
                }
                
                document.getElementById('portal-status').textContent = 'Attempting to get location...';
                document.getElementById('portal-status').className = 'text-yellow-400 font-bold';
                rtdbWatchId = navigator.geolocation.watchPosition(success, error, options);
                
                document.getElementById('start-btn').classList.replace('bg-green-600', 'bg-gray-500');
                document.getElementById('stop-btn').classList.replace('bg-gray-500', 'bg-red-500');
                document.getElementById('start-btn').textContent = 'Sharing Active';

            } else {
                errorEl.textContent = 'Geolocation is not supported by this browser.';
            }
        }
        
        function stopSharing() {
            if (rtdbWatchId !== null) {
                navigator.geolocation.clearWatch(rtdbWatchId);
                rtdbWatchId = null;
                document.getElementById('portal-status').textContent = 'Location Sharing Stopped.';
                document.getElementById('portal-status').className = 'text-red-500 font-bold';
                
                document.getElementById('start-btn').classList.replace('bg-gray-500', 'bg-green-600');
                document.getElementById('stop-btn').classList.replace('bg-red-500', 'bg-gray-500');
                document.getElementById('start-btn').textContent = 'Start Sharing';
                
                document.getElementById('location-display').innerHTML = '<div class="text-gray-500">Location sharing stopped by Admin.</div>';
            }
        }

        function setupDataListener() {
            const adminLocationRef = dbRef(rtdb, rtdbPath + '/Admin_Pethgam');
            const remoteDisplayEl = document.getElementById('remote-location-display');
            const mapLinkEl = document.getElementById('map-link');

            dbOnValue(adminLocationRef, (snapshot) => {
                const remoteData = snapshot.val();
                
                if (remoteData && remoteData.latitude) {
                    remoteDisplayEl.innerHTML = `
                        <div class="text-xs font-semibold text-gray-500 mb-1">LIVE SHARED LOCATION (From ${remoteData.username})</div>
                        <p><strong>Latitude:</strong> ${remoteData.latitude.toFixed(6)}</p>
                        <p><strong>Longitude:</strong> ${remoteData.longitude.toFixed(6)}</p>
                        <p><strong>Last Shared:</strong> ${remoteData.timestamp}</p>
                    `;
                    
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${remoteData.latitude},${remoteData.longitude}`;
                    mapLinkEl.href = mapUrl;
                    mapLinkEl.classList.remove('hidden');
                    mapLinkEl.textContent = 'View Location on Google Maps';

                } else {
                    remoteDisplayEl.innerHTML = '<div class="text-red-400">No live shared location data available.</div>';
                    mapLinkEl.classList.add('hidden');
                }
            }, {
                onlyOnce: false
            });
        }
        
        // --- INITIALIZATION ---

        window.onload = function() {
            
            handleLogout(true); 
            
            initAuth();
            
            // Populate Role Select
            const roleSelect = document.getElementById('role-select');
            roleSelect.innerHTML = `
                <option value="">-- Select Role --</option>
                <option value="Admin">Admin</option>
                <option value="Teacher">Teacher</option>
                <option value="Student">Student</option>
            `;
            
            // Attach event listeners
            loginFormEl.addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => handleLogout(false));
            
            // User Signup events (for Student and Teacher self-signup)
            document.getElementById('show-signup-btn').addEventListener('click', showSignup);
            document.getElementById('back-to-login-btn').addEventListener('click', showLogin);
            userSignupFormEl.addEventListener('submit', handleUserSignup);
            
            document.getElementById('user-signup-role').addEventListener('change', (e) => {
                if (e.target.value === 'Student') {
                    signupClassFieldEl.classList.remove('hidden');
                } else {
                    signupClassFieldEl.classList.add('hidden');
                }
            });


            // Assignment events
            assignmentFormEl.addEventListener('submit', handleAssignmentSubmit);
            
            // Admin events 
            document.getElementById('user-add-form').addEventListener('submit', handleUserAdd);
            document.getElementById('notification-form').addEventListener('submit', handleNotificationUpdate);

            // Geolocation events
            document.getElementById('start-btn').addEventListener('click', startSharing);
            document.getElementById('stop-btn').addEventListener('click', stopSharing);
            
            // Set initial button styles
            document.getElementById('stop-btn').classList.add('bg-gray-500', 'cursor-not-allowed');
            
            // Admin User Add form logic
            document.getElementById('new-user-role').addEventListener('change', (e) => {
                const classField = document.getElementById('new-user-class-field');
                if (e.target.value === 'Student') {
                    classField.classList.remove('hidden');
                } else {
                    classField.classList.add('hidden');
                }
            });
            document.getElementById('new-user-role').dispatchEvent(new Event('change')); // Initial call
        }
        
        // Simple Navigation Toggle
        window.showView = function(viewId) {
            const views = ['assignments-view', 'leaderboard-view', 'location-view', 'user-management-view'];
            views.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId + '-view').classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nav-' + viewId).classList.add('active');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .card {
            background-color: #2d3748; /* Darker card background */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        .input-style, .select-style {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .title-glow {
            text-shadow: 0 0 5px #f6e05e, 0 0 10px #f6ad55;
        }
        .shadow-soft {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), 0 1px 3px rgba(0, 0, 0, 0.15);
        }
        .nav-button {
            transition: all 0.2s;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .nav-button.active {
            border-bottom: 3px solid #f6e05e;
            color: #f6e05e;
        }
        /* Custom styles for the table */
        #user-management-view table {
             border-collapse: separate;
             border-spacing: 0;
        }
        #user-management-view th {
            background-color: #4a5568;
        }
        .option-item:hover input:not(:disabled) {
            background-color: #1a202c; /* Ensure radio button background changes on hover */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-4xl space-y-6">

        <!-- Main Header (Updated Title and Notification) -->
        <header class="text-center mb-6">
            <div class="text-4xl title-glow mb-2">
                <span class="text-yellow-400">â„ï¸</span> Winter Assignment Portal Zone Wagoora <span class="text-yellow-400">ðŸ†</span>
            </div>
            <!-- Notification Marquee -->
            <div class="bg-yellow-800 bg-opacity-30 py-1 px-4 rounded-lg shadow-inner">
                 <marquee id="notification-marquee" class="text-sm font-semibold text-yellow-300" scrollamount="4">
                    Loading notifications...
                </marquee>
            </div>
            <p id="error-message" class="text-sm text-red-500 mt-2"></p>
        </header>

        <!-- --- LOGIN CONTAINER (Starts visible) --- -->
        <div id="login-container" class="card p-6 rounded-xl">
            <h2 class="text-2xl font-semibold text-gray-200 mb-6 border-b border-gray-600 pb-2">Portal Login</h2>
            
            <form id="login-form" class="space-y-4">
                
                <div>
                    <label for="role-select" class="block text-sm font-medium text-gray-400 mb-1">Login As:</label>
                    <select id="role-select" class="w-full px-4 py-3 rounded-lg select-style border focus:ring-yellow-500 focus:border-yellow-500">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-400 mb-1">Username:</label>
                    <input type="text" id="username-input" required class="w-full px-4 py-3 rounded-lg input-style border focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Admin_Pethgam or User101">
                </div>

                <div>
                    <label for="pin-input" class="block text-sm font-medium text-gray-400 mb-1">Password / PIN:</label>
                    <input type="password" id="pin-input" required class="w-full px-4 py-3 rounded-lg input-style border focus:ring-yellow-500 focus:border-yellow-500" placeholder="****">
                </div>
                
                <button type="submit" class="w-full px-4 py-3 rounded-lg font-semibold transition duration-200 bg-teal-500 text-white hover:bg-teal-600 shadow-soft">
                    Login
                </button>
            </form>
            <p class="text-xs text-gray-500 mt-4 text-center">
                <button id="show-signup-btn" class="text-yellow-400 hover:text-yellow-300 font-semibold">
                    New User? Click here to Sign Up (Requires Admin Approval).
                </button>
            </p>
            <p class="text-xs text-gray-500 mt-2 text-center">
                *Demo Admin: Admin\_Pethgam / 0000
            </p>
        </div>
        
        <!-- --- USER SIGNUP CONTAINER (Starts hidden) --- -->
        <div id="user-signup-container" class="card p-6 rounded-xl hidden">
            <h2 class="text-2xl font-semibold text-gray-200 mb-6 border-b border-gray-600 pb-2">Teacher / Student Sign Up</h2>
            <p id="signup-error-message" class="text-sm text-red-500 mb-4"></p>
            
            <form id="user-signup-form" class="space-y-4">
                
                <!-- Role Selection -->
                <div>
                    <label for="user-signup-role" class="block text-sm font-medium text-gray-400 mb-1">I am a:</label>
                    <select id="user-signup-role" required class="w-full px-4 py-3 rounded-lg select-style border focus:ring-yellow-500 focus:border-yellow-500">
                        <option value="">-- Select Role --</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Student">Student</option>
                    </select>
                </div>

                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label for="user-signup-username" class="block text-sm font-medium text-gray-400 mb-1">Username:</label>
                        <input type="text" id="user-signup-username" required class="w-full px-4 py-3 rounded-lg input-style border focus:ring-yellow-500 focus:border-yellow-500" placeholder="Choose a Username">
                    </div>
                    <div class="flex-1">
                        <label for="user-signup-pin" class="block text-sm font-medium text-gray-400 mb-1">PIN:</label>
                        <input type="password" id="user-signup-pin" required class="w-full px-4 py-3 rounded-lg input-style border focus:ring-yellow-500 focus:border-yellow-500" placeholder="Choose a PIN (e.g., 1111)">
                    </div>
                </div>
                
                <div class="flex space-x-4">
                     <div class="flex-1">
                        <label for="user-signup-school" class="block text-sm font-medium text-gray-400 mb-1">School:</label>
                        <select id="user-signup-school" required class="w-full px-4 py-3 rounded-lg select-style border focus:ring-yellow-500 focus:border-yellow-500">
                             <!-- Options populated by JS -->
                        </select>
                    </div>
                    <!-- Class field visible only if Student is selected -->
                    <div class="flex-1 hidden" id="signup-class-field">
                        <label for="user-signup-class" class="block text-sm font-medium text-gray-400 mb-1">Class (Student Only):</label>
                        <select id="user-signup-class" required class="w-full px-4 py-3 rounded-lg select-style border focus:ring-yellow-500 focus:border-yellow-500">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>
                
                <button
                    type="submit" class="w-full px-4 py-3 rounded-lg font-semibold transition duration-200 bg-green-500 text-white hover:bg-green-600 shadow-soft">
                    Submit for Admin Approval
                </button>
            </form>
            <p class="text-xs text-gray-500 mt-4 text-center">
                <button id="back-to-login-btn" class="text-blue-400 hover:text-blue-300 font-semibold">
                    Already Registered? Back to Login.
                </button>
            </p>
        </div>


        <!-- --- ASSIGNMENT PORTAL CONTAINER (Starts hidden) --- -->
        <div id="assignment-portal-container" class="space-y-6 hidden">
            
            <!-- Welcome/Status Card & Logout -->
            <div class="card p-4 rounded-xl text-center flex justify-between items-center">
                <p id="welcome-message" class="text-base md:text-lg font-semibold text-yellow-400"></p>
                <button id="logout-btn" class="px-3 py-1 md:px-4 md:py-2 rounded-lg font-semibold text-sm transition duration-200 bg-red-700 text-white hover:bg-red-800 shadow-soft">
                    Logout
                </button>
            </div>

            <!-- Role-Based Navigation -->
            <div class="card p-2 rounded-xl">
                <div class="flex justify-between flex-wrap text-sm md:text-base">
                    <button id="nav-assignments" onclick="showView('assignments')" class="nav-button flex-1 text-center py-2 text-gray-400 font-semibold active">Assignments</button>
                    <button id="nav-leaderboard" onclick="showView('leaderboard')" class="nav-button flex-1 text-center py-2 text-gray-400 font-semibold">Leaderboard</button>
                    <!-- Admin tabs - Hidden for Teacher/Student via JS -->
                    <button id="nav-location" onclick="showView('location')" class="nav-button flex-1 text-center py-2 text-gray-400 font-semibold hidden">Live GPS</button>
                    <button id="nav-user-management" onclick="showView('user-management')" class="nav-button flex-1 text-center py-2 text-gray-400 font-semibold hidden">Users/Approval</button>
                </div>
            </div>
            
            <!-- Assignments View -->
            <div id="assignments-view">
                
                <!-- TEACHER/ADMIN ASSIGNMENT MANAGEMENT (MCQ Form Updated) -->
                <div id="teacher-view" class="space-y-6 hidden">
                    <div class="card p-6 rounded-xl border-l-4 border-blue-500">
                        <h2 class="text-2xl font-bold text-blue-400 mb-4">Add New Multiple Choice Assignment</h2>
                        
                        <form id="assignment-form" class="space-y-4">
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <label for="assignment-class-select" class="block text-sm font-medium text-gray-400 mb-1">Class:</label>
                                    <select id="assignment-class-select" required class="w-full px-4 py-3 rounded-lg select-style"></select>
                                </div>
                                <div class="flex-1">
                                    <label for="assignment-subject-select" class="block text-sm font-medium text-gray-400 mb-1">Subject:</label>
                                    <select id="assignment-subject-select" required class="w-full px-4 py-3 rounded-lg select-style"></select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="assignment-question" class="block text-sm font-medium text-gray-400 mb-1">Question/Task:</label>
                                <textarea id="assignment-question" rows="3" required class="w-full px-4 py-3 rounded-lg input-style" placeholder="Type the assignment question here..."></textarea>
                            </div>
                            
                            <h3 class="text-lg font-semibold text-gray-300 border-b border-gray-600 pb-1 pt-2">Answer Options (A, B, C, D)</h3>

                            <!-- Option A -->
                            <div class="flex space-x-2 items-center">
                                <label class="w-8 font-bold text-teal-300">A:</label>
                                <input type="text" id="assignment-option-a" required class="flex-1 px-4 py-3 rounded-lg input-style" placeholder="Option A Text">
                            </div>
                            <!-- Option B -->
                            <div class="flex space-x-2 items-center">
                                <label class="w-8 font-bold text-teal-300">B:</label>
                                <input type="text" id="assignment-option-b" required class="flex-1 px-4 py-3 rounded-lg input-style" placeholder="Option B Text">
                            </div>
                            <!-- Option C -->
                            <div class="flex space-x-2 items-center">
                                <label class="w-8 font-bold text-teal-300">C:</label>
                                <input type="text" id="assignment-option-c" required class="flex-1 px-4 py-3 rounded-lg input-style" placeholder="Option C Text">
                            </div>
                            <!-- Option D -->
                            <div class="flex space-x-2 items-center">
                                <label class="w-8 font-bold text-teal-300">D:</label>
                                <input type="text" id="assignment-option-d" required class="flex-1 px-4 py-3 rounded-lg input-style" placeholder="Option D Text">
                            </div>
                            
                            <!-- Correct Answer Key -->
                            <div>
                                <label for="assignment-correct-key" class="block text-sm font-medium text-gray-400 mb-1">Correct Answer Key (A, B, C, or D):</label>
                                <select id="assignment-correct-key" required class="w-full px-4 py-3 rounded-lg select-style">
                                    <option value="">-- Select Correct Key --</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="w-full px-4 py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-soft">
                                Publish Assignment (MCQ)
                            </button>
                        </form>
                    </div>
                </div>

                <!-- STUDENT ASSIGNMENT VIEW -->
                <div id="student-view" class="space-y-6 hidden">
                     <h2 class="text-2xl font-bold text-yellow-400 mb-4">My Pending Assignments</h2>
                     <div id="assignment-list">
                         <p class="text-center text-gray-400">Loading assignments...</p>
                     </div>
                </div>
            </div>

            <!-- Leaderboard View (Trophies Added) -->
            <div id="leaderboard-view" class="hidden">
                <h2 class="text-2xl font-bold text-green-400 mb-4">Assignment Leaderboard</h2>
                <div class="card p-4 rounded-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-600">
                        <thead>
                            <tr class="text-left text-gray-400 text-xs uppercase tracking-wider">
                                <th class="p-3">Rank</th>
                                <th class="p-3">Student</th>
                                <th class="p-3">School</th>
                                <th class="p-3 text-right">Total Score</th>
                                <th class="p-3 text-center">Trophy</th>
                                <th class="p-3 text-right">Assignments</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-table-body" class="divide-y divide-gray-700">
                            <tr><td colspan="6" class="text-center p-4 text-gray-500">Loading data...</td></tr>
                        </tbody>
                    </table>
                    <p class="text-xs text-gray-500 mt-4 text-center">
                        <span class="font-bold">Trophy Thresholds:</span> ðŸ¥‰ Bronze (2000), ðŸ¥ˆ Silver (4000), ðŸ¥‡ Gold (6000)
                    </p>
                </div>
            </div>

            <!-- Admin User Management & Notifications View (Approval Workflow Added) -->
            <div id="user-management-view" class="hidden space-y-6">
                <div id="admin-view" class="space-y-6">
                    
                    <!-- Notification Update Section (Scrolling Marquee Management) -->
                    <div class="card p-6 rounded-xl border-l-4 border-yellow-500">
                        <h2 class="text-xl font-bold text-yellow-400 mb-4">Manage Live Scrolling Notification</h2>
                        <form id="notification-form" class="space-y-3">
                            <div>
                                <label for="notification-input" class="block text-sm font-medium text-gray-400 mb-1">New Marquee Message:</label>
                                <textarea id="notification-input" rows="2" class="w-full px-4 py-3 rounded-lg input-style" placeholder="Type urgent announcement here..."></textarea>
                            </div>
                            <button type="submit" class="w-full px-4 py-3 rounded-lg font-semibold bg-yellow-600 text-white hover:bg-yellow-700 shadow-soft">
                                Update Notification
                            </button>
                            <p id="notification-error-message" class="text-sm text-red-500 mt-2 text-center"></p>
                        </form>
                    </div>

                    <!-- Add User Section (Teacher/Student Management) -->
                    <div class="card p-6 rounded-xl border-l-4 border-green-500">
                        <h2 class="text-xl font-bold text-green-400 mb-4">Manually Add & Approve User</h2>
                        <form id="user-add-form" class="space-y-4">
                            
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <label for="new-user-role" class="block text-sm font-medium text-gray-400 mb-1">Role:</label>
                                    <select id="new-user-role" required class="w-full px-4 py-3 rounded-lg select-style">
                                        <option value="Teacher">Teacher</option>
                                        <option value="Student">Student</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="new-user-school" class="block text-sm font-medium text-gray-400 mb-1">School:</label>
                                    <select id="new-user-school" required class="w-full px-4 py-3 rounded-lg select-style">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <label for="new-user-username" class="block text-sm font-medium text-gray-400 mb-1">Username:</label>
                                    <input type="text" id="new-user-username" required class="w-full px-4 py-3 rounded-lg input-style" placeholder="Username">
                                </div>
                                <div class="flex-1">
                                    <label for="new-user-pin" class="block text-sm font-medium text-gray-400 mb-1">PIN/Password:</label>
                                    <input type="password" id="new-user-pin" required class="w-full px-4 py-3 rounded-lg input-style" placeholder="****">
                                </div>
                            </div>
                            
                            <!-- Class field visible only for Students -->
                            <div id="new-user-class-field" class="hidden">
                                <label for="new-user-class" class="block text-sm font-medium text-gray-400 mb-1">Class (Student Only):</label>
                                <select id="new-user-class" class="w-full px-4 py-3 rounded-lg select-style">
                                     <!-- Options populated by JS -->
                                </select>
                            </div>
                            <button type="submit" class="w-full px-4 py-3 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 shadow-soft">
                                Add & Approve User
                            </button>
                            <p id="admin-error-message" class="text-sm text-red-500 mt-2 text-center"></p>
                        </form>
                    </div>

                    <!-- Current Users List (Includes Approval Workflow) -->
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Current Portal Users & Approval</h2>
                    <div class="card p-4 rounded-xl overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-600">
                            <thead>
                                <tr class="text-left text-gray-300 text-xs uppercase tracking-wider">
                                    <th class="p-3">Username</th>
                                    <th class="p-3">Role</th>
                                    <th class="p-3">PIN</th>
                                    <th class="p-3">Class</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-table-body" class="divide-y divide-gray-700">
                                <tr><td colspan="6" class="text-center p-4 text-gray-500">Loading user list...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Location View (Live GPS) -->
            <div id="location-view" class="hidden space-y-6">
                <div class="card p-4 rounded-xl text-center">
                    <p id="portal-status" class="text-base text-red-500 font-bold">Portal is Stopped.</p>
                </div>
                
                <!-- Control Sharing (Admin Only) -->
                <div class="card p-6 rounded-xl" id="location-controls">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4">Control Location Sharing</h2>
                    <p class="text-sm text-gray-400 mb-4">
                        Admin only: Share your device's live location (visible to all logged-in users).
                    </p>
                    <div class="flex space-x-4">
                        <button id="start-btn" class="flex-1 px-4 py-3 rounded-lg font-semibold transition duration-200 bg-green-600 text-white hover:bg-green-700 shadow-soft">
                            Start Sharing
                        </button>
                        <button id="stop-btn" class="flex-1 px-4 py-3 rounded-lg font-semibold transition duration-200 text-white shadow-soft">
                            Stop Sharing
                        </button>
                    </div>
                    <div id="location-display" class="text-sm text-gray-400 space-y-1 mt-4 p-3 bg-gray-700/50 rounded">
                        <div class="text-gray-500">Press 'Start Sharing' to begin sending your GPS coordinates.</div>
                    </div>
                </div>

                <!-- Shared Location Display -->
                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4">Remote Shared Location (Admin)</h2>
                    <div id="remote-location-display" class="text-sm text-gray-400 space-y-1 mb-4">
                        <div class="text-blue-400">Waiting for Admin live data...</div>
                    </div>
                    
                    <a id="map-link" href="#" target="_blank" class="hidden text-center block w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-200 shadow-soft mt-4">
                        View Location on Google Maps
                    </a>
                </div>
            </div>
            
        </div>
        
        <!-- Instruction Footer (Updated with Developer Credit) -->
        <footer class="text-center text-xs text-gray-500 pt-4 space-y-1 w-full max-w-4xl mx-auto">
            <p>Portal powered by Firebase Firestore & Realtime Database.</p>
            <p class="text-sm text-gray-400 font-medium">
                Designed & Developed by Mohammad Ashraf Rather, Teacher PS Pethgam Wagoora.
            </p>
        </footer>

    </div>
</body>
</html>
