<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winter Assignment Portal Zone Wagoora</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, collection, query, onSnapshot, 
            addDoc, serverTimestamp, getDocs, where, orderBy, deleteDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref as dbRef, update as dbUpdate, onValue as dbOnValue, set as dbSet } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Global Firebase variables provided by the environment
        const firebaseConfig = {
            apiKey: "AIzaSyCBLLmzxVYuivT15HBPPSxMoS2OzojRgJM",
            authDomain: "wap-ps-pethgam.firebaseapp.com",
            databaseURL: "https://wap-ps-pethgam-default-rtdb.firebaseio.com",
            projectId: "wap-ps-pethgam",
            storageBucket: "wap-ps-pethgam.firebasestorage.app",
            messagingSenderId: "430925411362",
            appId: "1:430925411362:web:22857dee585d02fc54467b"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // --- GLOBAL STATE ---
        let userId = null;
        let username = null;
        let role = null;
        let isAuthReady = false;
        let rtdbWatchId = null;
        let allUsers = {}; // Cache for all users loaded from Firestore for login validation

        // --- CONSTANTS (UPDATED) ---
        const AVAILABLE_CLASSES = ["1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th"];
        const AVAILABLE_SUBJECTS = ["Math", "English", "EVS", "Urdu", "Kashmiri", "SST"];
        const AVAILABLE_SCHOOLS = ["PS Pethgam Wagoora", "MS Wagoora", "HS Wagoora", "Other School"];
        
        // Initial Admin is hardcoded for first login
        const INITIAL_ADMIN = { 
            "Admin_Pethgam": { role: "Admin", pin: "0000", school: "PS Pethgam Wagoora" } 
        };
        const USER_COLLECTION = collection(db, 'users');

        // --- UI ELEMENTS ---
        const errorEl = document.getElementById('error-message');
        const loginFormEl = document.getElementById('login-form');
        const loginContainerEl = document.getElementById('login-container');
        const studentSignupFormEl = document.getElementById('student-signup-form');
        const studentSignupContainerEl = document.getElementById('student-signup-container');
        const assignmentContainerEl = document.getElementById('assignment-portal-container');
        const welcomeMessageEl = document.getElementById('welcome-message');
        const teacherViewEl = document.getElementById('teacher-view'); 
        const studentViewEl = document.getElementById('student-view');
        const adminViewEl = document.getElementById('admin-view');
        const userListTableBodyEl = document.getElementById('user-list-table-body');
        const assignmentFormEl = document.getElementById('assignment-form');
        const assignmentListEl = document.getElementById('assignment-list');
        const leaderboardTableBodyEl = document.getElementById('leaderboard-table-body');
        const notificationMarqueeEl = document.getElementById('notification-marquee');
        
        // Geolocation elements
        const locationControlsEl = document.getElementById('location-controls');

        // --- FIREBASE AUTHENTICATION & INITIALIZATION ---

        async function initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) userId = user.uid;
                else userId = null;
                isAuthReady = true;
                checkSession();
            });
            await signInAnonymously(auth);
        }

        // --- USER LOADING (For Login Validation & Admin Management) ---

        async function loadAllUsers() {
            // Load all users from Firestore
            const snapshot = await getDocs(USER_COLLECTION);
            allUsers = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                allUsers[data.username] = { ...data, id: doc.id };
            });
            return allUsers;
        }

        // --- STUDENT SIGNUP ---

        function showSignup() {
            loginContainerEl.classList.add('hidden');
            studentSignupContainerEl.classList.remove('hidden');
            
            // Populate Class/School dropdowns
            document.getElementById('student-signup-class').innerHTML = AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('student-signup-school').innerHTML = AVAILABLE_SCHOOLS.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('signup-error-message').textContent = '';
        }

        function showLogin() {
            loginContainerEl.classList.remove('hidden');
            studentSignupContainerEl.classList.add('hidden');
            document.getElementById('signup-error-message').textContent = '';
        }

        async function handleStudentSignup(event) {
            event.preventDefault();
            
            const signupUsername = document.getElementById('student-signup-username').value.trim();
            const signupPin = document.getElementById('student-signup-pin').value.trim();
            const signupClass = document.getElementById('student-signup-class').value;
            const signupSchool = document.getElementById('student-signup-school').value;
            const signupErrorEl = document.getElementById('signup-error-message');

            if (!signupUsername || !signupPin || !signupClass || !signupSchool) {
                signupErrorEl.textContent = 'Please fill all fields.';
                return;
            }
            if (allUsers[signupUsername] || INITIAL_ADMIN[signupUsername]) {
                signupErrorEl.textContent = 'Error: Username already exists!';
                return;
            }
            
            try {
                // Students sign up with Student role
                await addDoc(USER_COLLECTION, {
                    username: signupUsername,
                    role: 'Student',
                    pin: signupPin,
                    class: signupClass,
                    school: signupSchool, // Added School field
                    createdAt: serverTimestamp()
                });
                
                signupErrorEl.textContent = 'Signup successful! Please log in now.';
                studentSignupFormEl.reset();
                await loadAllUsers(); // Update cache
                setTimeout(showLogin, 2000);

            } catch (e) {
                console.error("Signup error:", e);
                signupErrorEl.textContent = `Signup error: ${e.message}`;
            }
        }
        
        // --- LOGIN/SESSION LOGIC ---
        
        function handleLogout(suppressMessage = false) {
            stopSharing();
            sessionStorage.clear();
            
            loginContainerEl.classList.remove('hidden');
            assignmentContainerEl.classList.add('hidden');
            studentSignupContainerEl.classList.add('hidden'); 
            
            // Clear role-specific views
            teacherViewEl.classList.add('hidden');
            studentViewEl.classList.add('hidden');
            adminViewEl.classList.add('hidden');

            if (!suppressMessage) {
                 errorEl.textContent = 'Logged out successfully.';
            } else {
                 errorEl.textContent = '';
            }
            
            signOut(auth).catch(err => console.error("Firebase logout error:", err));
        }


        async function handleLogin(event) {
            event.preventDefault();
            
            role = document.getElementById('role-select').value;
            username = document.getElementById('username-input').value.trim();
            const pin = document.getElementById('pin-input').value.trim();
            
            errorEl.textContent = '';
            
            // 1. Check hardcoded Admin first
            let school = null;
            let userClass = null; // Initialize class variable
            const initialUser = INITIAL_ADMIN[username];
            if (initialUser && initialUser.role === role && initialUser.pin === pin) {
                 school = initialUser.school;
                 userClass = initialUser.class; // Admin doesn't have class, but keep structure for function call
                 await finalizeLogin(username, role, userClass, school);
                 return;
            }
            
            // 2. Check users loaded from Firestore
            const userData = allUsers[username];

            if (userData && userData.role === role && userData.pin === pin) {
                school = userData.school;
                userClass = userData.class;
                await finalizeLogin(username, role, userClass, school);
            } else {
                errorEl.textContent = 'Login Failed: Invalid Role, Username, or PIN.';
            }
        }
        
        async function finalizeLogin(user, userRole, userClass, userSchool) {
            sessionStorage.setItem('portal_logged_in', 'true');
            sessionStorage.setItem('portal_username', user);
            sessionStorage.setItem('portal_role', userRole);
            sessionStorage.setItem('portal_class', userClass || '');
            sessionStorage.setItem('portal_school', userSchool || '');
            
            username = user;
            role = userRole;
            
            transitionToAssignmentPortal(user, userRole);
        }

        async function checkSession() {
            if (isAuthReady) {
                // Load users before checking session (essential for login validation)
                await loadAllUsers(); 

                const loggedIn = sessionStorage.getItem('portal_logged_in') === 'true';
                if (loggedIn) {
                    username = sessionStorage.getItem('portal_username');
                    role = sessionStorage.getItem('portal_role');
                    transitionToAssignmentPortal(username, role);
                } else {
                    // Ensure login view is visible if no session is found
                    loginContainerEl.classList.remove('hidden');
                    assignmentContainerEl.classList.add('hidden');
                    studentSignupContainerEl.classList.add('hidden');
                }
            }
        }

        function transitionToAssignmentPortal(user, userRole) {
            loginContainerEl.classList.add('hidden');
            studentSignupContainerEl.classList.add('hidden');
            assignmentContainerEl.classList.remove('hidden');
            welcomeMessageEl.textContent = `Welcome, ${user} (${userRole} from ${sessionStorage.getItem('portal_school')})!`;
            
            // Role-Based View Switching
            const isAdmin = userRole === 'Admin';
            const isTeacher = userRole === 'Teacher';
            const isStudent = userRole === 'Student';
            
            // Teacher/Admin can see assignment form
            teacherViewEl.classList.toggle('hidden', !(isTeacher || isAdmin)); 
            // Student sees assignment list
            studentViewEl.classList.toggle('hidden', !isStudent);
            // Admin only views
            adminViewEl.classList.toggle('hidden', !isAdmin);
            document.getElementById('nav-user-management').classList.toggle('hidden', !isAdmin);
            document.getElementById('nav-location').classList.toggle('hidden', !isAdmin);
            
            // Location sharing controls are visible to Admin only
            locationControlsEl.classList.toggle('hidden', !isAdmin); 
            
            // Populate Class/Subject/School dropdowns for assignments/user creation
            if(isTeacher || isAdmin) {
                 const classSelect = document.getElementById('assignment-class-select');
                 const subjectSelect = document.getElementById('assignment-subject-select');
                 classSelect.innerHTML = AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
                 subjectSelect.innerHTML = AVAILABLE_SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('');
                 
                 // Admin User Management Fields
                 if (isAdmin) {
                     document.getElementById('new-user-class').innerHTML = AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
                     document.getElementById('new-user-school').innerHTML = AVAILABLE_SCHOOLS.map(s => `<option value="${s}">${s}</option>`).join('');
                 }
            }
            
            // Set default view based on role
            if (isAdmin) {
                showView('user-management'); // Admin lands on User Management
                setupUserListListener(); 
            } else {
                showView('assignments'); // Student/Teacher lands on Assignments
            }
            
            setupAssignmentListeners();
            setupDataListener(); // Start listening for live location
            setupNotificationListener(); // Start listening for live notifications
        }
        
        // --- NOTIFICATION MANAGEMENT (RTDB) ---
        
        const NOTIFICATION_PATH = 'notifications/main_message';

        function setupNotificationListener() {
            const notificationRef = dbRef(rtdb, NOTIFICATION_PATH);

            dbOnValue(notificationRef, (snapshot) => {
                const message = snapshot.val() || 'Welcome to the Winter Assignment Portal Zone Wagoora. Stay tuned for important updates!';
                notificationMarqueeEl.textContent = message;
            }, (error) => {
                console.error("Error listening to notification:", error);
                notificationMarqueeEl.textContent = 'Error loading updates.';
            });
        }

        async function handleNotificationUpdate(event) {
            event.preventDefault();
            
            const newMessage = document.getElementById('notification-input').value.trim();
            const notificationErrorEl = document.getElementById('notification-error-message');

            if (!newMessage) {
                 notificationErrorEl.textContent = 'Notification message cannot be empty.';
                 return;
            }
            
            try {
                await dbSet(dbRef(rtdb, NOTIFICATION_PATH), newMessage);
                notificationErrorEl.textContent = 'Notification updated successfully!';
                // Clear the message after a delay
                setTimeout(() => notificationErrorEl.textContent = '', 3000);
            } catch (e) {
                 console.error("Error updating notification:", e);
                 notificationErrorEl.textContent = `Error: ${e.message}`;
            }
        }

        // --- USER MANAGEMENT (ADMIN ONLY - FIRESTORE) ---

        function setupUserListListener() {
            if (!isAuthReady) return;

            // Query only Teachers and Students (Admin is hardcoded)
            const usersQuery = query(USER_COLLECTION, orderBy('role'), orderBy('username'));
            
            onSnapshot(usersQuery, (snapshot) => {
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserList(users);
            }, (error) => {
                console.error("Error listening to users:", error);
            });
        }
        
        function renderUserList(users) {
             if (role !== 'Admin') return;
             
             userListTableBodyEl.innerHTML = users.map(user => `
                 <tr class="text-sm border-t border-gray-600">
                     <td class="p-3 font-semibold text-yellow-400">${user.username}</td>
                     <td class="p-3">${user.role}</td>
                     <td class="p-3">${user.class || '-'}</td>
                     <td class="p-3">${user.school || 'N/A'}</td>
                     <td class="p-3 text-right">
                         <button data-id="${user.id}" data-username="${user.username}" 
                                 onclick="handleUserDelete(event)"
                                 class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                             Delete
                         </button>
                     </td>
                 </tr>
             `).join('');
        }

        window.handleUserDelete = async function(event) {
             const userIdToDelete = event.target.getAttribute('data-id');
             const userNameToDelete = event.target.getAttribute('data-username');
             
             // Custom modal/confirmation message instead of alert/confirm
             if (!window.confirm(`Are you sure you want to delete user ${userNameToDelete}?`)) {
                 return;
             }
             
             try {
                 const userDocRef = doc(db, 'users', userIdToDelete);
                 await deleteDoc(userDocRef);
                 errorEl.textContent = `User ${userNameToDelete} deleted successfully.`;
                 await loadAllUsers(); // Refresh cache
             } catch (e) {
                 console.error("Error deleting user:", e);
                 errorEl.textContent = `Error deleting user: ${e.message}`;
             }
        }
        
        async function handleUserAdd(event) {
            event.preventDefault();
            
            const newUserRole = document.getElementById('new-user-role').value;
            const newUsername = document.getElementById('new-user-username').value.trim();
            const newPin = document.getElementById('new-user-pin').value.trim();
            const newClass = document.getElementById('new-user-class').value;
            const newSchool = document.getElementById('new-user-school').value;
            const adminErrorEl = document.getElementById('admin-error-message');

            if (!newUserRole || !newUsername || !newPin || !newSchool || (newUserRole === 'Student' && !newClass)) {
                adminErrorEl.textContent = 'Please fill all required fields.';
                return;
            }

            if (allUsers[newUsername] || INITIAL_ADMIN[newUsername]) {
                adminErrorEl.textContent = 'Error: Username already exists!';
                return;
            }
            
            try {
                const userData = {
                    username: newUsername,
                    role: newUserRole,
                    pin: newPin,
                    school: newSchool,
                    class: (newUserRole === 'Student') ? newClass : null, // Class only for Students
                    createdBy: username,
                    createdAt: serverTimestamp()
                };
                
                await addDoc(USER_COLLECTION, userData);
                
                adminErrorEl.textContent = `${newUserRole} ${newUsername} added successfully!`;
                document.getElementById('user-add-form').reset










        
                                            </button>
                    </div>
                </div>

                <div class="card p-6 rounded-xl">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4">Remote Shared Location (Admin)</h2>
                    <div id="remote-location-display" class="text-sm text-gray-400 space-y-1 mb-4">
                        <div class="text-blue-400">Waiting for Admin live data...</div>
                    </div>
                    
                    <a id="map-link" href="#" target="_blank" class="hidden text-center block w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-200 shadow-soft mt-4">
                        View Location on Google Maps
                    </a>
                </div>
            </div>
            
            
            <div id="user-management-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-red-400 mb-4">Admin: User Management</h2>

                <div class="card p-6 rounded-xl border-l-4 border-red-500">
                    <h3 class="text-xl font-semibold text-gray-200 mb-4">Add Teacher or Student</h3>
                    <form id="add-user-form" class="space-y-3">
                        <input type="text" id="add-username" required class="w-full px-4 py-2 rounded-lg input-style" placeholder="Username (e.g., NewTeacher)">
                        <input type="password" id="add-pin" required class="w-full px-4 py-2 rounded-lg input-style" placeholder="PIN/Password">
                        
                        <div class="flex space-x-3">
                            <select id="add-role" required class="flex-1 px-4 py-2 rounded-lg select-style">
                                <option value="">-- Select Role --</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Student">Student</option>
                            </select>
                            <select id="add-class" class="flex-1 px-4 py-2 rounded-lg select-style">
                                </select>
                        </div>
                        
                        <button type="submit" class="w-full px-4 py-3 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700 shadow-soft">
                            Add User
                        </button>
                    </form>
                </div>
                
                <div class="card p-4 rounded-xl overflow-x-auto">
                    <h3 class="text-xl font-semibold text-gray-200 mb-4">Existing Users</h3>
                    <table class="min-w-full divide-y divide-gray-600">
                        <thead>
                            <tr class="text-left text-gray-400 text-xs uppercase tracking-wider">
                                <th class="p-3">Username</th>
                                <th class="p-3">Role</th>
                                <th class="p-3">Class</th>
                                <th class="p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-table-body" class="divide-y divide-gray-700">
                            <tr><td colspan="4" class="text-center p-4 text-gray-500">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
        
        <footer class="text-center text-xs text-gray-500 pt-4">
            <p>Portal powered by Firebase Firestore & Realtime Database.</p>
        </footer>

    </div>
</body>
</html>
```eof

### How to Demo the New Features:

1.  **Log in as Admin:**
    * **Role:** `Admin`, **Username:** `Admin_Pethgam`, **PIN:** `0000`
    * The **"Users"** tab will appear in the navigation bar.
2.  **Add a Teacher/Student (Admin View):**
    * Go to the **Users** tab.
    * Use the **"Add Teacher or Student"** form to create a new user (e.g., Role: `Teacher`, Username: `NewTeacher`, PIN: `2024`, Class: `2nd`).
    * Click **"Add User."** The new user will appear in the list below and can be deleted from there.
3.  **Student Sign-Up:**
    * **Logout** from Admin.
    * On the login page, click **"New Student? Click here to Sign Up."**
    * Fill out the form (Username, PIN, **Class 1st-5th**). The new student is automatically added to the database.
4.  **Teacher/Admin Assignment Flow:**
    * Log in as the newly created `Teacher` (NewTeacher/2024).
    * Go to the **Assignments** tab and use the form to publish an assignment for a specific class (e.g., Class: `2nd`).
5.  **Student Assignment Flow:**
    * Log in as a `Student` who belongs to the Class you targeted (e.g., the student created in step 3).
    * The assignment should now appear in their **Assignments** list.

This structure fully supports your requested user management, sign-up flow, and the expanded class list.
            
