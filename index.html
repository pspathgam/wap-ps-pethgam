<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Zone Wagoora — Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-xl mx-auto p-4">
    <header class="bg-indigo-700 text-white rounded p-4 text-center mb-4">
      <h1 class="text-2xl font-semibold">Zone Wagoora MCQ Portal</h1>
      <p class="text-sm">Winter Assignments — Choose School, Class & Start</p>
    </header>

    <main class="bg-white p-4 rounded shadow">
      <label class="block mb-1 font-medium">Select School</label>
      <select id="studentSchool" class="w-full border p-2 rounded mb-3">
        <option value="">Loading schools...</option>
      </select>

      <div class="text-center mb-3">
        <img id="schoolLogo" class="w-36 mx-auto hidden" alt="school logo"/>
      </div>

      <label class="block mb-1 font-medium">Select Class</label>
      <select id="studentClass" class="w-full border p-2 rounded mb-3">
        <option value="">Select Class</option>
        <option>1</option><option>2</option><option>3</option><option>4</option>
        <option>5</option><option>6</option><option>7</option><option>8</option>
      </select>

      <label class="block mb-1 font-medium">Student Name</label>
      <input id="studentName" class="w-full border p-2 rounded mb-3" placeholder="Enter name" />

      <div class="flex gap-2">
        <button id="enterBtn" class="w-full bg-indigo-600 text-white p-2 rounded">Enter Portal</button>
      </div>

      <p class="mt-4 text-xs text-gray-500">Note: If a school is missing ask your zone coordinator to add it via the Admin panel.</p>
    </main>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    // ----- Firebase config (use your project's config) -----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBLLmzxVYuivT15HBPPSxMoS2OzojRgJM",
      authDomain: "wap-ps-pethgam.firebaseapp.com",
      databaseURL: "https://wap-ps-pethgam-default-rtdb.firebaseio.com",
      projectId: "wap-ps-pethgam",
      storageBucket: "wap-ps-pethgam.appspot.com",
      messagingSenderId: "430925411362",
      appId: "1:430925411362:web:22857dee585d02fc54467b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM
    const selSchool = document.getElementById('studentSchool');
    const schoolLogo = document.getElementById('schoolLogo');
    const enterBtn = document.getElementById('enterBtn');

    // load schools from Firestore 'schools' collection
    async function loadSchools(){
      try {
        const snap = await getDocs(collection(db, 'schools'));
        selSchool.innerHTML = '<option value=\"\">Select Your School</option>';
        snap.forEach(doc => {
          const data = doc.data();
          // doc.id expected to be UDISE code or unique id
          const id = doc.id;
          const name = data.name || (data.udise ? `${data.udise} — ${data.name}` : id);
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = `${id} — ${data.name || 'Unnamed School'}`;
          selSchool.appendChild(opt);
        });
      } catch(err){
        console.error('loadSchools error', err);
        selSchool.innerHTML = '<option value=\"\">(failed to load schools)</option>';
      }
    }

    selSchool.addEventListener('change', async () => {
      const udise = selSchool.value;
      if(!udise){ schoolLogo.classList.add('hidden'); schoolLogo.src = ''; return; }
      try {
        const url = await getDownloadURL(ref(storage, `school_logos/${udise}.png`));
        schoolLogo.src = url;
        schoolLogo.classList.remove('hidden');
      } catch(e){
        // try jpg
        try {
          const url2 = await getDownloadURL(ref(storage, `school_logos/${udise}.jpg`));
          schoolLogo.src = url2; schoolLogo.classList.remove('hidden');
        } catch {
          schoolLogo.classList.add('hidden');
        }
      }
    });

    enterBtn.addEventListener('click', () => {
      const school = selSchool.value;
      const cls = document.getElementById('studentClass').value;
      const name = document.getElementById('studentName').value.trim();
      if(!school || !cls || !name){ alert('Please fill school, class and name'); return; }
      // simple id (UDISE_class_name timestamp) - safe for collisions
      const id = `${school}_${cls}_${name.replace(/\s+/g,'_')}_${Date.now()}`;
      localStorage.setItem('studentSchool', school);
      localStorage.setItem('studentClass', cls);
      localStorage.setItem('studentName', name);
      localStorage.setItem('studentId', id);
      window.location.href = 'quiz-list.html';
    });

    // init
    loadSchools();
  </script>
</body>
</html>
