<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winter Assignment MCQ Portal - Pethgam Wagoora</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ùÑÔ∏è</text></svg>">
    <style>
        /* ---------------------------------------------------- */
        /* 1. Global & Utility Styles */
        /* ---------------------------------------------------- */
        :root {
            --color-blue: #00bcd4; /* Vibrant Blue/Cyan */
            --color-teal: #009688; /* Vibrant Teal */
            --color-gold: #ffc107; /* Vibrant Gold/Amber */
            --color-dark: #1a1a2e; /* Dark background */
            --color-bg-light: rgba(255, 255, 255, 0.08); /* Glass light bg */
            --color-text-light: #f0f0f0;
            --color-success: #4caf50;
            --color-error: #f44336;
            --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.4);
            --border-radius-soft: 12px;
            --glass-backdrop: blur(10px);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--color-dark) 0%, #000 100%);
            color: var(--color-text-light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 10px;
            transition: background var--transition-speed;
        }

        /* ---------------------------------------------------- */
        /* 2. Glassmorphism & Neon Glow Elements */
        /* ---------------------------------------------------- */
        .portal-container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        .card {
            background: var(--color-bg-light);
            border-radius: var(--border-radius-soft);
            backdrop-filter: var(--glass-backdrop);
            border: var(--glass-border);
            box-shadow: var(--shadow-soft);
            padding: 25px;
            margin-bottom: 20px;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
        }

        .neon-heading {
            color: var(--color-gold);
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 5px var(--color-gold), 0 0 10px var(--color-gold), 0 0 20px #ffeb3b;
            font-size: 2.5em;
        }
        
        h2 {
            color: var(--color-teal);
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(0, 150, 136, 0.3);
            padding-bottom: 5px;
        }

        /* ---------------------------------------------------- */
        /* 3. Form & Button Styles */
        /* ---------------------------------------------------- */
        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--color-text-light);
            font-size: 1em;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 2px var(--color-blue);
        }

        button, .btn {
            background-color: var(--color-blue);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
            margin-top: 10px;
            display: inline-block;
        }

        button:hover, .btn:hover {
            background-color: #00a4b8;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 188, 212, 0.4);
        }

        .btn-gold {
            background-color: var(--color-gold);
            margin-left: 10px;
        }
        .btn-gold:hover {
            background-color: #e5ad00;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
        }
        .btn-danger {
            background-color: var(--color-error);
        }
        .btn-danger:hover {
            background-color: #d32f2f;
        }

        /* ---------------------------------------------------- */
        /* 4. Table & List Styles */
        /* ---------------------------------------------------- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-soft);
            overflow: hidden;
        }

        th, td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background-color: rgba(0, 188, 212, 0.3);
            font-weight: 700;
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* ---------------------------------------------------- */
        /* 5. Dashboard Specifics */
        /* ---------------------------------------------------- */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 25px;
        }

        .stat-card h3 {
            font-size: 1.2em;
            color: var(--color-teal);
        }

        .stat-card p {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--color-gold);
            margin-top: 5px;
        }

        /* MCQ Card */
        .mcq-item {
            padding: 20px;
            border-left: 5px solid var(--color-blue);
            margin-bottom: 15px;
        }
        
        .mcq-question {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .mcq-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            transition: background-color var(--transition-speed);
        }
        .mcq-option:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .mcq-option input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--color-blue);
        }

        .mcq-feedback {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .mcq-feedback.correct {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--color-success);
        }
        .mcq-feedback.wrong {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--color-error);
        }

        /* Leaderboard Specific */
        .leaderboard-row.gold { background-color: rgba(255, 193, 7, 0.3); border-left: 5px solid var(--color-gold); }
        .leaderboard-row.silver { background-color: rgba(192, 192, 192, 0.3); border-left: 5px solid silver; }
        .leaderboard-row.bronze { background-color: rgba(205, 127, 50, 0.3); border-left: 5px solid #cd7f32; }
        .user-highlight {
            background-color: rgba(0, 188, 212, 0.4) !important;
            font-weight: bold;
        }

        /* ---------------------------------------------------- */
        /* 6. Mobile Responsiveness */
        /* ---------------------------------------------------- */
        @media (max-width: 768px) {
            .neon-heading {
                font-size: 2em;
            }
            .card {
                padding: 15px;
            }
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid rgba(255, 255, 255, 0.2);
                margin-bottom: 10px;
                border-radius: var(--border-radius-soft);
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--color-teal);
            }
            td:nth-of-type(1):before { content: "Name/Roll No"; }
            td:nth-of-type(2):before { content: "Class/Subject"; }
            td:nth-of-type(3):before { content: "Points"; }
            td:nth-of-type(4):before { content: "Rank"; }
            td:nth-of-type(5):before { content: "Action"; } /* For management tables */
        }
    </style>
</head>
<body>
    <div class="portal-container" id="app">
        <h1 class="neon-heading">‚ùÑÔ∏è GPS Pethgam Wagoora Assignment Portal üèÜ</h1>
        
        <div id="login-screen" class="card">
            <h2>Portal Login</h2>
            <form id="login-form">
                <label for="login-role">Login As:</label>
                <select id="login-role" required>
                    <option value="">-- Select Role --</option>
                    <option value="admin">Master Admin (HOI)</option>
                    <option value="teacher">Teacher</option>
                    <option value="student">Student</option>
                </select>

                <label for="login-username" id="login-username-label">Username / Roll No:</label>
                <input type="text" id="login-username" required>

                <label for="login-password" id="login-password-label">Password / PIN:</label>
                <input type="password" id="login-password" required>

                <button type="submit">Login</button>
                <div id="login-message" style="margin-top:15px; color: var(--color-error);"></div>
            </form>
        </div>

        <div id="admin-panel" class="card" style="display: none;">
            <div style="text-align: right; margin-bottom: 20px;"><button onclick="logout()" class="btn-danger">Logout</button></div>
            <h2 id="admin-welcome">Welcome, Master Admin!</h2>
            
            <div class="grid-3">
                <div class="stat-card card"><h3>Total Teachers</h3><p id="stat-teachers">0</p></div>
                <div class="stat-card card"><h3>Total Students</h3><p id="stat-students">0</p></div>
                <div class="stat-card card"><h3>Total MCQs</h3><p id="stat-mcqs">0</p></div>
            </div>
            
            <hr>

            <div class="card">
                <h2>üßë‚Äçüè´ Teacher Management</h2>
                <button onclick="toggleSection('add-teacher-form')">‚ûï Add New Teacher</button>
                <div id="add-teacher-form" style="display: none; margin-top: 15px;">
                    <h3>Add Teacher</h3>
                    <form id="form-add-teacher">
                        <input type="text" id="add-teacher-name" placeholder="Name" required>
                        <input type="text" id="add-teacher-username" placeholder="Username (Unique)" required>
                        <input type="password" id="add-teacher-password" placeholder="Password" required>
                        <button type="submit">Add Teacher</button>
                    </form>
                </div>

                <h3 style="margin-top: 20px; color: var(--color-gold);">Existing Teachers</h3>
                <div id="teacher-list-admin"></div>
            </div>
            
            <div class="card">
                <h2>üéí Student Management</h2>
                <button onclick="toggleSection('add-student-form')">‚ûï Add New Student</button>
                <div id="add-student-form" style="display: none; margin-top: 15px;">
                    <h3>Add Student</h3>
                    <form id="form-add-student">
                        <input type="text" id="add-student-name" placeholder="Name" required>
                        <select id="add-student-class" required>
                            <option value="">-- Select Class --</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                            <option value="4">Class 4</option>
                            <option value="5">Class 5</option>
                        </select>
                        <input type="text" id="add-student-rollno" placeholder="Roll No (Unique)" required>
                        <input type="password" id="add-student-pin" placeholder="4-digit PIN (e.g., 1234)" pattern="\d{4}" maxlength="4" required>
                        <button type="submit">Add Student</button>
                    </form>
                </div>

                <h3 style="margin-top: 20px; color: var(--color-gold);">Existing Students</h3>
                <div id="student-list-admin"></div>
            </div>
        </div>

        <div id="teacher-panel" class="card" style="display: none;">
            <div style="text-align: right; margin-bottom: 20px;"><button onclick="logout()" class="btn-danger">Logout</button></div>
            <h2 id="teacher-welcome">Welcome, Teacher!</h2>

            <div class="card">
                <h2>üìù Upload Daily Assignment (MCQ)</h2>
                <form id="form-upload-mcq">
                    <label for="mcq-class">Class:</label>
                    <select id="mcq-class" required>
                        <option value="">-- Select Class --</option>
                        <option value="1">Class 1</option>
                        <option value="2">Class 2</option>
                        <option value="3">Class 3</option>
                        <option value="4">Class 4</option>
                        <option value="5">Class 5</option>
                    </select>
                    
                    <label for="mcq-subject">Subject:</label>
                    <input type="text" id="mcq-subject" placeholder="e.g. Math, English, Urdu" required>

                    <label for="mcq-question">Question:</label>
                    <textarea id="mcq-question" placeholder="Enter the question text..." required></textarea>

                    <label for="mcq-option-a">Option A:</label>
                    <input type="text" id="mcq-option-a" required>
                    <label for="mcq-option-b">Option B:</label>
                    <input type="text" id="mcq-option-b" required>
                    <label for="mcq-option-c">Option C:</label>
                    <input type="text" id="mcq-option-c" required>
                    <label for="mcq-option-d">Option D:</label>
                    <input type="text" id="mcq-option-d" required>

                    <label for="mcq-correct">Correct Answer:</label>
                    <select id="mcq-correct" required>
                        <option value="">-- Select Correct Option --</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>

                    <button type="submit">Upload MCQ</button>
                    <div id="upload-message" style="margin-top:15px;"></div>
                </form>
            </div>

            <div class="card">
                <h2>üìö My Uploaded MCQs</h2>
                <div id="teacher-mcq-list"></div>
            </div>
        </div>

        <div id="student-panel" class="card" style="display: none;">
            <div style="text-align: right; margin-bottom: 20px;"><button onclick="logout()" class="btn-danger">Logout</button></div>
            <h2 id="student-welcome">Welcome!</h2>
            
            <div class="grid-3">
                <div class="stat-card card"><h3>My Class</h3><p id="student-class-stat">N/A</p></div>
                <div class="stat-card card"><h3>Total Points</h3><p id="student-total-points">0</p></div>
                <div class="stat-card card"><h3>School Rank</h3><p id="student-school-rank">N/A</p></div>
            </div>

            <div class="card">
                <h2>üìÖ Today's Assignments for Class <span id="student-class-display"></span></h2>
                <div id="todays-mcq-list">
                    <p>No assignments for your class today. Check back tomorrow!</p>
                </div>
            </div>

            <div class="card">
                <h2>üèÜ Leaderboards</h2>
                <button onclick="displayLeaderboard('school')" class="btn">School-wide (Top 10)</button>
                <button onclick="displayLeaderboard('class')" class="btn btn-gold">Class-wise (My Class)</button>
                
                <h3 style="margin-top: 20px; color: var(--color-teal);">Subject-wise Leaderboard</h3>
                <select id="leaderboard-subject-select" onchange="displayLeaderboard('subject')">
                    <option value="">-- Select Subject --</option>
                </select>

                <div id="leaderboard-display" style="margin-top: 20px;">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================
        // JAVASCRIPT: LOCAL STORAGE DATA STRUCTURES
        // ====================================================

        const STORAGE_KEYS = {
            USERS: 'mcqPortal_users',
            MCQS: 'mcqPortal_mcqs',
            LOGGED_IN_USER: 'mcqPortal_loggedInUser'
        };

        const USER_ROLES = {
            ADMIN: 'admin',
            TEACHER: 'teacher',
            STUDENT: 'student'
        };

        const HARDCODED_ADMIN = {
            role: USER_ROLES.ADMIN,
            username: 'admin',
            password: 'admin123',
            name: 'HOI'
        };

        let currentUserId = null;
        let currentUserRole = null;

        // --- Data Helpers ---
        function getData(key, defaultValue = []) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error(`Error loading ${key}:`, e);
                return defaultValue;
            }
                 }

        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving ${key}:`, e);
            }
        }

        // --- Core Data Initialization ---
        function initData() {
            let users = getData(STORAGE_KEYS.USERS, [
                // Initial Sample Teacher
                { role: USER_ROLES.TEACHER, username: 'iqbal', password: 'pass', name: 'Mr. Iqbal Khan' },
                // Initial Sample Student (Total Points must be calculated/set)
                { role: USER_ROLES.STUDENT, username: 's101', password: '1111', name: 'Farooq Ahmad', class: '5', rollNo: '101', totalPoints: 10, points: { Math: 10, English: 0 }, answeredMCQs: [] }
            ]);
            // Ensure no duplicate initial users (especially if running multiple times)
            if (!users.find(u => u.username === 'iqbal')) {
                 users.push({ role: USER_ROLES.TEACHER, username: 'iqbal', password: 'pass', name: 'Mr. Iqbal Khan' });
            }
            saveData(STORAGE_KEYS.USERS, users);

            let mcqs = getData(STORAGE_KEYS.MCQS, [
                // Sample MCQ
                { id: 1, class: "5", subject: "Math", question: "What is 5 x 8?", options: { A: "40", B: "35", C: "45", D: "50" }, correct: "A", teacher: "iqbal", date: getTodayDate() },
                { id: 2, class: "5", subject: "English", question: "Identify the noun in the sentence: The quick fox jumped.", options: { A: "quick", B: "fox", C: "jumped", D: "The" }, correct: "B", teacher: "iqbal", date: getTodayDate() },
                { id: 3, class: "4", subject: "EVS", question: "Which planet is known as the Red Planet?", options: { A: "Earth", B: "Mars", C: "Venus", D: "Jupiter" }, correct: "B", teacher: "iqbal", date: getTodayDate() }
            ]);
            saveData(STORAGE_KEYS.MCQS, mcqs);

            // Check for existing session
            const loggedIn = getData(STORAGE_KEYS.LOGGED_IN_USER, null);
            if (loggedIn) {
                currentUserId = loggedIn.username;
                currentUserRole = loggedIn.role;
                renderDashboard(currentUserRole);
            } else {
                showScreen('login-screen');
            }
        }

        // --- Date Utility ---
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // ====================================================
        // JAVASCRIPT: VIEW MANAGEMENT & NAVIGATION
        // ====================================================

        function showScreen(screenId) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('teacher-panel').style.display = 'none';
            document.getElementById('student-panel').style.display = 'none';
            
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.style.display = 'block';
            }
        }

        function renderDashboard(role) {
            if (role === USER_ROLES.ADMIN) {
                showScreen('admin-panel');
                renderAdminPanel();
            } else if (role === USER_ROLES.TEACHER) {
                showScreen('teacher-panel');
                renderTeacherPanel();
            } else if (role === USER_ROLES.STUDENT) {
                showScreen('student-panel');
                renderStudentPanel();
            } else {
                showScreen('login-screen');
            }
        }

        function logout() {
            currentUserId = null;
            currentUserRole = null;
            saveData(STORAGE_KEYS.LOGGED_IN_USER, null);
            alert('Logged out successfully.');
            showScreen('login-screen');
            document.getElementById('login-form').reset();
        }
        
        function toggleSection(id) {
            const section = document.getElementById(id);
            if (section) {
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ====================================================
        // JAVASCRIPT: LOGIN SYSTEM (2)
        // ====================================================

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const role = document.getElementById('login-role').value;
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const messageEl = document.getElementById('login-message');

            messageEl.textContent = ''; // Clear previous messages

            if (!role || !username || !password) {
                messageEl.textContent = 'Please fill all fields.';
                return;
            }

            let user = null;

            if (role === USER_ROLES.ADMIN) {
                if (username === HARDCODED_ADMIN.username && password === HARDCODED_ADMIN.password) {
                    user = HARDCODED_ADMIN;
                }
            } else {
                const users = getData(STORAGE_KEYS.USERS);
                user = users.find(u => u.role === role && u.username === username && u.password === password);
            }

            if (user) {
                currentUserId = user.username;
                currentUserRole = user.role;
                saveData(STORAGE_KEYS.LOGGED_IN_USER, { username: currentUserId, role: currentUserRole });
                renderDashboard(currentUserRole);
            } else {
                messageEl.textContent = 'Login failed. Check your role, username/roll number, and password/PIN.';
            }
        });
        
        // Update labels based on selected role
        document.getElementById('login-role').addEventListener('change', (e) => {
            const role = e.target.value;
            const userLabel = document.getElementById('login-username-label');
            const passLabel = document.getElementById('login-password-label');
            if (role === USER_ROLES.STUDENT) {
                userLabel.textContent = 'Roll No:';
                passLabel.textContent = '4-digit PIN:';
            } else {
                userLabel.textContent = 'Username:';
                passLabel.textContent = 'Password:';
            }
        });


        // ====================================================
        // JAVASCRIPT: MASTER ADMIN PANEL (3)
        // ====================================================
    
function getAdminStats() {
            const users = getData(STORAGE_KEYS.USERS);
            const mcqs = getData(STORAGE_KEYS.MCQS);
            
            const totalTeachers = users.filter(u => u.role === USER_ROLES.TEACHER).length;
            const totalStudents = users.filter(u => u.role === USER_ROLES.STUDENT).length;
            const totalMCQs = mcqs.length;
            
            document.getElementById('stat-teachers').textContent = totalTeachers;
            document.getElementById('stat-students').textContent = totalStudents;
            document.getElementById('stat-mcqs').textContent = totalMCQs;
        }

        function renderAdminPanel() {
            if (currentUserRole !== USER_ROLES.ADMIN) return;
            document.getElementById('admin-welcome').textContent = `Welcome, HOI (${HARDCODED_ADMIN.name})!`;
            getAdminStats();
            renderTeacherListAdmin();
            renderStudentListAdmin();
        }

        // --- Teacher Management ---
        document.getElementById('form-add-teacher').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('add-teacher-name').value;
            const username = document.getElementById('add-teacher-username').value;
            const password = document.getElementById('add-teacher-password').value;

            let users = getData(STORAGE_KEYS.USERS);
            if (users.some(u => u.username === username)) {
                alert('Error: Username already exists.');
                return;
            }

            const newTeacher = {
                role: USER_ROLES.TEACHER,
                name,
                username,
                password
            };
            users.push(newTeacher);
            saveData(STORAGE_KEYS.USERS, users);
            alert(`Teacher ${name} added successfully!`);
            document.getElementById('form-add-teacher').reset();
            getAdminStats();
            renderTeacherListAdmin();
        });

        function removeUser(username) {
            if (!confirm(`Are you sure you want to remove user ${username}? This action is irreversible.`)) return;

            let users = getData(STORAGE_KEYS.USERS);
            const initialLength = users.length;
            users = users.filter(u => u.username !== username);

            if (users.length < initialLength) {
                saveData(STORAGE_KEYS.USERS, users);
                // Also remove any MCQs uploaded by this teacher (for safety)
                let mcqs = getData(STORAGE_KEYS.MCQS);
                mcqs = mcqs.filter(m => m.teacher !== username);
                saveData(STORAGE_KEYS.MCQS, mcqs);

                alert(`User ${username} removed successfully.`);
                getAdminStats();
                renderTeacherListAdmin();
                renderStudentListAdmin();
            } else {
                alert(`Error: Could not find user ${username}.`);
            }
        }

        function renderTeacherListAdmin() {
            const users = getData(STORAGE_KEYS.USERS);
            const teachers = users.filter(u => u.role === USER_ROLES.TEACHER);
            const listEl = document.getElementById('teacher-list-admin');
            listEl.innerHTML = '';

            if (teachers.length === 0) {
                listEl.innerHTML = '<p style="margin-top: 10px;">No teachers registered yet.</p>';
                return;
            }

            let html = `
                <table>
                    <thead><tr><th>Name</th><th>Username</th><th>Action</th></tr></thead>
                    <tbody>
            `;
            teachers.forEach(t => {
                html += `
                    <tr>
                        <td>${t.name}</td>
                        <td>${t.username}</td>
                        <td><button onclick="removeUser('${t.username}')" class="btn-danger">Remove</button></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listEl.innerHTML = html;
        }

        // --- Student Management ---
        document.getElementById('form-add-student').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('add-student-name').value;
            const sClass = document.getElementById('add-student-class').value;
            const rollNo = document.getElementById('add-student-rollno').value;
            const pin = document.getElementById('add-student-pin').value;

            let users = getData(STORAGE_KEYS.USERS);
            if (users.some(u => u.username === rollNo)) { // RollNo acts as Username
                alert('Error: Roll Number already exists as a user.');
                return;
            }
            if (!/^\d{4}$/.test(pin)) {
                alert('Error: PIN must be a 4-digit number.');
                return;
            }

            const newStudent = {
                role: USER_ROLES.STUDENT,
                name,
                username: rollNo, // Roll No is used as login username
                password: pin, // PIN is used as login password
                class: sClass,
                rollNo: rollNo,
                totalPoints: 0,
                points: {}, // { Subject: Points }
                answeredMCQs: [] // [MCQ_ID, ...] to prevent re-attempts
            };
            users.push(newStudent);
            saveData(STORAGE_KEYS.USERS, users);
            alert(`Student ${name} (Roll No: ${rollNo}, Class: ${sClass}) added successfully!`);
            document.getElementById('form-add-student').reset();
            getAdminStats();
            renderStudentListAdmin();
        });

        function renderStudentListAdmin() {
            const users = getData(STORAGE_KEYS.USERS);
            const students = users.filter(u => u.role === USER_ROLES.STUDENT);
            const listEl = document.getElementById('student-list-admin');
            listEl.innerHTML = '';

            if (students.length === 0) {
                listEl.innerHTML = '<p style="margin-top: 10px;">No students registered yet.</p>';
                return;
            }

            let html = `
                <table>
                    <thead><tr><th>Name (Roll No)</th><th>Class</th><th>Total Points</th><th>Action</th></tr></thead>
                    <tbody>
            `;
            students.sort((a, b) => (a.class - b.class) || (a.rollNo - b.rollNo));
            students.forEach(s => {
                html += `
                    <tr>
                        <td>${s.name} (${s.rollNo})</td>
                        <td>${s.class}</td>
                        <td>${s.totalPoints || 0}</td>
                        <td><button onclick="removeUser('${s.username}')" class="btn-danger">Remove</button></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listEl.innerHTML = html;
        }

        // ====================================================
        // JAVASCRIPT: TEACHER DASHBOARD (4)
        // ====================================================

        function getTeacher() {
            return getData(STORAGE_KEYS.USERS).find(u => u.username === currentUserId);
        }

        function renderTeacherPanel() {
            const teacher = getTeacher();
            if (!teacher) return logout();

            document.getElementById('teacher-welcome').textContent = `Welcome, Teacher ${teacher.name}!`;
            renderTeacherMCQList(teacher.username);
        }

        // --- MCQ Upload ---
        document.getElementById('form-upload-mcq').addEventListener('submit', (e) => {
            e.preventDefault();
            const teacher = getTeacher();
            if (!teacher) return;

            const mcqClass = document.getElementById('mcq-class').value;
            const subject = document.getElementById('mcq-subject').value.trim();
            const question = document.getElementById('mcq-question').value.trim();
            const correct = document.getElementById('mcq-correct').value;

            const options = {
                A: document.getElementById('mcq-option-a').value.trim(),
                B: document.getElementById('mcq-option-b').value.trim(),
                C: document.getElementById('mcq-option-c').value.trim(),
                D: document.getElementById('mcq-option-d').value.trim()
            };

            if (Object.values(options).some(opt => opt === '')) {
                alert('Please fill all option fields.');
                return;
            }

            let mcqs = getData(STORAGE_KEYS.MCQS);
            const newId = mcqs.length > 0 ? Math.max(...mcqs.map(m => m.id)) + 1 : 1;

            const newMCQ = {
                id: newId,
                class: mcqClass,
                subject: subject,
                question: question,
                options: options,
                correct: correct,
                teacher: teacher.username,
                date: getTodayDate()
            };

            mcqs.push(newMCQ);
            saveData(STORAGE_KEYS.MCQS, mcqs);

            document.getElementById('upload-message').style.color = 'var(--color-success)'; 
            document.getElementById('upload-message').textContent = `MCQ for Class ${mcqClass} (${subject}) uploaded successfully!`;
            document.getElementById('form-upload-mcq').reset();
            renderTeacherMCQList(teacher.username);
            getAdminStats(); // Update admin stat
        });

        // --- View My MCQs ---
        function renderTeacherMCQList(teacherUsername) {
            const mcqs = getData(STORAGE_KEYS.MCQS)
                .filter(m => m.teacher === teacherUsername)
                .sort((a, b) => b.id - a.id); // Latest first

            const listEl = document.getElementById('teacher-mcq-list');
            listEl.innerHTML = '';
            if (mcqs.length === 0) {
                listEl.innerHTML = '<p>You have not uploaded any MCQs yet.</p>';
                return;
            }

            // Group by date
            const mcqsByDate = mcqs.reduce((acc, mcq) => {
                (acc[mcq.date] = acc[mcq.date] || []).push(mcq);
                return acc;
            }, {});

            let html = '';
            for (const date in mcqsByDate) {
                const today = date === getTodayDate();
                const headerId = `mcq-header-${date.replace(/-/g, '')}`;
                const contentId = `mcq-content-${date.replace(/-/g, '')}`;
                
                html += `
                    <div class="card" style="margin-top: 15px; cursor: pointer;" onclick="toggleSection('${contentId}')">
                        <h3 style="color: ${today ? 'var(--color-gold)' : 'var(--color-teal)'};">
                            ${today ? 'üìÖ TODAY' : date} (${mcqsByDate[date].length} MCQs)
                        </h3>
                    </div>
                    <div id="${contentId}" style="display: ${today ? 'block' : 'none'}; padding: 10px;">
                `;

                mcqsByDate[date].forEach(m => {
                    html += `
                        <div class="mcq-item card" style="border-left-color: var(--color-gold);">
                            <p><strong>Class ${m.class} | Subject: ${m.subject}</strong></p>
                            <p class="mcq-question">${m.question}</p>
                            <ul>
                                <li>A: ${m.options.A}</li>
                                <li>B: ${m.options.B}</li>
                                <li>C: ${m.options.C}</li>
                                <li>D: ${m.options.D}</li>
                            </ul>
                            <p style="margin-top: 10px; color: var(--color-success);">
                                <strong>Correct Answer: ${m.correct}</strong>
                            </p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            listEl.innerHTML = html;
        }

        // ====================================================
        // JAVASCRIPT: STUDENT PANEL (5)
        // ====================================================

function getStudent() {
            const student = getData(STORAGE_KEYS.USERS).find(u => u.username === currentUserId);
            // Ensure student object has necessary properties for points/MCQs
            if (student) {
                student.totalPoints = student.totalPoints || 0;
                student.points = student.points || {};
                student.answeredMCQs = student.answeredMCQs || [];
            }
            return student;
        }
        
        function getStudentRank(student, leaderboard) {
            let rank = 'N/A';
            const students = getData(STORAGE_KEYS.USERS).filter(u => u.role === USER_ROLES.STUDENT);
            
            let sortedStudents = [];
            if (leaderboard === 'school') {
                sortedStudents = students.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
            } else if (leaderboard === 'class') {
                sortedStudents = students
                    .filter(s => s.class === student.class)
                    .sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
            }
            
            const myIndex = sortedStudents.findIndex(s => s.username === student.username);
            if (myIndex !== -1) {
                rank = myIndex + 1;
            }
            return rank;
        }

        function renderStudentPanel() {
            const student = getStudent();
            if (!student) return logout();

            const myRank = getStudentRank(student, 'school');

            document.getElementById('student-welcome').textContent = `Welcome, ${student.name} (Roll No: ${student.rollNo})!`;
            document.getElementById('student-class-stat').textContent = student.class;
            document.getElementById('student-class-display').textContent = student.class;
            document.getElementById('student-total-points').textContent = student.totalPoints || 0;
            document.getElementById('student-school-rank').textContent = myRank;
            
            renderTodaysMCQs(student);
            populateSubjectSelect();
            displayLeaderboard('school'); // Default leaderboard
        }

        // --- Today's MCQs ---
        function renderTodaysMCQs(student) {
            const allMcqs = getData(STORAGE_KEYS.MCQS);
            const todayDate = getTodayDate();
            
            const todaysMcqs = allMcqs
                .filter(m => m.class === student.class && m.date === todayDate)
                .sort((a, b) => a.id - b.id); // Sort by upload order

            const listEl = document.getElementById('todays-mcq-list');
            listEl.innerHTML = '';

            if (todaysMcqs.length === 0) {
                listEl.innerHTML = '<p>No assignments for your class today. Check back tomorrow!</p>';
                return;
            }

            todaysMcqs.forEach(mcq => {
                const isAnswered = student.answeredMCQs.includes(mcq.id);
                
                let optionsHtml = '';
                for (const key in mcq.options) {
                    const id = `mcq-${mcq.id}-opt-${key}`;
                    optionsHtml += `
                        <label for="${id}" class="mcq-option" ${isAnswered ? 'style="pointer-events: none; opacity: 0.7;"' : ''}>
                            <input type="radio" id="${id}" name="mcq-${mcq.id}" value="${key}" required ${isAnswered ? 'disabled' : ''}>
                            <span style="font-weight: bold;">${key}:</span> ${mcq.options[key]}
                        </label>
                    `;
                }
                
                let feedbackClass = '';
                let feedbackText = '';
                if (isAnswered) {
                    feedbackClass = 'correct';
                    feedbackText = 'You have already attempted this question and earned points.';
                }

                listEl.innerHTML += `
                    <div id="mcq-card-${mcq.id}" class="mcq-item card">
                        <p><strong>[${mcq.subject}]</strong> Uploaded by ${mcq.teacher} on ${mcq.date}</p>
                        <p class="mcq-question">${mcq.id}. ${mcq.question}</p>
                        <form id="mcq-form-${mcq.id}">
                            ${optionsHtml}
                            <button type="submit" ${isAnswered ? 'disabled' : ''}>Submit Answer</button>
                        </form>
                        <div id="mcq-feedback-${mcq.id}" class="mcq-feedback ${feedbackClass}" style="display: ${isAnswered ? 'block' : 'none'};">${feedbackText}</div>
                    </div>
                `;
            });

            // Add event listeners for all forms
            todaysMcqs.forEach(mcq => {
                const form = document.getElementById(`mcq-form-${mcq.id}`);
                if (form) {
                    form.addEventListener('submit', (e) => handleMcqSubmission(e, mcq));
                }
            });
        }

        function handleMcqSubmission(e, mcq) {
            e.preventDefault();
            const selectedOption = document.querySelector(`input[name="mcq-${mcq.id}"]:checked`);
            if (!selectedOption) return;

            const student = getStudent();
            if (student.answeredMCQs.includes(mcq.id)) {
                alert('You have already answered this question.');
                return;
            }

            const feedbackEl = document.getElementById(`mcq-feedback-${mcq.id}`);
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (selectedOption.value === mcq.correct) {
                // Correct Answer: +5 Points
                
                // 1. Update Student Data (in memory)
                student.totalPoints = (student.totalPoints || 0) + 5;
                student.points[mcq.subject] = (student.points[mcq.subject] || 0) + 5;
                student.answeredMCQs.push(mcq.id);
                
                // 2. Save Updated Student Data
                let users = getData(STORAGE_KEYS.USERS);
                const studentIndex = users.findIndex(u => u.username === student.username);
                if (studentIndex !== -1) {
                    users[studentIndex] = student;
                    saveData(STORAGE_KEYS.USERS, users);
                }

                // 3. Update UI
                feedbackEl.className = 'mcq-feedback correct';
                feedbackEl.textContent = 'WOW! Your response is correct üéâ +5 points';
                submitBtn.disabled = true;
                e.target.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
                
                // Re-render points/rank
                renderStudentPanel(); 
            } else {
                // Wrong Answer: 0 Points
                feedbackEl.className = 'mcq-feedback wrong';
                feedbackEl.textContent = 'Try again! Keep practicing üòä (0 points)';
            }

            feedbackEl.style.display = 'block';
        }

        // ====================================================
        // JAVASCRIPT: LEADERBOARDS (6)
        // ====================================================

        function getAllStudents() {
            return getData(STORAGE_KEYS.USERS)
                .filter(u => u.role === USER_ROLES.STUDENT)
                .map(s => ({
                    ...s,
                    totalPoints: s.totalPoints || 0,
                    points: s.points || {}
                }));
        }

        function populateSubjectSelect() {
            const mcqs = getData(STORAGE_KEYS.MCQS);
            const subjects = [...new Set(mcqs.map(m => m.subject))]; // Get unique subjects
            const selectEl = document.getElementById('leaderboard-subject-select');
            
            // Keep default option, clear others
            selectEl.innerHTML = '<option value="">-- Select Subject --</option>'; 
            
            subjects.forEach(subject => {
                selectEl.innerHTML += `<option value="${subject}">${subject}</option>`;
            });
        }

        function displayLeaderboard(type, subject = null) {
            const student = getStudent(); // Current logged-in student
            const allStudents = getAllStudents();
            let leaderboardData = [];
            let title = '';

            if (type === 'school') {
                title = 'üèÜ School-wide Leaderboard (All Classes)';
                leaderboardData = allStudents
                    .sort((a, b) => b.totalPoints - a.totalPoints)
                    .slice(0, 10); // Top 10
            } else if (type === 'class') {
                if (!student) return;
                title = `üèÖ Class ${student.class} Leaderboard`;
                leaderboardData = allStudents
                    .filter(s => s.class === student.class)
                    .sort((a, b) => b.totalPoints - a.totalPoints);
            } else if (type === 'subject' && subject) {
                title = `üß† ${subject} Leaderboard`;
                leaderboardData = allStudents
                    .map(s => ({
                        ...s,
                        subjectPoints: s.points[subject] || 0 // Get points for specific subject
                    }))
                    .filter(s => s.subjectPoints > 0)
                    .sort((a, b) => b.subjectPoints - a.subjectPoints);
            } else {
                return; // Do nothing if subject is not selected for subject-wise
            }

            const listEl = document.getElementById('leaderboard-display');
            listEl.innerHTML = `<h3>${title}</h3>`;

            if (leaderboardData.length === 0) {
                listEl.innerHTML += '<p style="margin-top: 10px;">No data available for this leaderboard yet.</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Roll No</th>
                            <th>${type === 'subject' ? 'Points (' + subject + ')' : 'Total Points'}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            leaderboardData.forEach((s, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'gold';
                else if (rank === 2) rankClass = 'silver';
                else if (rank === 3) rankClass = 'bronze';

                const isCurrentUser = student && s.username === student.username;
                const highlightClass = isCurrentUser ? 'user-highlight' : '';

                html += `
                    <tr class="${rankClass} ${highlightClass}">
                        <td>${rank} ${rank <= 3 ? '‚òÖ' : ''}</td>
                        <td>${s.name}</td>
                        <td>${s.class}</td>
                        <td>${s.rollNo}</td>
                        <td>${type === 'subject' ? s.subjectPoints : s.totalPoints}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            listEl.innerHTML += html;
        }

        // Subject dropdown change handler
        document.getElementById('leaderboard-subject-select').addEventListener('change', (e) => {
            const subject = e.target.value;
            if (subject) {
                displayLeaderboard('subject', subject);
            } else {
                document.getElementById('leaderboard-display').innerHTML = '<p style="margin-top: 20px;">Please select a subject.</p>';
            }
        });

        // ====================================================
        // JAVASCRIPT: INITIALIZATION
        // ====================================================

        document.addEventListener('DOMContentLoaded', initData);

    </script>
</body>
</html
    .
