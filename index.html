<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pethgam Wagoora — Winter Assignment Portal (C3)</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
:root{--bg:#0d1117;--muted:#9ca3af}
body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#d1d5db;margin:0;min-height:100vh}
.portal-card{background-image:linear-gradient(135deg, rgba(253,224,71,0.06), rgba(96,165,250,0.04));border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.4)}
.portal-btn{transition:all .2s ease}
.ticker-wrap{width:100%;overflow:hidden;background:#fcd34d;color:#1f2937}
.ticker{display:inline-block;white-space:nowrap;padding-left:100%;animation:ticker 18s linear infinite}
@keyframes ticker{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-100%,0,0)}}
.snow-container{position:fixed;inset:0;pointer-events:none;z-index:5;overflow:hidden}
.snowflake{position:absolute;width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.85);opacity:.9;filter:blur(.2px)}
.toast{position:fixed;right:1rem;top:4rem;z-index:60;padding:.75rem 1rem;border-radius:.5rem;color:#fff;box-shadow:0 8px 30px rgba(0,0,0,.4)}
.input, .btn-primary{width:100%}
.input{padding:.6rem;border-radius:.6rem;background:#111827;border:1px solid rgba(255,255,255,0.04);color:#e6eef8}
.btn-primary{background:#3b82f6;color:#fff;padding:.6rem;border-radius:.6rem}
.small-muted{color:var(--muted);font-size:.9rem}
</style>
</head>
<body class="flex flex-col min-h-screen">

<!-- Snow -->
<div class="snow-container" id="snow-container"></div>

<!-- Ticker -->
<div class="ticker-wrap">
  <div class="ticker px-4 py-2" id="notification-ticker">
    Winter Vacation Assignment Released Today &nbsp;&nbsp; | &nbsp;&nbsp;
    New Online Quiz Available &nbsp;&nbsp; | &nbsp;&nbsp; Check the Leaderboard!
  </div>
</div>

<header class="p-6 text-center z-20 relative">
  <h1 class="text-3xl md:text-4xl font-extrabold text-yellow-300">Winter Assignment Portal</h1>
  <p class="text-blue-300 mt-1">Government Primary School Pethgam Wagoora</p>
</header>

<main class="flex-grow flex items-start justify-center p-6">
  <div id="app" class="w-full max-w-5xl portal-card p-6">
    <div id="content-view" class="">
      <div class="flex flex-col items-center justify-center p-8 text-center">
        <svg class="animate-spin h-8 w-8 text-blue-400 mb-4" viewBox="0 0 24 24" fill="none">
          <path d="M12 4.75V6.25M17.127 6.873l-1.061 1.061M19.25 12h-1.5M17.127 17.127l-1.061-1.061M12 17.75v1.5M7.934 16.066l-1.061 1.061M6.25 12h-1.5M7.934 7.934l-1.061-1.061" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <p class="text-blue-300 font-semibold">Initializing Portal and connecting to database...</p>
      </div>
    </div>
  </div>
</main>

<footer class="text-center text-xs p-4 border-t border-gray-700/40">
  <p class="text-gray-400 mb-1">Designed & Developed by Mohammad Ashraf Rather</p>
  <p class="text-gray-500">Government Primary School Pethgam Wagoora | Winter Assignment Portal 2025</p>
  <p class="text-gray-600 mt-2">User ID: <span id="footer-user-id">N/A</span> | App ID: <span id="footer-app-id">N/A</span></p>
</footer>

<!-- Toast container -->
<div id="toast-area"></div>

<!-- Snow script -->
<script>
(function generateSnow(){
  const container = document.getElementById('snow-container');
  for(let i=0;i<40;i++){
    const s = document.createElement('div');
    s.className='snowflake';
    s.style.left = Math.random()*100 + '%';
    s.style.top = (-10 - Math.random()*20) + 'vh';
    s.style.opacity = (0.4 + Math.random()*0.6).toString();
    s.style.transform = `translateY(${Math.random()*5}vh)`;
    const dur = 6 + Math.random()*10;
    s.style.animation = `fall ${dur}s linear infinite`;
    s.style.width = (4 + Math.random()*6) + 'px';
    s.style.height = s.style.width;
    container.appendChild(s);
  }
})();
</script>

<!-- Main Firebase + App Script -->
<script type="module">
/* =================================================
   FULL PORTAL SCRIPT — Option C3 (All-in-one)
   Uses Firebase JS Modules v11.6.1
   Firestore paths: artifacts/{appId}/public/data/{collection}/{docId}
   ================================================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs,
  onSnapshot, query, where, updateDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* -------------------------
   Config & Globals
   ------------------------- */
const appId = (typeof __app_id !== 'undefined') ? __app_id : 'gspw-portal-default-id';
document.getElementById('footer-app-id').textContent = appId;

let firebaseConfig = {};
const hardcodedConfig = {
  apiKey: "AIzaSyCBLLmzxVYuivT15HBPPSxMoS2OzojRgJM",
  authDomain: "wap-ps-pethgam.firebaseapp.com",
  databaseURL: "https://wap-ps-pethgam-default-rtdb.firebaseio.com",
  projectId: "wap-ps-pethgam",
  storageBucket: "wap-ps-pethgam.firebasestorage.app",
  messagingSenderId: "430925411362",
  appId: "1:430925411362:web:22857dee585d02fc54467b"
};

try {
  firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : hardcodedConfig;
} catch(e){
  console.error("Invalid __firebase_config JSON, using fallback.", e);
  firebaseConfig = hardcodedConfig;
}

/* Firestore base path builder (valid odd segments) */
const baseDataPath = (col) => `artifacts/${appId}/public/data/${col}`;

/* App state */
let app, db, auth;
let currentUser = null;
let users = [], assignments = [], notifications = [], mcqs = [];
let isPublicReady = false;

/* Mandatory test users (idempotent seed) */
const mandatoryTestUsers = [
  { role: "Admin", username: "admin@school.com", pin: "1234", status: "Approved", class: null, school: "G.P.S Pethgam Wagoora", score: 999 },
  { role: "Teacher", username: "teacher@school.com", pin: "5678", status: "Approved", class: 5, school: "G.P.S Pethgam Wagoora", score: 0 },
  { role: "Student", username: "student@school.com", pin: "0000", status: "Approved", class: 5, school: "G.P.S Pethgam Wagoora", score: 85 }
];

/* -------------------------
   Small UI helpers
   ------------------------- */
function toast(type, title, text, ms = 3000) {
  const area = document.getElementById('toast-area');
  const el = document.createElement('div');
  el.className = 'toast';
  el.style.background = (type === 'error') ? '#ef4444' : (type === 'info' ? '#0284c7' : '#16a34a');
  el.innerHTML = `<strong>${title}</strong><div style="font-size:.9rem;margin-top:.2rem">${text}</div>`;
  area.appendChild(el);
  setTimeout(()=>{ el.style.transform='translateX(120%)'; el.style.opacity='0'; setTimeout(()=>el.remove(),400); }, ms);
}

/* Quick helper to render HTML into content-view */
function mount(html) { document.getElementById('content-view').innerHTML = html; }

/* -------------------------
   Initialize Firebase + Auth
   ------------------------- */
async function init() {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    console.log('Firebase initialized.');
    setupPublicListeners();

    // Auth flow: anonymous or custom token if provided
    const initialAuthToken = (typeof __initial_auth_token !== 'undefined') ? __initial_auth_token : null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
            console.log('Signed in with custom token.');
          } else {
            await signInAnonymously(auth);
            console.log('Signed in anonymously.');
          }
        } catch (err) {
          console.warn('Auth failed', err);
          render('login');
        }
      } else {
        console.log('Auth state ready, uid:', user.uid);
        document.getElementById('footer-user-id').textContent = user.uid;
        // Attempt to find profile (if exists) and redirect appropriately
        findAndRedirectUser(user.uid);
      }
    });

    // render homepage while things load
    render('homepage');

  } catch (err) {
    console.error('Init error', err);
    mount(`<div class="p-6 text-center"><h2 class="text-red-400">Initialization failed</h2><p class="small-muted">${err.message}</p></div>`);
  }
}

/* -------------------------
   Public listeners (assignments, mcqs, notifications, users)
   ------------------------- */
function setupPublicListeners() {
  if (isPublicReady) return;

  const assignmentsCol = collection(db, baseDataPath('assignments'));
  const mcqsCol = collection(db, baseDataPath('mcqs'));
  const notifyCol = collection(db, baseDataPath('notifications'));
  const usersCol = collection(db, baseDataPath('users'));

  onSnapshot(assignmentsCol, snap => {
    assignments = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    if (currentViewIs(['teacher','student'])) render(currentViewName());
  });

  onSnapshot(mcqsCol, snap => {
    mcqs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  });

  onSnapshot(notifyCol, snap => {
    notifications = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=>b.timestamp - a.timestamp);
    updateTicker();
  });

  onSnapshot(usersCol, snap => {
    users = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    ensureSeedUsers();
  });

  isPublicReady = true;
}

/* -------------------------
   Ensure mandatory seed users exist (idempotent)
   ------------------------- */
async function ensureSeedUsers() {
  for (const u of mandatoryTestUsers) {
    const uid = u.username.replace(/[^a-zA-Z0-9]/g,'_');
    const ref = doc(db, baseDataPath('users'), uid);
    const s = await getDoc(ref);
    if (!s.exists()) {
      await setDoc(ref, { ...u, uid, timestamp: Date.now() });
      console.log('Seed user created:', u.username);
    }
  }
}

/* -------------------------
   Utility: current view state
   ------------------------- */
let __currentView = 'initializing';
function currentViewName(){ return __currentView; }
function currentViewIs(list){ return list.includes(__currentView); }
function render(name){ __currentView = name; switch(name){
  case 'homepage': return mount(renderHomepage());
  case 'login': return mount(renderLogin());
  case 'signup': return mount(renderSignup());
  case 'admin': return mount(renderAdminDashboard());
  case 'teacher': return mount(renderTeacherDashboard());
  case 'student': return mount(renderStudentDashboard());
  case 'leaderboard': return mount(renderLeaderboard());
  default: return mount(`<div class="p-6 text-center">View not found</div>`);
}}

/* -------------------------
   Find user doc by auth uid and redirect
   ------------------------- */
async function findAndRedirectUser(uid) {
  // User documents are stored under artifacts/{appId}/public/data/users/{docId}
  // Our app maps user documents by sanitized username; however some systems may store by auth uid.
  // We'll try both strategies: first doc id by uid, then search for a document where doc.uid == uid.
  const userDocRef = doc(db, baseDataPath('users'), uid);
  const snap = await getDoc(userDocRef);
  if (snap.exists()) {
    currentUser = snap.data();
    redirectByRole(currentUser.role);
    return;
  }
  // fallback: search users collection for a doc with uid == uid
  const usersCol = collection(db, baseDataPath('users'));
  const q = query(usersCol, where('uid','==',uid));
  const qsnap = await getDocs(q);
  if (!qsnap.empty) {
    const d = qsnap.docs[0];
    currentUser = { id:d.id, ...d.data() };
    redirectByRole(currentUser.role);
    return;
  }
  // no profile -> remain on homepage/login/signup flows
  currentUser = null;
  render('homepage');
}

/* -------------------------
   Redirect helper
   ------------------------- */
function redirectByRole(role){
  if (!role) return render('homepage');
  if (role === 'Admin') render('admin');
  else if (role === 'Teacher') render('teacher');
  else if (role === 'Student') render('student');
  else render('homepage');
}

/* -------------------------
   UI Renderers (homepage, login, signup, leaderboards, dashboards)
   ------------------------- */

function renderHomepage(){
  return `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="col-span-1 md:col-span-2">
        <div class="portal-card p-6">
          <h2 class="text-2xl text-yellow-300 font-bold">Welcome to the Winter Assignment Portal</h2>
          <p class="small-muted mt-2">Enjoy learning, submit assignments, attempt quizzes, and climb the leaderboard.</p>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
            <button class="portal-btn btn-primary" onclick="render('login')">Login</button>
            <button class="portal-btn bg-green-600 text-white px-4 py-2 rounded-xl" onclick="render('signup')">Sign Up</button>
            <button class="portal-btn bg-yellow-500 text-gray-900 px-4 py-2 rounded-xl" onclick="render('leaderboard')">Leaderboard</button>
          </div>
        </div>

        <div class="portal-card p-4 mt-6">
          <h3 class="text-lg font-semibold text-blue-300">Latest Assignments</h3>
          <div id="home-assignments" class="mt-3">
            ${assignments.length? assignments.slice(0,5).map(a=>`<div class="p-3 border-b border-gray-700"><strong>${a.title}</strong><div class="small-muted">${a.description||''}</div></div>`).join('') : '<p class="small-muted p-3">No assignments yet.</p>'}
          </div>
        </div>
      </div>

      <div class="portal-card p-4">
        <h3 class="text-lg font-semibold text-yellow-300">Notifications</h3>
        <div class="mt-3" id="home-notifications">
          ${notifications.length ? notifications.slice(0,6).map(n=>`<div class="p-2 border-b border-gray-700 small-muted">${n.message}</div>`).join('') : '<p class="small-muted p-2">No notifications yet.</p>'}
        </div>
      </div>
    </div>
  `;
}

/* -------------------------
   Login renderer + events
   ------------------------- */
function renderLogin(){
  return `
    <div class="max-w-md mx-auto p-6 portal-card">
      <h2 class="text-2xl font-bold text-blue-300">Login</h2>
      <form id="form-login" class="mt-4 space-y-3">
        <label class="small-muted">Role</label>
        <select id="login-role" class="input"><option>Student</option><option>Teacher</option><option>Admin</option></select>
        <label class="small-muted">Username (email or id)</label>
        <input id="login-username" class="input" placeholder="e.g. student@school.com" />
        <label class="small-muted">PIN</label>
        <input id="login-pin" type="password" class="input" placeholder="4-digit PIN" />
        <div id="login-error" class="text-red-400 text-sm hidden"></div>
        <button class="btn-primary">Login</button>
      </form>
      <p class="small-muted mt-3">New? <button class="text-blue-300" onclick="render('signup')">Sign up</button></p>
    </div>
  `;
}

async function setupLogin() {
  const form = document.getElementById('form-login');
  if (!form) return;
  form.onsubmit = async (e) => {
    e.preventDefault();
    const role = document.getElementById('login-role').value;
    const username = document.getElementById('login-username').value.trim();
    const pin = document.getElementById('login-pin').value.trim();
    const err = document.getElementById('login-error');
    err.classList.add('hidden');

    if (!username || !pin) { err.textContent='Fill all fields'; err.classList.remove('hidden'); return; }

    const uid = username.replace(/[^a-zA-Z0-9]/g,'_');
    const ref = doc(db, baseDataPath('users'), uid);
    let snap = await getDoc(ref);

    // If seed user missing, try seeding
    if (!snap.exists()) {
      if (mandatoryTestUsers.some(u=>u.username===username)) {
        await ensureSeedUsers();
        snap = await getDoc(ref);
      }
    }

    if (!snap.exists()) { err.textContent='User not found'; err.classList.remove('hidden'); return; }
    const user = snap.data();
    if (user.role !== role || user.pin !== pin) { err.textContent='Invalid credentials'; err.classList.remove('hidden'); return; }
    if (user.status !== 'Approved') { err.textContent='Account not approved yet'; err.classList.remove('hidden'); return; }

    currentUser = { ...user, id: snap.id };
    toast('success','Logged in', `Welcome ${currentUser.username}`, 2200);
    redirectByRole(currentUser.role);
  };
}

/* -------------------------
   Signup renderer + events
   ------------------------- */
function renderSignup(){
  return `
    <div class="max-w-md mx-auto p-6 portal-card">
      <h2 class="text-2xl font-bold text-green-300">Sign Up</h2>
      <form id="form-signup" class="mt-4 space-y-3">
        <label class="small-muted">Role</label>
        <select id="signup-role" class="input"><option>Student</option><option>Teacher</option></select>
        <div id="signup-class-row" class="hidden">
          <label class="small-muted">Class</label>
          <select id="signup-class" class="input">${Array.from({length:8},(_,i)=>`<option>${i+1}</option>`).join('')}</select>
        </div>
        <label class="small-muted">School</label>
        <select id="signup-school" class="input">${['G.P.S Pethgam Wagoora','G.P.S Kandi','G.P.S Bonigam'].map(s=>`<option>${s}</option>`).join('')}</select>
        <label class="small-muted">Username (email/id)</label>
        <input id="signup-username" class="input" placeholder="example@school.com" />
        <label class="small-muted">4-digit PIN</label>
        <input id="signup-pin" class="input" maxlength="4" />
        <div id="signup-error" class="text-red-400 text-sm hidden"></div>
        <button class="bg-green-500 text-white py-2 rounded-xl w-full">Submit for Approval</button>
      </form>
      <p class="small-muted mt-3">Already have an account? <button class="text-blue-300" onclick="render('login')">Login</button></p>
    </div>
  `;
}

function setupSignup() {
  const form = document.getElementById('form-signup');
  if (!form) return;
  const roleEl = document.getElementById('signup-role');
  const classRow = document.getElementById('signup-class-row');

  roleEl.onchange = ()=> {
    classRow.classList.toggle('hidden', roleEl.value!=='Student');
  };

  form.onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById('signup-username').value.trim();
    const pin = document.getElementById('signup-pin').value.trim();
    const role = document.getElementById('signup-role').value;
    const sclass = (role==='Student')? document.getElementById('signup-class').value : null;
    const school = document.getElementById('signup-school').value;
    const err = document.getElementById('signup-error');
    err.classList.add('hidden');

    if (!username || !pin || pin.length!==4) { err.textContent='Fill fields correctly (PIN must be 4 digits)'; err.classList.remove('hidden'); return; }

    const uid = username.replace(/[^a-zA-Z0-9]/g,'_');
    const ref = doc(db, baseDataPath('users'), uid);
    const s = await getDoc(ref);
    if (s.exists()) { err.textContent='Username already exists'; err.classList.remove('hidden'); return; }

    const data = { uid, username, pin, role, class: sclass, school, status:'Pending', score:0, rank:0, timestamp: Date.now() };
    await setDoc(ref, data);
    toast('info','Submitted','Signup submitted — awaiting admin approval',2500);
    render('login');
  };
}

/* -------------------------
   Leaderboard
   ------------------------- */
function renderLeaderboard(){
  // sort users by score desc
  const sorted = [...users].filter(u=>u.status==='Approved').sort((a,b)=> (b.score||0) - (a.score||0));
  return `
    <div class="portal-card p-4">
      <h2 class="text-xl font-bold text-yellow-300">Leaderboard</h2>
      <ol class="mt-4 space-y-2">
        ${sorted.slice(0,20).map((u,i)=>`<li class="p-2 rounded ${i===0? 'bg-yellow-300 text-gray-900':''}">${i+1}. ${u.username} — ${u.score||0} pts</li>`).join('')}
      </ol>
    </div>
  `;
}

/* -------------------------
   Admin Dashboard (Approve/Reject, post notifications, create assignment)
   ------------------------- */
function renderAdminDashboard(){
  if (!currentUser || currentUser.role!=='Admin') return render('homepage');
  const pending = users.filter(u=>u.status==='Pending');

  return `
    <div class="space-y-6">
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-red-400">Admin Dashboard</h2>
        <div>
          <button class="portal-btn bg-gray-700 text-white px-3 py-1 rounded mr-2" onclick="render('homepage')">Home</button>
          <button class="portal-btn bg-red-600 text-white px-3 py-1 rounded" onclick="handleLogout()">Logout</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div class="portal-card p-4">
          <h3 class="text-lg font-semibold text-yellow-300">Pending Signups (${pending.length})</h3>
          <ul class="mt-3 space-y-2">
            ${pending.map(u=>`<li class="flex justify-between items-center p-2 border rounded"><div><strong>${u.username}</strong><div class="small-muted">${u.role} • ${u.school} • ${u.class||'N/A'}</div></div><div><button onclick="handleUserApproval('${u.uid}','Approved')" class="bg-green-600 text-white px-3 py-1 rounded mr-2">Approve</button><button onclick="handleUserApproval('${u.uid}','Rejected')" class="bg-red-600 text-white px-3 py-1 rounded">Reject</button></div></li>`).join('')}
          </ul>
        </div>

        <div class="portal-card p-4">
          <h3 class="text-lg font-semibold text-blue-300">Post Notification</h3>
          <form id="form-post-notify" class="mt-3 space-y-2">
            <input name="msg" placeholder="Message..." class="input" required />
            <button class="bg-blue-500 text-white py-2 rounded w-full">Post</button>
          </form>

          <h3 class="text-lg font-semibold text-blue-300 mt-4">Create Assignment</h3>
          <form id="form-create-assignment" class="mt-3 space-y-2">
            <input id="assign-title" placeholder="Title" class="input" required />
            <textarea id="assign-desc" placeholder="Description" class="input"></textarea>
            <button class="bg-green-500 text-white py-2 rounded w-full">Create Assignment</button>
          </form>
        </div>
      </div>
    </div>
  `;
}

/* -------------------------
   Setup admin events
   ------------------------- */
function setupAdmin() {
  const notifyForm = document.getElementById('form-post-notify');
  if (notifyForm) {
    notifyForm.onsubmit = async (e) => {
      e.preventDefault();
      const msg = e.target.msg.value.trim();
      if (!msg) return;
      await addDoc(collection(db, baseDataPath('notifications')), { message: msg, timestamp: Date.now() });
      toast('success','Posted','Notification posted');
      e.target.reset();
    };
  }

  const assignForm = document.getElementById('form-create-assignment');
  if (assignForm){
    assignForm.onsubmit = async (e)=>{
      e.preventDefault();
      const title = document.getElementById('assign-title').value.trim();
      const desc = document.getElementById('assign-desc').value.trim();
      if (!title) return toast('error','Error','Title required');
      await addDoc(collection(db, baseDataPath('assignments')), { title, description: desc, timestamp: Date.now() });
      toast('success','Created','Assignment created');
      e.target.reset();
    };
  }
}

/* -------------------------
   Teacher Dashboard (create assignments + view students)
   ------------------------- */
function renderTeacherDashboard(){
  if (!currentUser || currentUser.role!=='Teacher') return render('homepage');
  const students = users.filter(u=>u.role==='Student' && u.school === currentUser.school);
  return `
    <div class="space-y-6">
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-blue-300">Teacher Dashboard</h2>
        <div>
          <button class="portal-btn bg-gray-700 text-white px-3 py-1 rounded mr-2" onclick="render('homepage')">Home</button>
          <button class="portal-btn bg-red-600 text-white px-3 py-1 rounded" onclick="handleLogout()">Logout</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div class="portal-card p-4">
          <h3 class="text-lg font-semibold text-yellow-300">Create Assignment</h3>
          <form id="teacher-create-assign" class="mt-3 space-y-2">
            <input id="t-assign-title" placeholder="Title" class="input" required />
            <textarea id="t-assign-desc" placeholder="Description" class="input"></textarea>
            <button class="bg-green-500 text-white py-2 rounded w-full">Create</button>
          </form>
        </div>

        <div class="portal-card p-4">
          <h3 class="text-lg font-semibold text-blue-300">My Students (${students.length})</h3>
          <ul class="mt-3 space-y-2">${students.map(s=>`<li class="p-2 border rounded">${s.username} • Score: ${s.score||0}</li>`).join('')}</ul>
        </div>
      </div>
    </div>
  `;
}

function setupTeacher(){
  const form = document.getElementById('teacher-create-assign');
  if (!form) return;
  form.onsubmit = async (e)=>{
    e.preventDefault();
    const title = document.getElementById('t-assign-title').value.trim();
    const desc = document.getElementById('t-assign-desc').value.trim();
    if (!title) return toast('error','Error','Title required');
    await addDoc(collection(db, baseDataPath('assignments')), { title, description: desc, createdBy: currentUser.uid || currentUser.username, timestamp: Date.now() });
    toast('success','Created','Assignment created');
    e.target.reset();
  };
}

/* -------------------------
   Student Dashboard (view assignments)
   ------------------------- */
function renderStudentDashboard(){
  if (!currentUser || currentUser.role!=='Student') return render('homepage');
  const myAssignments = assignments.slice().sort((a,b)=>b.timestamp - a.timestamp);
  return `
    <div class="space-y-4">
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-green-300">Student Dashboard</h2>
        <div>
          <button class="portal-btn bg-gray-700 text-white px-3 py-1 rounded mr-2" onclick="render('homepage')">Home</button>
          <button class="portal-btn bg-red-600 text-white px-3 py-1 rounded" onclick="handleLogout()">Logout</button>
        </div>
      </div>

      <div class="portal-card p-4">
        <h3 class="text-lg font-semibold text-yellow-300">Assignments</h3>
        <ul class="mt-3 space-y-2">
          ${myAssignments.length ? myAssignments.map(a=>`<li class="p-3 border rounded"><strong>${a.title}</strong><div class="small-muted">${a.description||''}</div></li>`).join('') : '<li class="small-muted p-3">No assignments yet.</li>'}
        </ul>
      </div>
    </div>
  `;
}

/* -------------------------
   Auth helpers: logout
   ------------------------- */
function handleLogout(){
  // For this example, we just unset currentUser and show homepage. For production, call signOut(auth)
  currentUser = null;
  toast('info','Logged out','You have been logged out.');
  render('homepage');
}

/* -------------------------
   Admin actions: approve/reject
   ------------------------- */
async function handleUserApproval(uid, status) {
  try {
    const ref = doc(db, baseDataPath('users'), uid);
    await updateDoc(ref, { status });
    toast('success','Success',`User ${status}`);
  } catch (e) {
    toast('error','Error', e.message);
  }
}

/* -------------------------
   Utilities: update notification ticker
   ------------------------- */
function updateTicker(){
  const el = document.getElementById('notification-ticker');
  if (!el) return;
  el.innerHTML = notifications.slice(0,6).map(n=>n.message).join(' &nbsp;&nbsp; | &nbsp;&nbsp; ');
}

/* -------------------------
   On render hook: attach event handlers after HTML mounts
   ------------------------- */
function attachViewHooks() {
  // Common: if login view present
  if (document.getElementById('form-login')) setupLogin();
  if (document.getElementById('form-signup')) setupSignup();
  if (document.getElementById('form-post-notify') || document.getElementById('form-create-assignment')) setupAdmin();
  if (document.getElementById('teacher-create-assign')) setupTeacher();
}

/* -------------------------
   Observe DOM mutations to attach events after mount
   ------------------------- */
const observer = new MutationObserver(()=> attachViewHooks());
observer.observe(document.getElementById('content-view'), { childList:true, subtree:true });

/* -------------------------
   Initial call
   ------------------------- */
init();

/* Expose some functions to global (for inline onclicks)
   Note: in a module scope they won't be global by default, so attach needed ones:
*/
window.render = render;
window.handleLogout = handleLogout;
window.handleUserApproval = handleUserApproval;
window.currentUser = () => currentUser;

</script>

</body>
</html>
    
