<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Winter Assignment Portal â€” Zone Wagoora</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#e6f0ff 0%, #ffffff 100%); }
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); border-radius: 12px; box-shadow: 0 6px 24px rgba(8,20,40,0.08); }
    .marquee { white-space: nowrap; overflow:hidden; }
    .marquee p { display: inline-block; padding-left:100%; animation: marquee 18s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(0%);} 100% { transform: translateX(-100%);} }
    .hidden { display:none !important; }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- Top marquee area -->
  <div id="notification-bar" class="glass p-3 mb-4">
    <div class="flex items-center justify-between">
      <div class="font-semibold text-slate-700">Winter Assignment Portal â€” Zone Wagoora</div>
      <div class="text-sm text-gray-600">v12</div>
    </div>
    <div class="mt-2 h-8 marquee bg-white/30 rounded p-2 flex items-center">
      <p id="notification-marquee">Welcome to Winter Assignment Portal</p>
    </div>
  </div>

  <!-- Main layout -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <!-- Left column: Auth / profile / nav -->
    <div class="col-span-1 glass p-4">
      <div id="auth-card">
        <h3 class="text-lg font-semibold mb-2">Login</h3>

        <!-- Error message -->
        <div id="error-message" class="text-sm text-red-600 mb-2"></div>

        <form id="login-form" class="space-y-2">
          <label class="block text-sm">Login as</label>
          <select id="role-select" class="p-2 border rounded w-full">
            <option value="">-- Select Role --</option>
            <option value="Admin">Admin</option>
            <option value="Teacher">Teacher</option>
            <option value="Student">Student</option>
          </select>

          <input id="username-input" placeholder="Username" required class="w-full border p-2 rounded" />
          <input id="pin-input" placeholder="4-6 digit PIN" type="password" required class="w-full border p-2 rounded" />
          <div class="flex gap-2">
            <button type="submit" class="bg-blue-600 text-white px-3 py-2 rounded">Login</button>
            <button id="show-signup-btn" type="button" class="bg-green-600 text-white px-3 py-2 rounded">Sign Up</button>
            <button id="logout-btn" type="button" class="ml-auto text-sm text-gray-600 hidden">Logout</button>
          </div>
        </form>

        <!-- Signup form -->
        <div id="user-signup-container" class="mt-4 hidden">
          <h4 class="font-semibold">Sign up</h4>
          <form id="user-signup-form" class="space-y-2">
            <label class="text-sm">Role</label>
            <select id="user-signup-role" class="p-2 border rounded w-full">
              <option value="">-- Select Role --</option>
              <option value="Teacher">Teacher</option>
              <option value="Student">Student</option>
            </select>

            <input id="user-signup-username" placeholder="Username" class="w-full border p-2 rounded" />
            <input id="user-signup-pin" placeholder="4-6 digit PIN" class="w-full border p-2 rounded" />
            <div id="signup-class-field" class="hidden">
              <label class="text-sm">Class</label>
              <select id="user-signup-class" class="w-full border p-2 rounded"></select>
            </div>
            <label class="text-sm">School</label>
            <select id="user-signup-school" class="w-full border p-2 rounded"></select>

            <div class="flex gap-2">
              <button type="submit" class="bg-indigo-600 text-white px-3 py-2 rounded">Submit Signup</button>
              <button id="show-login-btn" type="button" class="px-3 py-2 rounded border">Back</button>
            </div>
            <div id="signup-error-message" class="text-sm text-red-600"></div>
          </form>
        </div>
      </div>

      <!-- Quick info & leaderboard links -->
      <div id="profile-card" class="mt-4 hidden">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center text-white font-bold" id="avatar">A</div>
          <div>
            <div id="welcome-message" class="font-semibold"></div>
            <div id="profile-role" class="text-sm text-gray-600"></div>
          </div>
        </div>

        <div class="mt-3 space-y-2">
          <button id="nav-assignments" class="w-full text-left px-3 py-2 border rounded">Assignments / MCQs</button>
          <button id="nav-user-management" class="w-full text-left px-3 py-2 border rounded hidden">User Management (Admin)</button>
          <button id="nav-add-mcqs" class="w-full text-left px-3 py-2 border rounded hidden">Add MCQs (Teacher)</button>
          <button id="nav-leaderboard" class="w-full text-left px-3 py-2 border rounded">Leaderboards</button>
          <button id="nav-location" class="w-full text-left px-3 py-2 border rounded hidden">Location Controls</button>
        </div>

        <div class="mt-3">
          <button id="open-profile-logout" class="w-full bg-red-500 text-white px-3 py-2 rounded hidden">Logout</button>
        </div>
      </div>

    </div>

    <!-- Middle columns: Main content -->
    <div class="col-span-1 md:col-span-2 glass p-4">
      <!-- Assignments / MCQs / dashboards will render here -->
      <div id="main-content">
        <!-- Public landing -->
        <div id="landing-view" class="">
          <h2 class="text-xl font-semibold">Welcome to Winter Assignment Portal â€” Zone Wagoora</h2>
          <p class="mt-2 text-sm text-gray-600">Login to access Admin, Teacher, or Student dashboards.</p>
        </div>

        <!-- Assignments / Teacher / Student view -->
        <div id="assignments-view" class="hidden">
          <!-- Teacher add MCQ form (shows for teacher/admin) -->
          <div id="teacher-view" class="hidden mb-4">
            <h3 class="font-semibold">Add MCQ</h3>
            <form id="assignment-form" class="space-y-2">
              <div class="grid grid-cols-2 gap-2">
                <select id="assignment-class-select" class="p-2 border rounded"></select>
                <select id="assignment-subject-select" class="p-2 border rounded"></select>
              </div>
              <textarea id="mcq-question" placeholder="Write question here" class="w-full border p-2 rounded"></textarea>

              <div class="grid grid-cols-2 gap-2">
                <input id="opt1" placeholder="Option 1" class="border p-2 rounded" />
                <input id="opt2" placeholder="Option 2" class="border p-2 rounded" />
                <input id="opt3" placeholder="Option 3" class="border p-2 rounded" />
                <input id="opt4" placeholder="Option 4" class="border p-2 rounded" />
              </div>

              <label class="text-sm">Correct Option</label>
              <select id="correct-opt" class="p-2 border rounded w-full">
                <option value="">-- Select Correct Option --</option>
                <option value="1">Option 1</option>
                <option value="2">Option 2</option>
                <option value="3">Option 3</option>
                <option value="4">Option 4</option>
              </select>

              <div class="flex gap-2">
                <button id="save-mcq-btn" class="bg-green-600 text-white px-3 py-2 rounded">Save MCQ</button>
                <div id="mcq-status" class="text-sm text-gray-600 pt-2"></div>
              </div>

              <div id="teacher-mcq-list" class="mt-3"></div>
            </form>
          </div>

          <!-- Student view: Quiz player -->
          <div id="student-view" class="hidden mb-4">
            <h3 class="font-semibold">Take MCQs</h3>
            <div class="grid grid-cols-2 gap-2 mb-2">
              <select id="student-class-select" class="p-2 border rounded"></select>
              <select id="student-subject-select" class="p-2 border rounded"></select>
            </div>
            <button id="start-quiz-btn" class="bg-blue-600 text-white px-3 py-2 rounded">Start Quiz</button>

            <div id="quiz-area" class="mt-4 hidden">
              <div id="question-card" class="p-4 border rounded">
                <div id="question-text" class="font-semibold mb-2"></div>
                <div id="question-options" class="grid gap-2"></div>
                <div id="quiz-feedback" class="mt-2 font-medium"></div>
                <div class="mt-3">
                  <button id="next-question-btn" class="bg-indigo-600 text-white px-3 py-2 rounded hidden">Next</button>
                </div>
              </div>
            </div>

            <div class="mt-3 text-sm text-gray-700">
              <div>Coins: <span id="student-coins">0</span></div>
              <div>Trophy: <span id="student-trophy">â€”</span></div>
            </div>
          </div>
        </div>

        <!-- Admin User Management -->
        <div id="admin-management-view" class="hidden">
          <h3 class="font-semibold">Admin â€” User Management</h3>

          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Pending approvals -->
            <div class="p-3 border rounded">
              <h4 class="font-semibold">Pending Signups</h4>
              <div id="pending-list" class="mt-2"></div>
            </div>

            <!-- School editor & summary -->
            <div class="p-3 border rounded">
              <h4 class="font-semibold">Schools (Edit)</h4>
              <div id="schools-list" class="mt-2 space-y-2"></div>
              <h4 class="mt-4 font-semibold">Summary</h4>
              <div id="admin-summary" class="text-sm text-gray-600 mt-2"></div>
            </div>
          </div>
        </div>

        <!-- Leaderboards -->
        <div id="leaderboard-view" class="hidden">
          <h3 class="font-semibold">Leaderboards</h3>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="p-3 border rounded">
              <h4 class="font-semibold">Class-wise</h4>
              <select id="leaderboard-class-select" class="p-2 border rounded w-full mt-2"></select>
              <div id="class-leaderboard" class="mt-2"></div>
            </div>

            <div class="p-3 border rounded">
              <h4 class="font-semibold">Subject-wise</h4>
              <select id="leaderboard-class-select-2" class="p-2 border rounded w-full mt-2"></select>
              <select id="leaderboard-subject-select" class="p-2 border rounded w-full mt-2"></select>
              <div id="subject-leaderboard" class="mt-2"></div>
            </div>

            <div class="p-3 border rounded">
              <h4 class="font-semibold">Overall</h4>
              <div id="overall-leaderboard" class="mt-2"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Right column: admin quick actions, notifications publish -->
    <div class="col-span-1 glass p-4">
      <div id="admin-controls" class="hidden">
        <h4 class="font-semibold">Admin Controls</h4>

        <div class="mt-2">
          <label class="text-sm">Publish Notification</label>
          <textarea id="admin-notification-text" class="w-full border p-2 rounded" rows="3"></textarea>
          <button id="publish-notification-btn" class="mt-2 bg-orange-500 text-white px-3 py-2 rounded">Publish</button>
        </div>

        <div class="mt-4">
          <h5 class="font-semibold">Quick Stats</h5>
          <div id="admin-stats" class="text-sm text-gray-700 mt-2"></div>
        </div>
      </div>

      <!-- Teacher summary -->
      <div id="teacher-summary" class="hidden">
        <h4 class="font-semibold">Teacher Summary</h4>
        <div id="teacher-stats" class="text-sm mt-2"></div>
      </div>

      <!-- Student quick info -->
      <div id="student-summary" class="hidden">
        <h4 class="font-semibold">Student</h4>
        <div id="student-info" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>

  <!-- ========================= Firebase + App Script (module) ========================= -->
<script type="module">
/* Firebase + App logic (modular v10+) */
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, updateDoc,
  deleteDoc, serverTimestamp, query, where, onSnapshot, orderBy, limit, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBLLmzxVYuivT15HBPPSxMoS2OzojRgJM",
  authDomain: "wap-ps-pethgam.firebaseapp.com",
  databaseURL: "https://wap-ps-pethgam-default-rtdb.firebaseio.com",
  projectId: "wap-ps-pethgam",
  storageBucket: "wap-ps-pethgam.firebasestorage.app",
  messagingSenderId: "430925411362",
  appId: "1:430925411362:web:22857dee585d02fc54467b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Global state
let allUsers = {}; // cache
let currentUser = null; // {username, role, id, school, class, status}
const appId = 'default-app-id'; // you can override __app_id if available
const USERS_PATH = `artifacts/${appId}/public/data/users`;
const NOTIF_PATH = `artifacts/${appId}/public/data/notifications`;
const MCQ_BASE = `artifacts/${appId}/public/data/mcqs`;
const COINS_PATH = `artifacts/${appId}/public/data/coins`;

// Pre-built school list (80)
const SCHOOLS = Array.from({length:80}, (_,i) => `School ${i+1}`);

// Application constants
const AVAILABLE_CLASSES = ["1st","2nd","3rd","4th","5th","6th","7th","8th"];
const AVAILABLE_SUBJECTS = ["Math","English","EVS","Urdu","Kashmiri","SST"];
const MAX_TEACHERS = 10;
const MAX_STUDENTS = 560;
const MAX_PER_CLASS = 70;
const TEACHER_DAILY_LIMIT = 20;
const Trophies = { BRONZE:2500, SILVER:5000, GOLD:7500 };

// Default admin record (not necessarily in Firestore at start; treated specially)
const DEFAULT_ADMIN_KEY = "admin_pethgam";

// DOM refs (assigned on DOMContentLoaded)
let refs = {};

// Utility helpers
const safeGet = id => document.getElementById(id);
const uid = () => (Math.random().toString(36).slice(2,10)); // local id for generated entries if needed
const lower = s => (s||'').toLowerCase();

// Firestore collection references helper
const colRef = (path) => collection(db, path);

// -------------------- AUTH & BOOT --------------------
async function initApp() {
  // wire DOM refs
  refs = {
    errorEl: safeGet('error-message'),
    loginForm: safeGet('login-form'),
    roleSelect: safeGet('role-select'),
    usernameInput: safeGet('username-input'),
    pinInput: safeGet('pin-input'),
    signupBtn: safeGet('show-signup-btn'),
    signupContainer: safeGet('user-signup-container'),
    signupForm: safeGet('user-signup-form'),
    signupRole: safeGet('user-signup-role'),
    signupUser: safeGet('user-signup-username'),
    signupPin: safeGet('user-signup-pin'),
    signupClassField: safeGet('signup-class-field'),
    signupClass: safeGet('user-signup-class'),
    signupSchool: safeGet('user-signup-school'),
    signupError: safeGet('signup-error-message'),
    logoutBtn: safeGet('logout-btn'),
    welcomeMessage: safeGet('welcome-message'),
    avatar: safeGet('avatar'),
    profileCard: safeGet('profile-card'),
    authCard: safeGet('auth-card'),
    navUserMgmt: safeGet('nav-user-management'),
    navAddMcqs: safeGet('nav-add-mcqs'),
    navAssignments: safeGet('nav-assignments'),
    navLeaderboard: safeGet('nav-leaderboard'),
    navLocation: safeGet('nav-location'),
    mainContent: safeGet('main-content'),
    landingView: safeGet('landing-view'),
    assignmentsView: safeGet('assignments-view'),
    teacherView: safeGet('teacher-view'),
    studentView: safeGet('student-view'),
    adminManagementView: safeGet('admin-management-view'),
    leaderboardView: safeGet('leaderboard-view'),
    teacherSummary: safeGet('teacher-summary'),
    studentSummary: safeGet('student-summary'),
    adminControls: safeGet('admin-controls'),
    notificationMarquee: safeGet('notification-marquee'),
    publishNotifBtn: safeGet('publish-notification-btn'),
    adminNotifText: safeGet('admin-notification-text'),
    adminStats: safeGet('admin-stats'),
    mcqForm: safeGet('assignment-form'),
    classSelect: safeGet('assignment-class-select'),
    subjectSelect: safeGet('assignment-subject-select'),
    saveMcqBtn: safeGet('save-mcq-btn'),
    teacherMcqList: safeGet('teacher-mcq-list'),
    studentClassSelect: safeGet('student-class-select'),
    studentSubjectSelect: safeGet('student-subject-select'),
    startQuizBtn: safeGet('start-quiz-btn'),
    quizArea: safeGet('quiz-area'),
    questionText: safeGet('question-text'),
    questionOptions: safeGet('question-options'),
    quizFeedback: safeGet('quiz-feedback'),
    nextQuestionBtn: safeGet('next-question-btn'),
    studentCoinsEl: safeGet('student-coins'),
    studentTrophyEl: safeGet('student-trophy'),
    pendingList: safeGet('pending-list'),
    schoolsList: safeGet('schools-list'),
    adminSummary: safeGet('admin-summary'),
    leaderboardClassSelect: safeGet('leaderboard-class-select'),
    leaderboardClassSelect2: safeGet('leaderboard-class-select-2'),
    leaderboardSubjectSelect: safeGet('leaderboard-subject-select'),
    classLeaderboard: safeGet('class-leaderboard'),
    subjectLeaderboard: safeGet('subject-leaderboard'),
    overallLeaderboard: safeGet('overall-leaderboard')
  };

  // populate selects
  populateInitialOptions();

  // auth listener (anonymous) + start
  onAuthStateChanged(auth, async (u) => {
    // anonymous auth only used for reading/writing rules
    try {
      if (!auth.currentUser) await signInAnonymously(auth);
    } catch(e){ console.warn("Auth anon failed:", e); }
  });

  // attach UI handlers
  attachUIHandlers();

  // load caches and start live listeners (notifications + users)
  await loadUserCache();
  startNotificationsListener();
  startUsersListener();

  // Show landing
  showView('landing');
}

// Populate class, subject and school selects
function populateInitialOptions(){
  // classes
  const cs = AVAILABLE_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');
  if (refs.classSelect) refs.classSelect.innerHTML = cs;
  if (refs.studentClassSelect) refs.studentClassSelect.innerHTML = cs;
  if (refs.leaderboardClassSelect) refs.leaderboardClassSelect.innerHTML = '<option value="">-- Select Class --</option>' + cs;
  if (refs.leaderboardClassSelect2) refs.leaderboardClassSelect2.innerHTML = '<option value="">-- Select Class --</option>' + cs;
  // subjects
  const ss = AVAILABLE_SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('');
  if (refs.subjectSelect) refs.subjectSelect.innerHTML = ss;
  if (refs.studentSubjectSelect) refs.studentSubjectSelect.innerHTML = ss;
  if (refs.leaderboardSubjectSelect) refs.leaderboardSubjectSelect.innerHTML = '<option value="">-- Select Subject --</option>' + ss;
  // schools
  const sh = SCHOOLS.map(s => `<option value="${s}">${s}</option>`).join('');
  if (refs.signupSchool) refs.signupSchool.innerHTML = sh;
}

// Attach UI event listeners
function attachUIHandlers(){
  // Login
  refs.loginForm && refs.loginForm.addEventListener('submit', handleLogin);
  refs.publishNotifBtn && refs.publishNotifBtn.addEventListener('click', publishNotification);

  // Signup toggles
  const showSignupBtn = safeGet('show-signup-btn'), showLoginBtn = safeGet('show-login-btn');
  showSignupBtn && showSignupBtn.addEventListener('click', (e)=>{ e.preventDefault(); refs.signupContainer.classList.remove('hidden'); });
  showLoginBtn && showLoginBtn.addEventListener('click', (e)=>{ e.preventDefault(); refs.signupContainer.classList.add('hidden'); });

  // Signup form
  refs.signupForm && refs.signupForm.addEventListener('submit', handleUserSignup);
  refs.signupRole && refs.signupRole.addEventListener('change', ()=>{
    if (refs.signupRole.value === 'Student') refs.signupClassField.classList.remove('hidden');
    else refs.signupClassField.classList.add('hidden');
  });

  // Nav
  refs.navAssignments && refs.navAssignments.addEventListener('click', ()=> showView('assignments'));
  refs.navUserMgmt && refs.navUserMgmt.addEventListener('click', ()=> showView('admin-management'));
  refs.navAddMcqs && refs.navAddMcqs.addEventListener('click', ()=> showView('assignments'));
  refs.navLeaderboard && refs.navLeaderboard.addEventListener('click', ()=> showView('leaderboards'));
  refs.logoutBtn && refs.logoutBtn.addEventListener('click', handleLogout);

  // Teacher: save MCQ
  refs.saveMcqBtn && refs.saveMcqBtn.addEventListener('click', saveMCQ);

  // Student: start quiz
  refs.startQuizBtn && refs.startQuizBtn.addEventListener('click', startQuiz);

  // Leaderboard selects
  refs.leaderboardClassSelect && refs.leaderboardClassSelect.addEventListener('change', loadClassLeaderboard);
  refs.leaderboardClassSelect2 && refs.leaderboardClassSelect2.addEventListener('change', loadSubjectLeaderboardOptions);
  refs.leaderboardSubjectSelect && refs.leaderboardSubjectSelect.addEventListener('change', loadSubjectLeaderboard);

  // Pending listener refresh
  // (no extra handlers)
}

// -------------------- USER / FIRESTORE OPERATIONS --------------------

// Load all users into local cache (simple) and expose pending counts
async function loadUserCache(){
  try {
    const q = query(colRef(USERS_PATH), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    allUsers = {};
    snap.forEach(d => {
      const data = d.data();
      if (data && data.username) {
        allUsers[ lower(data.username) ] = {...data, id: d.id};
      }
    });
    updateAdminSummary();
  } catch(err){
    console.error("Load users failed:", err);
  }
}

// Start real-time listener for users for live pending list
function startUsersListener(){
  try {
    const q = query(colRef(USERS_PATH), orderBy('createdAt','desc'));
    onSnapshot(q, snapshot => {
      allUsers = {};
      snapshot.forEach(d => {
        const data = d.data();
        if (data && data.username) allUsers[ lower(data.username) ] = {...data, id: d.id};
      });
      renderPendingApprovals();
      updateAdminSummary();
    });
  } catch(e){ console.warn(e); }
}

// Notifications listener
function startNotificationsListener(){
  try {
    const q = query(colRef(NOTIF_PATH), orderBy('createdAt','desc'), limit(10));
    onSnapshot(q, snap => {
      let text = '';
      snap.forEach(d => {
        const data = d.data();
        if (data && data.message) text += `âš¡ ${data.message} â€” `;
      });
      refs.notificationMarquee && (refs.notificationMarquee.textContent = text || 'Welcome to Winter Assignment Portal!');
    });
  } catch(e){ console.warn(e); }
}

// Publish notification (admin)
async function publishNotification(){
  if (!currentUser || currentUser.role !== 'Admin') { alert('Only admin can publish notifications'); return; }
  const msg = refs.adminNotifText.value.trim();
  if (!msg) { alert('Enter a message'); return; }
  try {
    await addDoc(colRef(NOTIF_PATH), { message: msg, createdBy: currentUser.username, createdAt: serverTimestamp() });
    refs.adminNotifText.value = '';
    alert('Notification published');
  } catch (e) { console.error(e); alert('Publish failed'); }
}

// -------------------- LOGIN / SIGNUP --------------------

async function handleLogin(e){
  e && e.preventDefault();
  const role = refs.roleSelect.value;
  const usernameRaw = refs.usernameInput.value.trim();
  const pin = refs.pinInput.value.trim();
  if (!role || !usernameRaw || !pin) { refs.errorEl.textContent = 'Please fill all login fields.'; return; }
  refs.errorEl.textContent = '';

  // refresh user cache
  await loadUserCache();

  const key = lower(usernameRaw);
  // Special-case default admin
  if (key === DEFAULT_ADMIN_KEY && pin === '0000' && role === 'Admin') {
    // login as default admin without Firestore record
    currentUser = { username: 'Admin_Pethgam', role: 'Admin', id: 'builtin-admin', school: 'PS Pethgam Wagoora', status: 'Approved' };
    onUserLoggedIn();
    return;
  }

  const user = allUsers[key];
  if (!user) { refs.errorEl.textContent = 'Login failed: user not found'; return; }
  if (String(user.pin) !== String(pin)) { refs.errorEl.textContent = 'Login failed: invalid PIN'; return; }
  if (String(user.role) !== role) { refs.errorEl.textContent = 'Login failed: selected role does not match'; return; }
  if (String(user.status) !== 'Approved') { refs.errorEl.textContent = 'Your account is pending approval.'; return; }

  currentUser = {...user, id: user.id};
  onUserLoggedIn();
}

async function handleUserSignup(e){
  e && e.preventDefault();
  const role = refs.signupRole.value;
  const raw = refs.signupUser.value.trim();
  const pin = refs.signupPin.value.trim();
  const school = refs.signupSchool.value;
  const cls = refs.signupClass ? refs.signupClass.value : null;

  if (!role || !raw || !pin || !school || (role === 'Student' && !cls)) {
    refs.signupError.textContent = 'Please fill all required fields'; return;
  }
  refs.signupError.textContent = '';

  // enforce limits
  await loadUserCache();
  const totalTeachers = Object.values(allUsers).filter(u=>u.role==='Teacher').length;
  const totalStudents = Object.values(allUsers).filter(u=>u.role==='Student').length;
  if (role === 'Teacher' && totalTeachers >= MAX_TEACHERS) { refs.signupError.textContent = 'Teacher registration limit reached.'; return; }
  if (role === 'Student' && totalStudents >= MAX_STUDENTS) { refs.signupError.textContent = 'Student registration limit reached.'; return; }
  if (role === 'Student') {
    const classCount = Object.values(allUsers).filter(u=>u.role==='Student' && u.class===cls).length;
    if (classCount >= MAX_PER_CLASS) { refs.signupError.textContent = `Class ${cls} is full.`; return; }
  }

  // duplicate username
  if (allUsers[ lower(raw) ] || lower(raw) === DEFAULT_ADMIN_KEY) { refs.signupError.textContent = 'Username already exists'; return; }

  // create in firestore
  try {
    await addDoc(colRef(USERS_PATH), {
      username: raw,
      role, pin,
      class: role==='Student' ? cls : null,
      school,
      status: 'Pending',
      createdAt: serverTimestamp()
    });
    refs.signupError.textContent = 'Signup submitted. Await admin approval.';
    refs.signupForm.reset();
  } catch(err) {
    console.error("Signup failed", err); refs.signupError.textContent = 'Signup failed';
  }
}

// -------------------- On Login --------------------
function onUserLoggedIn(){
  // show profile card
  safeGet('login-container') && (safeGet('login-container').classList && safeGet('login-container').classList.add('hidden'));
  refs.profileCard.classList.remove('hidden');
  refs.logoutBtn.classList.remove('hidden');
  refs.welcomeMessage.textContent = `${currentUser.username} (${currentUser.role})`;
  refs.avatar.textContent = (currentUser.username||'U').slice(0,1).toUpperCase();
  refs.navAssignments.classList.remove('hidden');
  refs.navLeaderboard.classList.remove('hidden');

  // role-specific UI
  if (currentUser.role === 'Admin') {
    refs.navUserMgmt.classList.remove('hidden');
    refs.navLocation.classList.remove('hidden');
    refs.navAddMcqs.classList.add('hidden');
    refs.adminControls.classList.remove('hidden');
    refs.adminManagementView.classList.remove('hidden');
    showView('admin-management');
    renderAdminControls();
  } else if (currentUser.role === 'Teacher') {
    refs.navAddMcqs.classList.remove('hidden');
    refs.adminControls.classList.add('hidden');
    refs.teacherSummary.classList.remove('hidden');
    showView('assignments');
    refs.teacherView.classList.remove('hidden');
    loadTeacherMcqs();
  } else if (currentUser.role === 'Student') {
    refs.studentSummary.classList.remove('hidden');
    showView('assignments');
    refs.studentView.classList.remove('hidden');
    loadStudentStats();
  }
  // show logout
  refs.openProfileLogout && (refs.openProfileLogout.classList.remove('hidden'));
}

// -------------------- Admin UI / Pending approvals / School list --------------------
function renderPendingApprovals(){
  if (!refs.pendingList) return;
  refs.pendingList.innerHTML = '';
  Object.values(allUsers).filter(u => u.status === 'Pending').forEach(u => {
    const div = document.createElement('div');
    div.className = 'p-2 border-b';
    div.innerHTML = `<div class="flex justify-between items-center">
      <div>
        <div class="font-semibold">${u.username}</div>
        <div class="text-xs text-gray-600">${u.role} â€” ${u.school} ${u.class?('â€” '+u.class):''}</div>
      </div>
      <div class="space-x-2">
        <button class="approve-btn bg-green-600 text-white px-2 py-1 rounded" data-id="${u.id}">Approve</button>
        <button class="reject-btn bg-red-500 text-white px-2 py-1 rounded" data-id="${u.id}">Reject</button>
      </div>
    </div>`;
    refs.pendingList.appendChild(div);
  });
  // attach handlers
  refs.pendingList.querySelectorAll('.approve-btn').forEach(b => b.addEventListener('click', async e => {
    const id = b.getAttribute('data-id');
    await updateDoc(doc(db, USERS_PATH, id), { status: 'Approved' });
    alert('Approved');
  }));
  refs.pendingList.querySelectorAll('.reject-btn').forEach(b => b.addEventListener('click', async e => {
    const id = b.getAttribute('data-id');
    await deleteDoc(doc(db, USERS_PATH, id));
    alert('Rejected and removed');
  }));
}

function renderSchoolsEditor(){
  if (!refs.schoolsList) return;
  refs.schoolsList.innerHTML = '';
  for (let i=0;i<80;i++){
    const key = `School ${i+1}`;
    const div = document.createElement('div');
    div.className = 'flex gap-2 items-center';
    div.innerHTML = `<input data-school-index="${i}" class="border p-1 rounded w-full" value="${SCHOOLS[i] || key}"/>
      <button class="update-school px-2 py-1 bg-blue-600 text-white rounded" data-index="${i}">Save</button>`;
    refs.schoolsList.appendChild(div);
  }
  // update handlers (these are editing the local SCHOOLS array â€” you can persist to Firestore/special path if desired)
  refs.schoolsList.querySelectorAll('.update-school').forEach(btn => btn.addEventListener('click', (ev) => {
    const idx = +btn.getAttribute('data-index');
    const input = refs.schoolsList.querySelector(`input[data-school-index="${idx}"]`);
    if (input) {
      SCHOOLS[idx] = input.value.trim() || `School ${idx+1}`;
      alert('Updated local school name. To persist, implement Firestore school list.');
    }
  }));
}

function updateAdminSummary(){
  if (!refs.adminSummary) return;
  const totalTeachers = Object.values(allUsers).filter(u=>u.role==='Teacher').length;
  const totalStudents = Object.values(allUsers).filter(u=>u.role==='Student').length;
  const pending = Object.values(allUsers).filter(u=>u.status==='Pending').length;
  refs.adminSummary.innerHTML = `<div>Total Teachers: ${totalTeachers}</div><div>Total Students: ${totalStudents}</div><div>Pending: ${pending}</div>`;
  if (refs.adminStats) refs.adminStats.textContent = `Teachers ${totalTeachers} | Students ${totalStudents} | Pending ${pending}`;
}

// Render admin controls
function renderAdminControls(){
  renderPendingApprovals();
  renderSchoolsEditor();
  updateAdminSummary();
}

// -------------------- TEACHER MCQ CRUD --------------------

// Save MCQ (teacher)
async function saveMCQ(e){
  e && e.preventDefault();
  if (!currentUser || (currentUser.role !== 'Teacher' && currentUser.role !== 'Admin')) { alert('Only teachers/admins can save MCQs'); return; }
  const cls = refs.classSelect.value;
  const subj = refs.subjectSelect.value;
  const qText = safeGet('mcq-question').value.trim();
  const options = [safeGet('opt1').value.trim(), safeGet('opt2').value.trim(), safeGet('opt3').value.trim(), safeGet('opt4').value.trim()];
  const correct = safeGet('correct-opt').value;

  if (!cls || !subj || !qText || options.some(o=>!o) || !correct) { refs.mcqStatus.textContent = 'Please fill all fields'; return; }
  // enforce daily limit: query MCQs by this teacher created today
  try {
    // query path: mcqs/{class}/{subject}
    const path = `${MCQ_BASE}/${cls}/${subj}`;
    const col = colRef(path);
    // count today's MCQs by this creator (best-effort)
    const today = new Date(); today.setHours(0,0,0,0);
    // naive filter: load all and count; in production use server-side or indexed query with createdBy
    const snap = await getDocs(query(col));
    const myTodayCount = snap.docs.filter(d => {
      const data = d.data();
      const created = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : (data.createdAt? new Date(data.createdAt.seconds*1000): null);
      return data.createdBy === currentUser.username && created && created >= today;
    }).length;
    if (myTodayCount >= TEACHER_DAILY_LIMIT) { refs.mcqStatus.textContent = 'Daily question limit reached'; return; }

    // Build MCQ doc
    await addDoc(col, {
      question: qText,
      options,
      correct: Number(correct),
      class: cls,
      subject: subj,
      createdBy: currentUser.username,
      createdAt: serverTimestamp()
    });
    refs.mcqStatus.textContent = 'Saved!';
    // clear inputs
    safeGet('mcq-question').value=''; safeGet('opt1').value=''; safeGet('opt2').value=''; safeGet('opt3').value=''; safeGet('opt4').value=''; safeGet('correct-opt').value='';
    loadTeacherMcqs();
  } catch(err) { console.error(err); refs.mcqStatus.textContent='Save failed'; }
}

// Load teacher's MCQs and show list (simplified)
async function loadTeacherMcqs(){
  if (!refs.teacherMcqList) return;
  refs.teacherMcqList.innerHTML = '<div class="text-sm text-gray-600">Loading...</div>';
  try {
    // search all mcqs created by this teacher (naive scan across classes/subjects)
    const results = [];
    for (const cls of AVAILABLE_CLASSES){
      for (const subj of AVAILABLE_SUBJECTS){
        const col = colRef(`${MCQ_BASE}/${cls}/${subj}`);
        const snap = await getDocs(query(col, orderBy('createdAt','desc'), limit(50)));
        snap.forEach(d => {
          const data = d.data(); if (data.createdBy === currentUser.username) results.push({id: d.id, path: `${MCQ_BASE}/${cls}/${subj}`, data});
        });
      }
    }
    // render
    if (!results.length) { refs.teacherMcqList.innerHTML = '<div class="text-sm text-gray-600">No MCQs added yet.</div>'; return; }
    refs.teacherMcqList.innerHTML = results.map(r => `<div class="p-2 border-b">
      <div class="font-semibold">${r.data.question}</div>
      <div class="text-xs text-gray-600">${r.data.class} â€¢ ${r.data.subject}</div>
    </div>`).join('');
  } catch(err){ console.error(err); refs.teacherMcqList.innerHTML = 'Failed to load MCQs'; }
}

// -------------------- STUDENT QUIZ PLAYER --------------------

let quizState = { idx:0, questions:[], current:null };

async function startQuiz(){
  const cls = refs.studentClassSelect.value;
  const subj = refs.studentSubjectSelect.value;
  if (!cls || !subj) { alert('Choose class and subject'); return; }
  // fetch mcqs for that class+subject (random sample)
  try {
    const col = colRef(`${MCQ_BASE}/${cls}/${subj}`);
    const snap = await getDocs(query(col));
    const docs = snap.docs.map(d => ({id:d.id, ...d.data()}));
    if (!docs.length) { alert('No MCQs for selected class/subject'); return; }
    // shuffle
    for (let i = docs.length -1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1)); [docs[i],docs[j]]=[docs[j],docs[i]];
    }
    // prepare
    quizState.questions = docs;
    quizState.idx = 0;
    quizState.current = docs[0];
    renderQuestion();
    refs.quizArea.classList.remove('hidden');
    refs.nextQuestionBtn.classList.add('hidden');
  } catch(err){ console.error(err); alert('Failed to start quiz'); }
}

function renderQuestion(){
  const q = quizState.current;
  if (!q) return;
  refs.questionText.textContent = q.question;
  refs.questionOptions.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'block w-full text-left p-2 border rounded';
    btn.textContent = opt;
    btn.addEventListener('click', () => handleAnswer(i+1, q));
    refs.questionOptions.appendChild(btn);
  });
  refs.quizFeedback.textContent = '';
}

async function handleAnswer(selected, qdoc){
  const correct = Number(qdoc.correct);
  if (selected === correct) {
    refs.quizFeedback.textContent = 'Wow! You are doing wonders!';
    // award +5 coins
    await awardCoinsForUser(currentUser.username, 5);
  } else {
    refs.quizFeedback.textContent = 'No problem, try next time!';
  }
  // show next button
  refs.nextQuestionBtn.classList.remove('hidden');
  refs.nextQuestionBtn.onclick = () => {
    quizState.idx++;
    if (quizState.idx >= quizState.questions.length) {
      alert('Quiz completed');
      refs.quizArea.classList.add('hidden');
    } else {
      quizState.current = quizState.questions[quizState.idx];
      renderQuestion();
    }
  };
}

// Award coins & update trophy status
async function awardCoinsForUser(username, amount){
  if (!username) return;
  try {
    // coins doc per username (lowercase)
    const key = lower(username);
    const docRef = doc(db, COINS_PATH, key);
    const cur = await getDoc(docRef);
    if (!cur.exists()){
      await setDoc(docRef, { username, coins: amount, updatedAt: serverTimestamp() });
    } else {
      await updateDoc(docRef, { coins: increment(amount), updatedAt: serverTimestamp() });
    }
    // update UI
    await loadStudentStats();
    await loadLeaderboards();
  } catch(err){ console.error('awardCoins failed', err); }
}

// Load student coins & trophy
async function loadStudentStats(){
  if (!currentUser) return;
  try {
    const key = lower(currentUser.username);
    const cdoc = await getDoc(doc(db, COINS_PATH, key));
    const coins = cdoc.exists() ? (cdoc.data().coins || 0) : 0;
    refs.studentCoinsEl && (refs.studentCoinsEl.textContent = coins);
    let trophy = 'â€”';
    if (coins >= Trophies.GOLD) trophy = 'ðŸ† Gold';
    else if (coins >= Trophies.SILVER) trophy = 'ðŸ¥ˆ Silver';
    else if (coins >= Trophies.BRONZE) trophy = 'ðŸ¥‰ Bronze';
    refs.studentTrophyEl && (refs.studentTrophyEl.textContent = trophy);
  } catch(e){ console.error(e); }
}

// -------------------- LEADERBOARDS --------------------

async function loadClassLeaderboard(){
  const cls = refs.leaderboardClassSelect.value;
  if (!cls) { refs.classLeaderboard.innerHTML = '<div class="text-sm text-gray-600">Select class</div>'; return; }
  try {
    // query coins for students in this class: we need to join users and coins client-side
    const users = Object.values(allUsers).filter(u => u.role==='Student' && u.class===cls && u.status==='Approved');
    // load coins for each
    const rows = [];
    for (const u of users){
      const cdoc = await getDoc(doc(db, COINS_PATH, lower(u.username)));
      const coins = cdoc.exists() ? (cdoc.data().coins || 0) : 0;
      rows.push({ username: u.username, class: u.class, school: u.school, coins });
    }
    // sort by coins desc
    rows.sort((a,b)=>b.coins - a.coins);
    refs.classLeaderboard.innerHTML = rows.map((r,i)=>`<div class="p-2 border-b flex justify-between">
      <div><strong>#${i+1} ${r.username}</strong><div class="text-xs text-gray-600">${r.class} â€¢ ${r.school}</div></div>
      <div class="text-lg font-semibold">${r.coins}</div>
    </div>`).join('') || '<div class="text-sm text-gray-600">No data</div>';
  } catch(e){ console.error(e); refs.classLeaderboard.textContent = 'Failed'; }
}

// subject-wise: first select class
function loadSubjectLeaderboardOptions(){
  const cls = refs.leaderboardClassSelect2.value;
  if (!cls) { refs.subjectLeaderboard.innerHTML = '<div class="text-sm text-gray-600">Select class</div>'; return; }
  refs.leaderboardSubjectSelect.value = '';
  refs.subjectLeaderboard.innerHTML = '<div class="text-sm text-gray-600">Select subject</div>';
}

// load subject leaderboard
async function loadSubjectLeaderboard(){
  const cls = refs.leaderboardClassSelect2.value;
  const subj = refs.leaderboardSubjectSelect.value;
  if (!cls || !subj) { refs.subjectLeaderboard.innerHTML = '<div class="text-sm text-gray-600">Select class & subject</div>'; return; }
  try {
    // We will measure performance by number of correct answers per student in MCQs for that subject;
    // For simplicity, rank by coins among students of that class who attempted that subject (approx).
    const users = Object.values(allUsers).filter(u => u.role==='Student' && u.class===cls && u.status==='Approved');
    const rows = [];
    for (const u of users){
      const cdoc = await getDoc(doc(db, COINS_PATH, lower(u.username)));
      const coins = cdoc.exists() ? (cdoc.data().coins || 0) : 0;
      rows.push({ username: u.username, class: u.class, school: u.school, coins });
    }
    rows.sort((a,b)=>b.coins - a.coins);
    refs.subjectLeaderboard.innerHTML = rows.map((r,i)=>`<div class="p-2 border-b flex justify-between">
      <div><strong>#${i+1} ${r.username}</strong><div class="text-xs text-gray-600">${r.class} â€¢ ${r.school}</div></div>
      <div class="text-lg font-semibold">${r.coins}</div>
    </div>`).join('') || '<div class="text-sm text-gray-600">No data</div>';
  } catch(e){ console.error(e); refs.subjectLeaderboard.textContent = 'Failed'; }
}

// overall leaderboard
async function loadOverallLeaderboard(){
  try {
    const students = Object.values(allUsers).filter(u=>u.role==='Student' && u.status==='Approved');
    const rows = [];
    for (const s of students){
      const cdoc = await getDoc(doc(db, COINS_PATH, lower(s.username)));
      const coins = cdoc.exists() ? (cdoc.data().coins || 0) : 0;
      rows.push({ username: s.username, class: s.class, school: s.school, coins });
    }
    rows.sort((a,b)=>b.coins - a.coins);
    refs.overallLeaderboard.innerHTML = rows.map((r,i)=>`<div class="p-2 border-b flex justify-between">
      <div><strong>#${i+1} ${r.username}</strong><div class="text-xs text-gray-600">${r.class} â€¢ ${r.school}</div></div>
      <div class="text-lg font-semibold">${r.coins}</div>
    </div>`).join('') || '<div class="text-sm text-gray-600">No data</div>';
  } catch(e){ console.error(e); refs.overallLeaderboard.textContent='Failed'; }
}

// wrapper to refresh leaderboards
async function loadLeaderboards(){
  await loadClassLeaderboard();
  await loadSubjectLeaderboard();
  await loadOverallLeaderboard();
}

// -------------------- small helpers --------------------

function showView(name){
  // name: landing, assignments, admin-management, leaderboards
  const views = {
    landing: refs.landingView,
    assignments: refs.assignmentsView,
    'admin-management': refs.adminManagementView,
    leaderboards: refs.leaderboardView,
    leaderboards_alt: refs.leaderboardView
  };
  // hide all
  [refs.landingView, refs.assignmentsView, refs.adminManagementView, refs.leaderboardView].forEach(v=>v && v.classList.add('hidden'));
  // show target
  if (views[name]) views[name].classList.remove('hidden');
  // extra: reveal internal role views
  if (name === 'assignments') {
    // teacher/student subviews toggled elsewhere
    refs.assignmentsView.classList.remove('hidden');
  }
}

// Logout
function handleLogout(){
  currentUser = null;
  refs.profileCard.classList.add('hidden');
  refs.logoutBtn.classList.add('hidden');
  safeGet('login-container') && (safeGet('login-container').classList.remove('hidden'));
  refs.navUserMgmt.classList.add('hidden');
  refs.navAddMcqs.classList.add('hidden');
  refs.adminControls.classList.add('hidden');
  refs.teacherSummary.classList.add('hidden');
  refs.studentSummary.classList.add('hidden');
  // clear forms
  refs.usernameInput.value = '';
  refs.pinInput.value = '';
}

// -------------------- listeners to refresh leaderboards when coins change  --------------------
function startCoinsListener(){
  try {
    const q = query(colRef(COINS_PATH), orderBy('updatedAt','desc'));
    onSnapshot(q, snap => {
      loadLeaderboards();
      if (currentUser && currentUser.role === 'Student') loadStudentStats();
    });
  } catch(e){ console.warn(e); }
}

// start up
initApp().then(()=> {
  // attach some live listeners
  startCoinsListener();
  loadLeaderboards();
}).catch(e => console.error(e));

</script>

</body>
</html>
                                
