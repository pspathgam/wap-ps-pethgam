<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pethgam Wagoora Winter Assignment Portal</title>

    <!-- Load Tailwind CSS (moved before custom styles) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #d1d5db;
        }

        /* Glassmorphism portal card */
        .portal-card {
            background-image: linear-gradient(135deg, rgba(253, 224, 71, 0.2), rgba(96, 165, 250, 0.2));
            border: 1px solid rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Snow animation container */
        .snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }

        .snowflake {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0); opacity: 0.8; }
            100% { transform: translateY(100vh) translateX(20px); opacity: 0.2; }
        }

        /* Hover effect for portal buttons */
        .portal-btn {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .portal-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        /* Leaderboard colors */
        .rank-1 { background-color: #FFD700; color: #1f2937; }
        .rank-2 { background-color: #C0C0C0; color: #1f2937; }
        .rank-3 { background-color: #CD7F32; color: #1f2937; }
        .rank-default { background-color: #374151; color: #f3f4f6; }

        /* Scrolling ticker */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #fcd34d;
            color: #1f2937;
        }
        .ticker {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 15s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <!-- â„ Snow Animation Layer -->
    <div class="snow-container" id="snow-container"></div>

    <!-- ðŸ”” Notification Ticker -->
    <div class="ticker-wrap w-full py-2 z-20">
        <div class="ticker" id="notification-ticker">
            Winter Vacation Assignment Released Today &nbsp;&nbsp; | &nbsp;&nbsp;
            New Online Quiz Available &nbsp;&nbsp; | &nbsp;&nbsp;
            Check the Leaderboard for Ranks!
        </div>
    </div>

    <!-- ðŸ« Portal Header -->
    <header class="p-6 text-center z-20">
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold mb-2 text-yellow-300">
            Winter Assignment Portal
        </h1>
        <h2 class="text-xl sm:text-2xl font-light text-blue-300">
            Government Primary School Pethgam Wagoora
        </h2>
    </header>

    <!-- ðŸ§Š Portal Card -->
    <main class="flex-grow flex items-start justify-center p-4 md:p-8 z-20">
        <div id="app-container" class="w-full max-w-4xl portal-card p-4 sm:p-8">
            <div id="content-view">
                <div class="flex flex-col items-center justify-center p-8 text-center">
                    <svg class="animate-spin h-8 w-8 text-blue-400 mb-4"
                         viewBox="0 0 24 24" fill="none">
                        <path d="M12 4.75V6.25M17.127 6.873l-1.061 1.061M19.25 12h-1.5M17.127 17.127l-1.061-1.061M12 17.75v1.5M7.934 16.066l-1.061 1.061M6.25 12h-1.5M7.934 7.934l-1.061-1.061"
                        stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>

                    <p class="text-lg font-semibold text-blue-300">
                        Initializing Portal and Connecting to Database...
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- ðŸ‘£ Footer -->
    <footer class="text-center text-xs p-4 border-t border-gray-700/50 mt-8 z-20">
        <p class="text-gray-400 mb-1">Designed & Developed by Mohammad Ashraf Rather</p>
        <p class="text-gray-500">Government Primary School Pethgam Wagoora | Winter Assignment Portal 2025</p>
        <p class="text-gray-600 mt-2">
            User ID: <span id="footer-user-id">N/A</span> |
            App ID: <span id="footer-app-id">N/A</span>
        </p>
    </footer>

    <!-- â„ Auto Snowflake Generator Placeholder -->
    <script>
        const snowContainer = document.getElementById('snow-container');

        // You can activate this when ready
        for (let i = 0; i < 40; i++) {
            let snow = document.createElement('div');
            snow.className = 'snowflake';
            snow.style.left = Math.random() * 100 + '%';
            snow.style.animationDuration = (5 + Math.random() * 10) + 's';
            snow.style.opacity = Math.random();
            snowContainer.appendChild(snow);
        }
    </script>











                                     
}

// -------------------- LOGIN / SIGNUP --------------------

async function handleLogin(e){
  e && e.preventDefault();
  const role = refs.roleSelect.value;
  const usernameRaw = refs.usernameInput.value.trim();
  const pin = refs.pinInput.value.trim();
  if (!role || !usernameRaw || !pin) { refs.errorEl.textContent = 'Please fill all login fields.'; return; }
  refs.errorEl.textContent = '';

  // refresh user cache
  await loadUserCache();

  const key = lower(usernameRaw);
  // Special-case default admin
  if (key === DEFAULT_ADMIN_KEY && pin === '0000' && role === 'Admin') {
    // login as default admin without Firestore record
    currentUser = { username: 'Admin_Pethgam', role: 'Admin', id: 'builtin-admin', school: 'PS Pethgam Wagoora', status: 'Approved' };
    onUserLoggedIn();
    return;
  }

  const user = allUsers[key];
  if (!user) { refs.errorEl.textContent = 'Login failed: user not found'; return; }
  if (String(user.pin) !== String(pin)) { refs.errorEl.textContent = 'Login failed: invalid PIN'; return; }
  if (String(user.role) !== role) { refs.errorEl.textContent = 'Login failed: selected role does not match'; return; }
  if (String(user.status) !== 'Approved') { refs.errorEl.textContent = 'Your account is pending approval.'; return; }

  currentUser = {...user, id: user.id};
  onUserLoggedIn();
}

async function handleUserSignup(e){
  e && e.preventDefault();
  const role = refs.signupRole.value;
  const raw = refs.signupUser.value.trim();
  const pin = refs.signupPin.value.trim();
  const school = refs.signupSchool.value;
  const cls = refs.signupClass ? refs.signupClass.value : null;

  if (!role || !raw || !pin || !school || (role === 'Student' && !cls)) {
    refs.signupError.textContent = 'Please fill all required fields'; return;
  }
  refs.signupError.textContent = '';

  // enforce limits
  await loadUserCache();
  const totalTeachers = Object.values(allUsers).filter(u=>u.role==='Teacher').length;
  const totalStudents = Object.values(allUsers).filter(u=>u.role==='Student').length;
  if (role === 'Teacher' && totalTeachers >= MAX_TEACHERS) { refs.signupError.textContent = 'Teacher registration limit reached.'; return; }
  if (role === 'Student' && totalStudents >= MAX_STUDENTS) { refs.signupError.textContent = 'Student registration limit reached.'; return; }
  if (role === 'Student') {
    const classCount = Object.values(allUsers).filter(u=>u.role==='Student' && u.class===cls).length;
    if (classCount >= MAX_PER_CLASS) { refs.signupError.textContent = `Class ${cls} is full.`; return; }
  }

  // duplicate username
  if (allUsers[ lower(raw) ] || lower(raw) === DEFAULT_ADMIN_KEY) { refs.signupError.textContent = 'Username already exists'; return; }

  // create in firestore
  try {
    await addDoc(colRef(USERS_PATH), {
      username: raw,
      role, pin,
      class: role==='Student' ? cls : null,
      school,
      status: 'Pending',
      createdAt: serverTimestamp()
    });
    refs.signupError.textContent = 'Signup submitted. Await admin approval.';
    refs.signupForm.reset();
  } catch(err) {
    console.error("Signup failed", err); refs.signupError.textContent = 'Signup failed';
  }
}

// -------------------- LOGIN (REPLACEMENT, more robust) --------------------
async function handleLogin(e){
  try {
    e && e.preventDefault();

    // defensive refs check
    if (!refs || !refs.roleSelect || !refs.usernameInput || !refs.pinInput) {
      console.error("Login: required DOM refs missing", refs);
      alert("Login UI not initialized properly. Please refresh the page.");
      return;
    }

    const role = (refs.roleSelect.value || '').trim();
    const usernameRaw = (refs.usernameInput.value || '').trim();
    const pin = (refs.pinInput.value || '').trim();

    // UX: clear previous error
    if (refs.errorEl) refs.errorEl.textContent = '';

    if (!role || !usernameRaw || !pin) {
      if (refs.errorEl) refs.errorEl.textContent = 'Please fill all login fields.';
      else alert('Please fill all login fields.');
      return;
    }

    console.log("Attempting login:", { role, usernameRaw });

    // refresh user cache (best-effort)
    await loadUserCache();

    const key = lower(usernameRaw);

    // Special-case default admin (builtin)
    if (key === DEFAULT_ADMIN_KEY && pin === '0000' && role === 'Admin') {
      currentUser = { username: 'Admin_Pethgam', role: 'Admin', id: 'builtin-admin', school: 'PS Pethgam Wagoora', status: 'Approved' };
      console.log("Logged in as builtin admin");
      onUserLoggedIn();
      return;
    }

    // Lookup user in cache
    const user = allUsers[key];
    if (!user) {
      console.warn("Login failed: user not found in cache for key:", key, "allUsers keys:", Object.keys(allUsers).slice(0,20));
      if (refs.errorEl) refs.errorEl.textContent = 'Login failed: user not found';
      else alert('Login failed: user not found');
      return;
    }

    // PIN validation (string compare)
    if (String(user.pin) !== String(pin)) {
      console.warn("Login failed: invalid PIN for user:", key);
      if (refs.errorEl) refs.errorEl.textContent = 'Login failed: invalid PIN';
      else alert('Login failed: invalid PIN');
      return;
    }

    // Role validation
    if (String(user.role).trim() !== role) {
      console.warn("Login failed: role mismatch. Stored:", user.role, "Selected:", role);
      if (refs.errorEl) refs.errorEl.textContent = 'Login failed: selected role does not match';
      else alert('Login failed: selected role does not match');
      return;
    }

    // Status check
    if (String(user.status) !== 'Approved') {
      console.warn("Login failed: account status is", user.status);
      if (refs.errorEl) refs.errorEl.textContent = 'Your account is pending approval.';
      else alert('Your account is pending approval.');
      return;
    }

    // success: set currentUser and proceed
    currentUser = { ...user, id: user.id };
    console.log("Login successful for", currentUser);
    onUserLoggedIn();

  } catch (err) {
    console.error("handleLogin error:", err);
    if (refs && refs.errorEl) refs.errorEl.textContent = 'Login error: ' + (err.message || err);
    else alert('Login error: ' + (err.message || err));
  }
}

// Ensure the login form handler is attached (safe attach)
(function ensureLoginHandlerAttached(){
  try {
    // If refs not yet initialized, wait for DOMContentLoaded and re-run
    if (!refs || !refs.loginForm) {
      document.addEventListener('DOMContentLoaded', () => {
        const lf = document.getElementById('login-form');
        if (lf && !lf._loginHandlerAttached) {
          lf.addEventListener('submit', handleLogin);
          lf._loginHandlerAttached = true;
          console.log("Login submit handler attached (late)");
        }
      });
      return;
    }
    // Attach now if not already
    if (refs.loginForm && !refs.loginForm._loginHandlerAttached) {
      refs.loginForm.addEventListener('submit', handleLogin);
      refs.loginForm._loginHandlerAttached = true;
      console.log("Login submit handler attached");
    }
  } catch (e) {
    console.warn("Failed to attach login handler:", e);
  }
})();


// -------------------- On Login (REPLACEMENT: use existing auth-card id) --------------------
function onUserLoggedIn(){
  try {
    // Hide the auth card (your HTML has id="auth-card")
    const authCard = document.getElementById('auth-card');
    if (authCard && authCard.classList) authCard.classList.add('hidden');

    // Show profile, nav and role views
    if (refs.profileCard) refs.profileCard.classList.remove('hidden');
    if (refs.logoutBtn) refs.logoutBtn.classList.remove('hidden');
    if (refs.welcomeMessage) refs.welcomeMessage.textContent = `${currentUser.username} (${currentUser.role})`;
    if (refs.avatar) refs.avatar.textContent = (currentUser.username||'U').slice(0,1).toUpperCase();
    if (refs.navAssignments) refs.navAssignments.classList.remove('hidden');
    if (refs.navLeaderboard) refs.navLeaderboard.classList.remove('hidden');

    // Role-specific UI
    if (currentUser.role === 'Admin') {
      if (refs.navUserMgmt) refs.navUserMgmt.classList.remove('hidden');
      if (refs.navLocation) refs.navLocation.classList.remove('hidden');
      if (refs.navAddMcqs) refs.navAddMcqs.classList.add('hidden');
      if (refs.adminControls) refs.adminControls.classList.remove('hidden');
      if (refs.adminManagementView) refs.adminManagementView.classList.remove('hidden');
      showView('admin-management');
      renderAdminControls();
    } else if (currentUser.role === 'Teacher') {
      if (refs.navAddMcqs) refs.navAddMcqs.classList.remove('hidden');
      if (refs.adminControls) refs.adminControls.classList.add('hidden');
      if (refs.teacherSummary) refs.teacherSummary.classList.remove('hidden');
      showView('assignments');
      if (refs.teacherView) refs.teacherView.classList.remove('hidden');
      loadTeacherMcqs();
    } else if (currentUser.role === 'Student') {
      if (refs.studentSummary) refs.studentSummary.classList.remove('hidden');
      showView('assignments');
      if (refs.studentView) refs.studentView.classList.remove('hidden');
      loadStudentStats();
    }

    // show logout UI if present
    if (refs.openProfileLogout) refs.openProfileLogout.classList.remove('hidden');

    console.log("onUserLoggedIn completed for", currentUser.username);
  } catch (err) {
    console.error("onUserLoggedIn error:", err);
  }
}
// -------------------- Admin UI / Pending approvals / School list --------------------
function renderPendingApprovals(){
  if (!refs.pendingList) return;
  refs.pendingList.innerHTML = '';
  Object.values(allUsers).filter(u => u.status === 'Pending').forEach(u => {
    const div = document.createElement('div');
    div.className = 'p-2 border-b';
    div.innerHTML = `<div class="flex justify-between items-center">
      <div>
        <div class="font-semibold">${u.username}</div>
        <div class="text-xs text-gray-600">${u.role} â€” ${u.school} ${u.class?('â€” '+u.class):''}</div>
      </div>
      <div class="space-x-2">
        <button class="approve-btn bg-green-600 text-white px-2 py-1 rounded" data-id="${u.id}">Approve</button>
        <button class="reject-btn bg-red-500 text-white px-2 py-1 rounded" data-id="${u.id}">Reject</button>
      </div>
    </div>`;
    refs.pendingList.appendChild(div);
  });
  // attach handlers
  refs.pendingList.querySelectorAll('.approve-btn').forEach(b => b.addEventListener('click', async e => {
    const id = b.getAttribute('data-id');
    await updateDoc(doc(db, USERS_PATH, id), { status: 'Approved' });
    alert('Approved');
  }));
  refs.pendingList.querySelectorAll('.reject-btn').forEach(b => b.addEventListener('click', async e => {
    const id = b.getAttribute('data-id');
    await deleteDoc(doc(db, USERS_PATH, id));
    alert('Rejected and removed');
  }));
}

function renderSchoolsEditor(){
  if (!refs.schoolsList) return;
  refs.schoolsList.innerHTML = '';
  for (let i=0;i<80;i++){
    const key = `School ${i+1}`;
    const div = document.createElement('div');
    div.className = 'flex gap-2 items-center';
    div.innerHTML = `<input data-school-index="${i}" class="border p-1 rounded w-full" value="${SCHOOLS[i] || key}"/>
      <button class="update-school px-2 py-1 bg-blue-600 text-white rounded" data-index="${i}">Save</button>`;
    refs.schoolsList.appendChild(div);
  }
  // update handlers (these are editing the local SCHOOLS array â€” you can persist to Firestore/special path if desired)
  refs.schoolsList.querySelectorAll('.update-school').forEach(btn => btn.addEventListener('click', (ev) => {
    const idx = +btn.getAttribute('data-index');
    const input = refs.schoolsList.querySelector(`input[data-school-index="${idx}"]`);
    if (input) {
      SCHOOLS[idx] = input.value.trim() || `School ${idx+1}`;
      alert('Updated local school name. To persist, implement Firestore school list.');
    }
  }));
}

function updateAdminSummary(){
  if (!refs.adminSummary) return;
  const totalTeachers = Object.values(allUsers).filter(u=>u.role==='Teacher').length;
  const totalStudents = Object.values(allUsers).filter(u=>u.role==='Student').length;
  const pending = Object.values(allUsers).filter(u=>u.status==='Pending').length;
  refs.adminSummary.innerHTML = `<div>Total Teachers: ${totalTeachers}</div><div>Total Students: ${totalStudents}</div><div>Pending: ${pending}</div>`;
  if (refs.adminStats) refs.adminStats.textContent = `Teachers ${totalTeachers} | Students ${totalStudents} | Pending ${pending}`;
}

// Render admin controls
function renderAdminControls(){
  renderPendingApprovals();
  renderSchoolsEditor();
  updateAdminSummary();
}

// -------------------- TEACHER MCQ CRUD --------------------

// Save MCQ (teacher)
async function saveMCQ(e){
  e && e.preventDefault();
  if (!currentUser || (currentUser.role !== 'Teacher' && currentUser.role !== 'Admin')) { alert('Only teachers/admins can save MCQs'); return; }
  const cls = refs.classSelect.value;
  const subj = refs.subjectSelect.value;
  const qText = safeGet('mcq-question').value.trim();
  const options = [safeGet('opt1').value.trim(), safeGet('opt2').value.trim(), safeGet('opt3').value.trim(), safeGet('opt4').value.trim()];
  const correct = safeGet('correct-opt').value;

  if (!cls || !subj || !qText || options.some(o=>!o) || !correct) { refs.mcqStatus.textContent = 'Please fill all fields'; return; }
  // enforce daily limit: query MCQs by this teacher created today
  try {
    // query path: mcqs/{class}/{subject}
    const path = `${MCQ_BASE}/${cls}/${subj}`;
    const col = colRef(path);
    // count today's MCQs by this creator (best-effort)
    const today = new Date(); today.setHours(0,0,0,0);
    // naive filter: load all and count; in production use server-side or indexed query with createdBy
    const snap = await getDocs(query(col));
    const myTodayCount = snap.docs.filter(d => {
      const data = d.data();
      const created = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : (data.createdAt? new Date(data.createdAt.seconds*1000): null);
      return data.createdBy === currentUser.username && created && created >= today;
    }).length;
    if (myTodayCount >= TEACHER_DAILY_LIMIT) { refs.mcqStatus.textContent = 'Daily question limit reached'; return; }

    // Build MCQ doc
    await addDoc(col, {
      question: qText,
      options,
      correct: Number(correct),
      class: cls,
      subject: subj,
      createdBy: currentUser.username,
      createdAt: serverTimestamp()
    });
    refs.mcqStatus.textContent = 'Saved!';
    // clear inputs
    safeGet('mcq-question').value=''; safeGet('opt1').value=''; safeGet('opt2').value=''; safeGet('opt3').value=''; safeGet('opt4').value=''; safeGet('correct-opt').value='';
    loadTeacherMcqs();
  } catch(err) { console.error(err); refs.mcqStatus.textContent='Save failed'; }
}

// Load teacher's MCQs and show list (simplified)
async function loadTeacherMcqs(){
  if (!refs.teacherMcqList) return;
  refs.teacherMcqList.innerHTML = '<div class="text-sm text-gray-600">Loading...</div>';
  try {
    // search all mcqs created by this teacher (naive scan across classes/subjects)
    const results = [];
    for (const cls of AVAILABLE_CLASSES){
      for (const subj of AVAILABLE_SUBJECTS){
        const col = colRef(`${MCQ_BASE}/${cls}/${subj}`);
        const snap = await getDocs(query(col, orderBy('createdAt','desc'), limit(50)));
        snap.forEach(d => {
          const data = d.data(); if (data.createdBy === currentUser.username) results.push({id: d.id, path: `${MCQ_BASE}/${cls}/${subj}`, data});
        });
      }
    }
    // render
    if (!results.length) { refs.teacherMcqList.innerHTML = '<div class="text-sm text-gray-600">No MCQs added yet.</div>'; return; }
    refs.teacherMcqList.innerHTML = results.map(r => `<div class="p-2 border-b">
      <div class="font-semibold">${r.data.question}</div>
      <div class="text-xs text-gray-600">${r.data.class} â€¢ ${r.data.subject}</div>
    </div>`).join('');
  } catch(err){ console.error(err); refs.teacherMcqList.innerHTML = 'Failed to load MCQs'; }
}

// -------------------- STUDENT QUIZ PLAYER --------------------

let quizState = { idx:0, questions:[], current:null };

async function startQuiz(){
  const cls = refs.studentClassSelect.value;
  const subj = refs.studentSubjectSelect.value;
  if (!cls || !subj) { alert('Choose class and subject'); return; }
  // fetch mcqs for that class+subject (random sample)
  try {
    const col = colRef(`${MCQ_BASE}/${cls}/${subj}`);
    const snap = await getDocs(query(col));
    const docs = snap.docs.map(d => ({id:d.id, ...d.data()}));
    if (!docs.length) { alert('No MCQs for selected class/subject'); return; }
    // shuffle
    for (let i = docs.length -1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1)); [docs[i],docs[j]]=[docs[j],docs[i]];
    }
    // prepare
    quizState.questions = docs;
    quizState.idx = 0;
    quizState.current = docs[0];
    renderQuestion();
    refs.quizArea.classList.remove('hidden');
    refs.nextQuestionBtn.classList.add('hidden');
  } catch(err){ console.error(err); alert('Failed to start quiz'); }
}

function renderQuestion(){
  const q = quizState.current;
  if (!q) return;
  refs.questionText.textContent = q.question;
  refs.questionOptions.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'block w-full text-left p-2 border rounded';
    btn.textContent = opt;
    btn.addEventListener('click', () => handleAnswer(i+1, q));
    refs.questionOptions.appendChild(btn);
  });
  refs.quizFeedback.textContent = '';
}

async function handleAnswer(selected, qdoc){
  const correct = Number(qdoc.correct);
  if (selected === correct) {
    refs.quizFeedback.textContent = 'Wow! You are doing wonders!';
    // award +5 coins
    await awardCoinsForUser(currentUser.username, 5);
  } else {
    refs.quizFeedback.textContent = 'No problem, try next time!';
  }
  // show next button
  refs.nextQuestionBtn.classList.remove('hidden');
  refs.nextQuestionBtn.onclick = () => {
    quizState.idx++;
    if (quizState.idx >= quizState.questions.length) {
      alert('Quiz completed');
      refs.quizArea.classList.add('hidden');
    } else {
      quizState.current = quizState.questions[quizState.idx];
      renderQuestion();
    }
  };
}

// Award coins & update trophy status
async function awardCoinsForUser(username, amount){
  if (!username) return;
  try {
    // coins doc per username (lowercase)
    const key = lower(username);
    const docRef = doc(db, COINS_PATH, key);
    const cur = await getDoc(docRef);
    if (!cur.exists()){
      await setDoc(docRef, { username, coins: amount, updatedAt: serverTimestamp() });
    } else {
      await updateDoc(docRef, { coins: increment(amount), updatedAt: serverTimestamp() });
    }
    // update UI
    await loadStudentStats();
    await loadLeaderboards();
  } catch(err){ console.error('awardCoins failed', err); }
}

// Load student coins & trophy
async function loadStudentStats(){
  if (!currentUser) return;
  try {
    const key = lower(currentUser.username);
    const cdoc = await getDoc(doc(db, COINS_PATH, key));
    const coins = cdoc.exists() ? (cdoc.data().coins || 0) : 0;
    refs.studentCoinsEl && (refs.studentCoinsEl.textContent = coins);
    let trophy = 'â€”';
    if (coins >= Trophies.GOLD) trophy = 'ðŸ† Gold';
    else if (coins >= Trophies.SILVER) trophy = 'ðŸ¥ˆ Silver';
    else if (coins >= Trophies.BRONZE) trophy = 'ðŸ¥‰ Bronze';
    refs.studentTrophyEl && (refs.studentTrophyEl.textContent = trophy);
  } catch(e){ console.error(e); }
}

// -------------------- LEADERBOARDS --------------------
// ==============================
// LEADERBOARDS MODULE
// ==============================

// Fetch coin records for all students
async function fetchAllCoinRecords() {
  const snap = await getDocs(colRef(COINS_PATH));
  let results = [];
  snap.forEach(docSnap => {
    let d = docSnap.data();
    d.id = docSnap.id;
    results.push(d);
  });
  return results;
}

// Render Class-wise Leaderboard
async function renderClassLeaderboard() {
  const selectedClass = safeGet("leaderboard-class-select").value;
  const box = safeGet("class-leaderboard");
  box.innerHTML = "Loading...";

  const data = await fetchAllCoinRecords();
  const filtered = data
    .filter(u => u.class === selectedClass)
    .sort((a,b) => (b.totalCoins || 0) - (a.totalCoins || 0));

  box.innerHTML = filtered.length === 0 
    ? "<p>No records found</p>"
    : filtered.map((x,i)=>`
      <div class="border p-2 rounded mb-1">
        <strong>${i+1}. ${x.username}</strong><br>
        Coins: ${x.totalCoins || 0}
      </div>
    `).join("");
}

// Render Subject-wise Leaderboard
async function renderSubjectLeaderboard() {
  const selectedClass = safeGet("leaderboard-class-select-2").value;
  const selectedSubject = safeGet("leaderboard-subject-select").value;
  const box = safeGet("subject-leaderboard");
  box.innerHTML = "Loading...";

  const data = await fetchAllCoinRecords();
  const filtered = data
    .filter(u => u.class === selectedClass)
    .sort((a,b) => 
      ((b.subjectCoins?.[selectedSubject] || 0) - 
       (a.subjectCoins?.[selectedSubject] || 0))
    );

  box.innerHTML = filtered.length === 0 
    ? "<p>No records found</p>"
    : filtered.map((x,i)=>`
      <div class="border p-2 rounded mb-1">
        <strong>${i+1}. ${x.username}</strong><br>
        ${selectedSubject}: ${(x.subjectCoins?.[selectedSubject] || 0)}
      </div>
    `).join("");
}

// Render Overall Leaderboard
async function renderOverallLeaderboard() {
  const box = safeGet("overall-leaderboard");
  box.innerHTML = "Loading...";

  const data = await fetchAllCoinRecords();
  const sorted = data.sort((a,b)=> (b.totalCoins || 0) - (a.totalCoins || 0));

  box.innerHTML = sorted.length === 0
    ? "<p>No records found</p>"
    : sorted.map((x,i)=>`
      <div class="border p-2 rounded mb-1">
        <strong>${i+1}. ${x.username}</strong><br>
        Total: ${x.totalCoins || 0}
      </div>
    `).join("");
}

// ==============================
// Event Listeners for Leaderboards
// ==============================

safeGet("leaderboard-class-select").addEventListener("change", renderClassLeaderboard);
safeGet("leaderboard-class-select-2").addEventListener("change", renderSubjectLeaderboard);
safeGet("leaderboard-subject-select").addEventListener("change", renderSubjectLeaderboard);

// Auto load overall leaderboard
function loadAllLeaderboards() {
  renderOverallLeaderboard();
  if (safeGet("leaderboard-class-select").value)
    renderClassLeaderboard();
  if (safeGet("leaderboard-class-select-2").value &&
      safeGet("leaderboard-subject-select").value)
    renderSubjectLeaderboard();
}

// Call when leaderboard page is opened
safeGet("nav-leaderboard").addEventListener("click", () => {
  setTimeout(loadAllLeaderboards, 300);
});
// -------------------- small helpers --------------------

function showView(name){
  // name: landing, assignments, admin-management, leaderboards
  const views = {
    landing: refs.landingView,
    assignments: refs.assignmentsView,
    'admin-management': refs.adminManagementView,
    leaderboards: refs.leaderboardView,
    leaderboards_alt: refs.leaderboardView
  };
  // hide all
  [refs.landingView, refs.assignmentsView, refs.adminManagementView, refs.leaderboardView].forEach(v=>v && v.classList.add('hidden'));
  // show target
  if (views[name]) views[name].classList.remove('hidden');
  // extra: reveal internal role views
  if (name === 'assignments') {
    // teacher/student subviews toggled elsewhere
    refs.assignmentsView.classList.remove('hidden');
  }
}

// Logout
function handleLogout(){
  currentUser = null;
  refs.profileCard.classList.add('hidden');
  refs.logoutBtn.classList.add('hidden');
  safeGet('login-container') && (safeGet('login-container').classList.remove('hidden'));
  refs.navUserMgmt.classList.add('hidden');
  refs.navAddMcqs.classList.add('hidden');
  refs.adminControls.classList.add('hidden');
  refs.teacherSummary.classList.add('hidden');
  refs.studentSummary.classList.add('hidden');
  // clear forms
  refs.usernameInput.value = '';
  refs.pinInput.value = '';
}

// -------------------- listeners to refresh leaderboards when coins change  --------------------
function startCoinsListener(){
  try {
    const q = query(colRef(COINS_PATH), orderBy('updatedAt','desc'));
    onSnapshot(q, snap => {
      loadLeaderboards();
      if (currentUser && currentUser.role === 'Student') loadStudentStats();
    });
  } catch(e){ console.warn(e); }
}

// start up
initApp().then(()=> {
  // attach some live listeners
  startCoinsListener();
  loadLeaderboards();
}).catch(e => console.error(e));

</script>

</body>
</html>
                                
