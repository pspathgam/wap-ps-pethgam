<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Login – WAP PS Pethgam</title>
<script type="module">

// -------------------------------
// Firebase Imports
// -------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
    getAuth, 
    RecaptchaVerifier, 
    signInWithPhoneNumber 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
    getFirestore, 
    doc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


// -------------------------------
// Firebase Config
// -------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyCBLLmzxVYuivT15HBPPSxMoS2OzojRgJM",
  authDomain: "wap-ps-pethgam.firebaseapp.com",
  databaseURL: "https://wap-ps-pethgam-default-rtdb.firebaseio.com",
  projectId: "wap-ps-pethgam",
  storageBucket: "wap-ps-pethgam.firebasestorage.app",
  messagingSenderId: "430925411362",
  appId: "1:430925411362:web:22857dee585d02fc54467b"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


let confirmationResultGlobal;


// -------------------------------
// Initialize reCAPTCHA
// -------------------------------
window.recaptchaVerifier = new RecaptchaVerifier(
  auth,
  "recaptcha-container",
  {
    size: "invisible",
    callback: (response) => {
      console.log("reCAPTCHA solved:", response);
    }
  }
);


// -------------------------------
// Send OTP
// -------------------------------
window.sendOTP = async function () {

  const phoneInput = document.getElementById("phone").value.trim();

  // Check correct phone format
  if (!phoneInput.startsWith("+") || phoneInput.length < 10) {
    alert("❌ Please enter valid phone number in +91XXXXXXXXXX format");
    return;
  }

  try {
    console.log("Sending OTP to:", phoneInput);

    const appVerifier = window.recaptchaVerifier;

    confirmationResultGlobal = await signInWithPhoneNumber(auth, phoneInput, appVerifier);

    alert("✅ OTP has been sent!");
    document.getElementById("otp-box").style.display = "block";

  } catch (error) {
    console.error("OTP ERROR:", error);

    if (error.code === "auth/too-many-requests") {
      alert("❌ Too many attempts. Use Firebase Test Number for development.");
    } else {
      alert("❌ OTP Failed: " + error.message);
    }
  }
};


// -------------------------------
// Verify OTP
// -------------------------------
window.verifyOTP = async function () {

  const code = document.getElementById("otp").value.trim();

  if (code.length !== 6) {
    alert("❌ Invalid OTP");
    return;
  }

  try {
    const result = await confirmationResultGlobal.confirm(code);
    const user = result.user;

    alert("✅ Login Successful!");

    // Optional: Redirect after login
    window.location.href = "dashboard.html";

  } catch (error) {
    console.error("VERIFY ERROR:", error);
    alert("❌ Incorrect OTP");
  }
};

</script>

</head>
<body>

<h2>Admin Login</h2>

<label>Registered Phone Number</label>
<input type="text" id="phone" placeholder="+91xxxxxxxxxx">

<button onclick="sendOTP()">Send OTP</button>

<div id="recaptcha-container"></div>

<div id="otp-box" style="display:none; margin-top:10px;">
    <label>Enter OTP</label>
    <input type="text" id="otp" maxlength="6">
    <button onclick="verifyOTP()">Verify OTP</button>
</div>

</body>
</html>
